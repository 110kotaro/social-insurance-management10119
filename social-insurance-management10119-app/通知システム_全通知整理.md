# 通知システム - 全通知の判定・対象・条件整理

## 通知タイプ一覧

通知システムでは以下の8種類の通知タイプが定義されています：

1. **`application`** - 申請関連通知
2. **`approval`** - 承認通知
3. **`rejection`** - 却下通知
4. **`return`** - 差戻し通知
5. **`reminder`** - リマインダー通知
6. **`system`** - システム通知
7. **`external_received`** - 外部申請受理通知（未使用）
8. **`external_error`** - 外部申請エラー通知（未使用）

---

## 1. 申請ステータス変更通知

### 1.1 申請提出時（`pending`）

**通知タイプ**: `application`

**送信条件**:
- `notificationSettings.notifyApplicant === true` かつ `notifyOnSubmit === true` の場合、申請者へ通知
- `notificationSettings.notifyAdmin === true` かつ `notifyOnSubmit === true` の場合、管理者へ通知

**対象者**:
- **申請者**: 申請を提出した社員（`employeeId`から`userId`を取得）
- **管理者**: 組織の全管理者（`owner`または`admin`ロール、申請者本人は除外）

**通知内容**:
- **申請者向け**: 
  - タイトル: `申請を提出しました` / `申請を再送信しました`（再申請の場合）
  - メッセージ: `{申請種別名}の申請を{提出/再送信}しました。承認をお待ちください。`
  - 優先度: `medium`
- **管理者向け**:
  - タイトル: `新規申請が来ました` / `申請が再送信されました`（再申請の場合）
  - メッセージ: `{社員名}さんから{申請種別名}の申請が{提出/再送信}されました。`
  - 優先度: `high`

**送信タイミング**: 申請ステータスが`pending`に変更された時（`application-detail.component.ts`の`createNotificationForStatusChange`メソッド）

---

### 1.2 申請承認時（`approved`）

**通知タイプ**: `approval`

**送信条件**:
- `notificationSettings.notifyApplicant === true` かつ `notifyOnApprove === true` の場合、申請者へ通知

**対象者**:
- **申請者のみ**: 申請を提出した社員

**通知内容**:
- タイトル: `申請が承認されました`
- メッセージ: `{申請種別名}の申請が承認されました。`
- 優先度: `high`

**送信タイミング**: 申請ステータスが`approved`に変更された時

---

### 1.3 申請却下時（`rejected`）

**通知タイプ**: `rejection`

**送信条件**:
- `notificationSettings.notifyApplicant === true` かつ `notifyOnReject === true` の場合、申請者へ通知

**対象者**:
- **申請者のみ**: 申請を提出した社員

**通知内容**:
- タイトル: `申請が却下されました`
- メッセージ: `{申請種別名}の申請が却下されました。{理由: {コメント}}`（コメントがある場合）
- 優先度: `high`

**送信タイミング**: 申請ステータスが`rejected`に変更された時

---

### 1.4 申請差戻し時（`returned`）

**通知タイプ**: `return`

**送信条件**:
- `notificationSettings.notifyApplicant === true` かつ `notifyOnReturn === true` の場合、申請者へ通知

**対象者**:
- **申請者のみ**: 申請を提出した社員

**通知内容**:
- タイトル: `申請が差し戻されました`
- メッセージ: `{申請種別名}の申請が差し戻されました。{理由: {コメント}}`（コメントがある場合）
- 優先度: `high`

**送信タイミング**: 申請ステータスが`returned`に変更された時

---

## 2. 外部申請ステータス変更通知

### 2.1 外部申請受理時（`received`）

**通知タイプ**: `application`

**送信条件**:
- `notificationSettings.notifyAdmin === true` の場合、管理者へ通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `外部申請が受理されました`
- メッセージ: `{社員名}さんの{申請種別名}が外部機関で受理されました。`
- 優先度: `high`

**送信タイミング**: 外部申請ステータスが`received`に変更された時（`application-detail.component.ts`）

---

### 2.2 外部申請エラー時（`error`）

**通知タイプ**: `system`

**送信条件**:
- `notificationSettings.notifyAdmin === true` の場合、管理者へ通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `外部申請でエラーが発生しました`
- メッセージ: `{社員名}さんの{申請種別名}で送信エラーまたは受理不可が発生しました。対応が必要です。`
- 優先度: `high`

**送信タイミング**: 外部申請ステータスが`error`に変更された時

---

## 3. 期限リマインダー通知

**通知タイプ**: `reminder`

### 3.1 事前通知（X日前）

**送信条件**:
- `reminderSettings.notifyBeforeDeadline === true`
- 法定期限までの日数が`reminderSettings.adminDaysBeforeLegalDeadline`（デフォルト7日）と一致する場合

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `申請期限のお知らせ`
- メッセージ: `{申請種別名}の申請の期限まであと{日数}日です（期限：{期限日}）。 ※期限日が土日祝の場合は、翌営業日が期限となる可能性があります。`
- 優先度: `medium`（期限まで1日以下の場合は`high`）

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象申請**:
- ステータスが`pending`、`pending_received`、`pending_not_received`の申請
- 外部申請が既に送信済み（`externalApplicationStatus === 'sent'`）の場合は除外
- 報酬月額変更届、住所変更届、氏名変更届は除外（別途通知あり）

**重複チェック**: 同一申請・同一ユーザーに対して既に通知が送信されている場合は送信しない（期限超過通知以外）

---

### 3.2 当日通知（期限当日）

**送信条件**:
- `reminderSettings.notifyOnDeadlineDay === true`
- 現在時刻が10時以降
- 期限までの日数が0日（当日）

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `申請期限当日のお知らせ`
- メッセージ: `{申請種別名}の申請の期限は本日（{期限日}）です。`
- 優先度: `high`

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象申請**: 事前通知と同様

---

### 3.3 期限超過通知（毎日）

**送信条件**:
- `reminderSettings.notifyOnOverdue === true`
- 期限までの日数が0日未満（超過）

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `申請期限超過のお知らせ`
- メッセージ: `{申請種別名}の申請が期限（{期限日}）を超過しています。`
- 優先度: `high`

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象申請**: 事前通知と同様

**重複チェック**: 今日既に通知が送信されている場合は送信しない（1日1回）

**特別処理**: 内部申請が絡む外部申請で法定期限超過時は、社員の申請日＋1営業日を期限として扱う

---

### 3.4 申請がない場合の期限超過通知

**送信条件**:
- `reminderSettings.notifyOnOverdue === true`
- 社員一覧から直接取得した各社員について、各外部申請種別の期限をチェック
- 該当社員の外部申請が既に送信済みの場合は除外
- 期限が超過している場合

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `申請期限超過のお知らせ`
- メッセージ: `{申請種別名}の申請が期限（{期限日}）を超過しています。`
- 優先度: `high`
- `applicationId`: `null`（申請が存在しないため）
- `employeeId`: 対象社員のID

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド内の`checkOverdueNotificationsWithoutApplication`実行時

**対象申請種別**: 外部申請種別のみ（報酬月額変更届、住所変更届、氏名変更届は除外）

**重複チェック**: 今日既に通知が送信されている場合は送信しない（1日1回、社員IDと申請種別で判定）

---

### 3.5 期限設定時の即時通知

**送信条件**:
- 内部申請作成時、または社員情報更新時に外部申請の期限が設定された場合
- 事前通知のリマインダー日を過ぎている場合に即時通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- 期限超過の場合: `申請期限超過のお知らせ`
- 当日の場合: `申請期限当日のお知らせ`
- 事前通知の場合: `申請期限のお知らせ`

**送信タイミング**:
- 内部申請作成時（`application.service.ts`の`setDeadlineAndSendReminderForInternalApplication`）
- 社員情報更新時（`employee.service.ts`の`sendReminderForEmployeeUpdate`）

**対象申請種別**: 被扶養者異動届など、内部申請から外部申請の期限が計算される申請

---

## 4. 報酬月額変更届の通知

**通知タイプ**: `reminder`

**送信条件**:
- 月変計算が確定済み（`status === 'applied'`）で、報酬月額変更届（外部申請）が作成されていない社員がいる場合
- 1日1回通知（重複チェックあり）

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `報酬月額変更届の申請が必要です`
- メッセージ: `月変計算が確定済みで、報酬月額変更届の申請が必要な社員がいます（{社員名リスト、最大5名}、他{残り人数}名）。申請を作成してください。`
- 優先度: `high`
- `applicationId`: `null`
- `employeeId`: `null`（複数社員の場合はnull）

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド内の`checkAndSendRewardChangeNotifications`実行時

**重複チェック**: 今日既に通知が送信されている場合は送信しない（1日1回）

**除外条件**: 報酬月額変更届は期限計算を行わない（別途通知）

---

## 5. 住所変更届・氏名変更届の通知

**通知タイプ**: `reminder`

**送信条件**:
- 住所変更届または氏名変更届の内部申請が作成され、ステータスが`pending`または`approved`の場合
- 該当社員の住所変更届・氏名変更届（外部申請）が作成されていない場合
- 1日1回通知（重複チェックあり）

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容（住所変更届）**:
- タイトル: `住所変更届の申請が必要です`
- メッセージ: `{社員名}さんの住所変更届（外部申請）の申請が必要です。`
- 優先度: `high`
- `applicationId`: `null`
- `employeeId`: 対象社員のID

**通知内容（氏名変更届）**:
- タイトル: `氏名変更届の申請が必要です`
- メッセージ: `{社員名}さんの氏名変更届（外部申請）の申請が必要です。`
- 優先度: `high`
- `applicationId`: `null`
- `employeeId`: 対象社員のID

**送信タイミング**: `checkAndSendDeadlineReminders`メソッド内の`checkAndSendAddressAndNameChangeNotifications`実行時

**重複チェック**: 今日既に通知が送信されている場合は送信しない（1日1回、社員IDで判定）

**除外条件**: 住所変更届・氏名変更届は期限計算を行わない（別途通知）

---

## 6. 算定計算のリマインダー通知

**通知タイプ**: `reminder`

**送信条件**:
- 現在日が7月1日の場合
- 未計算の社員がいる場合のみ通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `算定計算の実行時期です`
- メッセージ: `{年}年7月1日になりました。算定計算を実行してください。7月10日までに計算して算定届を提出してください。`
- 優先度: `high`
- `applicationId`: `null`

**送信タイミング**: `checkAndSendStandardRewardReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象社員の条件**:
- 入社日が6月1日以前（5月31日以前）
- 退職日の翌日が含まれる月が7月以降（7月が退職日の翌日が含まれる月以降なら除外）
- 6月給与が確定済み（`isConfirmed === true`）
- 算定計算が未実行

**重複チェック**: 同じ日付で既に通知が送信されている場合は送信しない（1日1回）

---

## 7. 月変計算のリマインダー通知

**通知タイプ**: `reminder`

**送信条件**:
- 変動月から4か月目に入った場合
- 未計算の社員がいる場合のみ通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `月変計算の実行時期です`
- メッセージ: `{変動年}年{変動月}月の固定賃金変動で月変計算未計算の社員がいます（{社員名リスト、最大5名}、他{残り人数}名）。月変計算を実行してください。`
- 優先度: `high`
- `applicationId`: `null`

**送信タイミング**: `checkAndSendMonthlyChangeReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象社員の条件**:
- 固定賃金変動が検出された社員
- 変動月から4か月目に入った時点で、該当変動月の月変計算が未実行

**重複チェック**: 同じ年月で既に通知が送信されている場合は送信しない（1か月1回）

---

## 8. 月次計算のリマインダー通知

**通知タイプ**: `reminder`

**送信条件**:
- 現在日が組織設定の月次計算予定日（`organization.payrollDate`）と一致する場合
- 未計算の社員がいる場合のみ通知

**対象者**:
- **管理者のみ**: 組織の全管理者

**通知内容**:
- タイトル: `月次計算の実行時期です`
- メッセージ: `{対象年}年{対象月}月の月次計算を実行してください。未計算の社員がいます（{社員名リスト、最大5名}、他{残り人数}名）。`
- 優先度: `high`
- `applicationId`: `null`

**送信タイミング**: `checkAndSendMonthlyCalculationReminders`メソッド実行時（管理者ダッシュボード読み込み時、手動実行時）

**対象年月の決定**:
- 組織設定の`monthlyCalculationTargetMonth`が`next`（翌月モード）の場合: 1ヶ月前の計算を促す
- `current`または未設定の場合: 当月の計算を促す

**対象社員の条件**:
- 計算対象社員（`calculationService.getCalculationTargetEmployees`で取得）
- 該当月の計算結果が未確定（`status !== 'confirmed' && status !== 'exported'`）

**重複チェック**: 同じ年月で既に通知が送信されている場合は送信しない（1か月1回、ユーザーごと）

**特別処理**: 月末処理を考慮（設定日が月末を超える場合は月末日を使用）

---

## 通知設定項目

組織設定（`ApplicationFlowSettings.notificationSettings`）で制御可能な項目：

- **`notifyApplicant`**: 申請者への通知（デフォルト: `true`）
- **`notifyAdmin`**: 管理者への通知（デフォルト: `true`）
- **`notifyOnSubmit`**: 申請提出時の通知（デフォルト: `true`）
- **`notifyOnApprove`**: 承認時の通知（デフォルト: `true`）
- **`notifyOnReturn`**: 差戻し時の通知（デフォルト: `true`）
- **`notifyOnReject`**: 却下時の通知（デフォルト: `true`）
- **`reminderSettings.notifyBeforeDeadline`**: 事前通知（デフォルト: `true`）
- **`reminderSettings.notifyOnDeadlineDay`**: 当日通知（デフォルト: `true`）
- **`reminderSettings.notifyOnOverdue`**: 期限超過通知（デフォルト: `true`）
- **`reminderSettings.adminDaysBeforeLegalDeadline`**: 管理者向け事前通知の日数（デフォルト: `7`日）

---

## 通知の実行タイミング

### 自動実行
- **管理者ダッシュボード読み込み時**: `admin-dashboard.component.ts`の`ngOnInit`で`checkReminders`メソッドを実行
  - `checkAndSendStandardRewardReminders`（算定計算）
  - `checkAndSendMonthlyChangeReminders`（月変計算）
  - `checkAndSendDeadlineReminders`（期限リマインダー）
  - `checkAndSendMonthlyCalculationReminders`（月次計算）

### 手動実行
- **管理者ダッシュボード**: 「リマインダーを手動でチェック」ボタンから実行可能（`skipDuplicateCheck: true`で実行）

### 即時実行
- **申請ステータス変更時**: `application-detail.component.ts`で即座に通知送信
- **外部申請ステータス変更時**: `application-detail.component.ts`で即座に通知送信
- **内部申請作成時**: `application.service.ts`で期限設定と即時通知
- **社員情報更新時**: `employee.service.ts`で期限設定と即時通知

---

## 重複チェックの仕組み

### 申請ステータス変更通知
- 重複チェックなし（ステータス変更のたびに通知）

### リマインダー通知
- **事前通知・当日通知**: 同一申請・同一ユーザーに対して既に通知が送信されている場合は送信しない
- **期限超過通知**: 今日既に通知が送信されている場合は送信しない（1日1回）
- **算定計算・月変計算・月次計算**: 同じ日付/年月で既に通知が送信されている場合は送信しない

### 手動実行時
- `skipDuplicateCheck: true`を指定することで重複チェックをスキップ可能

---

## 通知の優先度

- **`high`**: 
  - 申請提出時（管理者向け）
  - 承認・却下・差戻し時
  - 外部申請受理・エラー時
  - 期限当日・期限超過時
  - 算定計算・月変計算・月次計算のリマインダー
  - 報酬月額変更届・住所変更届・氏名変更届の通知
- **`medium`**: 
  - 申請提出時（申請者向け）
  - 事前通知（期限まで1日超の場合）
- **`low`**: 未使用

---

## 通知の関連データ

各通知には以下の情報が含まれます：

- **`userId`**: 通知を受信するユーザーID（必須）
- **`applicationId`**: 関連する申請ID（申請に関連しない通知の場合は`null`）
- **`employeeId`**: 関連する社員ID（申請がない場合でも社員を特定するため）
- **`organizationId`**: 組織ID（必須）
- **`type`**: 通知タイプ（必須）
- **`title`**: 通知タイトル（必須）
- **`message`**: 通知メッセージ（必須）
- **`priority`**: 優先度（デフォルト: `medium`）
- **`read`**: 既読フラグ（デフォルト: `false`）
- **`createdAt`**: 作成日時（自動設定）
- **`readAt`**: 既読日時（既読時に設定）

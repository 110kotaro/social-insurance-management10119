# 社会保険管理システム 実装計画

## 📋 目次
1. [Firebaseプロジェクト設定](#firebaseプロジェクト設定)
2. [プロジェクト構造](#プロジェクト構造)
3. [フェーズ別実装計画](#フェーズ別実装計画)
4. [データモデル設計](#データモデル設計)
5. [技術スタック](#技術スタック)
6. [確認事項](#確認事項)

---

## 🔥 Firebaseプロジェクト設定

### プロジェクト情報
- **プロジェクトID**: `kensyu10119`
- **既存アプリのコレクション**: 
  - `commentReadStatus`
  - `notifications` (⚠️ 新アプリでも使用するため、名前を変更する必要あり)
  - `projects`
  - `tasks`
  - `teamInvitations`
  - `teams`
  - `users` (⚠️ 新アプリでも使用するため、名前を変更する必要あり)

### 既存Firebaseプロジェクトに2つ目のアプリを追加する方法

#### 方法1: Firebase Consoleから追加（推奨）
1. Firebase Console (https://console.firebase.google.com/) にアクセス
2. プロジェクト `kensyu10119` を選択
3. プロジェクト設定（⚙️アイコン）を開く
4. 「アプリを追加」セクションで「Webアプリ」を選択
5. アプリのニックネームを入力: `social-insurance-management-app`
6. Firebase Hostingの設定は後で行う場合はスキップ
7. 設定コードが表示されるので、これをAngularプロジェクトに追加

#### 方法2: Firebase CLIを使用
```bash
# Firebase CLIがインストールされている場合
firebase use kensyu10119  # 既存プロジェクトを選択
firebase apps:create WEB social-insurance-management-app
```

### データ分離の方法（確定）

#### Firestoreコレクション分離
**既存アプリのコレクション**（変更なし）:
- `commentReadStatus`
- `notifications` (既存アプリ用)
- `projects`
- `tasks`
- `teamInvitations`
- `teams`
- `users` (既存アプリ用)

**新アプリのコレクション**（完全に分離）:
- `socialInsurance_organizations` - 組織（企業）
- `socialInsurance_users` - ユーザー（認証情報）
- `socialInsurance_employees` - 社員情報
- `socialInsurance_departments` - 部署
- `socialInsurance_applications` - 申請
- `socialInsurance_calculations` - 月次計算結果
- `socialInsurance_insuranceRates` - 保険料率マスタ
- `socialInsurance_notifications` - 通知（既存アプリの`notifications`と分離）
- `socialInsurance_documents` - 作成済み書類
- `socialInsurance_standardRewards` - 標準報酬等級表
- `socialInsurance_settings` - 組織設定

**命名規則**: すべて `socialInsurance_` プレフィックスを付けて既存アプリと明確に分離

#### Cloud Storageフォルダ分離

**既存アプリのStorage構造**（推測）:
```
existing_app/
  (既存アプリのファイル)
```

**新アプリのStorage構造**:
```
social-insurance/
  organizations/
    {orgId}/
      documents/
        {applicationId}/
          {fileName}
      logos/
        logo.{ext}
  templates/
    csv/
    excel/
    pdf/
```

**セキュリティルールでの分離**:
- パスが `social-insurance/` で始まるもののみ新アプリがアクセス可能
- 既存アプリは `existing_app/` 配下のみアクセス可能

### 認証システムの分離

**既存アプリ**: 既存の認証システムを使用（変更なし）

**新アプリ**: 独立した認証システム
- Firebase Authenticationの同じプロジェクト内で別の認証フローを使用
- ユーザーUIDは同じFirebaseプロジェクト内で一意（既存アプリと重複しない）
- 認証状態は完全に独立して管理
- メール認証の送信元アドレスは後で設定（Firebase Console > Authentication > Templates で設定）

---

## 📁 プロジェクト構造

```
src/
├── app/
│   ├── core/                          # コア機能（認証、ガード、インターセプター）
│   │   ├── auth/
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.guard.ts
│   │   │   └── role.guard.ts
│   │   ├── guards/
│   │   ├── interceptors/
│   │   └── models/
│   │       ├── user.model.ts
│   │       ├── organization.model.ts
│   │       └── employee.model.ts
│   │
│   ├── features/                      # 機能別モジュール
│   │   ├── setup/                     # 初回セットアップ
│   │   │   ├── setup-wizard/
│   │   │   ├── organization-create/
│   │   │   └── setup-guide/
│   │   │
│   │   ├── auth/                      # 認証関連
│   │   │   ├── login/
│   │   │   ├── register/
│   │   │   ├── email-verification/
│   │   │   └── password-setup/
│   │   │
│   │   ├── dashboard/                 # ダッシュボード
│   │   │   ├── admin-dashboard/
│   │   │   └── employee-dashboard/
│   │   │
│   │   ├── employees/                 # 社員管理
│   │   │   ├── employee-list/
│   │   │   ├── employee-detail/
│   │   │   ├── employee-create/
│   │   │   └── employee-import/
│   │   │
│   │   ├── departments/               # 部署管理
│   │   │   ├── department-list/
│   │   │   └── department-detail/
│   │   │
│   │   ├── applications/              # 申請管理
│   │   │   ├── application-list/
│   │   │   ├── application-detail/
│   │   │   ├── application-create/
│   │   │   └── application-types/
│   │   │       ├── dependent-application/
│   │   │       ├── address-change/
│   │   │       ├── leave-application/
│   │   │       └── external-applications/
│   │   │
│   │   ├── calculations/              # 月次計算
│   │   │   ├── monthly-calculation/
│   │   │   ├── calculation-detail/
│   │   │   └── calculation-history/
│   │   │
│   │   ├── documents/                 # 書類作成
│   │   │   ├── document-generator/
│   │   │   └── document-templates/
│   │   │
│   │   ├── notifications/             # 通知
│   │   │   ├── notification-list/
│   │   │   └── notification-detail/
│   │   │
│   │   ├── settings/                  # 設定
│   │   │   ├── organization-settings/
│   │   │   ├── insurance-rates/
│   │   │   ├── application-flow/
│   │   │   ├── permissions/
│   │   │   └── notification-settings/
│   │   │
│   │   ├── analytics/                 # 分析
│   │   │   ├── department-analytics/
│   │   │   └── application-analytics/
│   │   │
│   │   ├── external-integration/      # 外部連携
│   │   │   ├── import/
│   │   │   └── export/
│   │   │
│   │   └── profile/                    # 自分の情報
│   │       ├── my-info/
│   │       └── account-settings/
│   │
│   ├── shared/                        # 共有コンポーネント・サービス
│   │   ├── components/
│   │   │   ├── header/
│   │   │   ├── sidebar/
│   │   │   ├── notification-bell/
│   │   │   ├── file-upload/
│   │   │   └── status-badge/
│   │   ├── services/
│   │   │   ├── firestore.service.ts
│   │   │   ├── storage.service.ts
│   │   │   └── notification.service.ts
│   │   └── pipes/
│   │       └── date-format.pipe.ts
│   │
│   ├── app.component.ts
│   ├── app.config.ts
│   └── app.routes.ts
│
├── environments/
│   ├── environment.ts
│   └── environment.prod.ts
│
└── assets/
    ├── templates/                     # CSV/Excelテンプレート
    └── documents/                     # PDFテンプレート
```

---

## 🚀 フェーズ別実装計画

### フェーズ1: 基盤構築（1-2週間）

#### 1.1 Firebase設定
- [ ] Firebase SDKインストール
  ```bash
  npm install @angular/fire firebase
  ```
- [ ] Firebase設定ファイル作成（`environment.ts`）
  - プロジェクトID: `kensyu10119`
  - 新アプリの設定情報を追加
- [ ] Firebase初期化（`app.config.ts`）
  - Firestore、Authentication、Storage、Functions設定
  - コレクション名のプレフィックス設定（`socialInsurance_`）
  - Storageパスのプレフィックス設定（`social-insurance/`）
- [ ] Firestoreインデックス設計（パフォーマンス最適化のため）
  - `socialInsurance_applications`: `organizationId + status + createdAt`
  - `socialInsurance_employees`: `organizationId + departmentId + status`
  - `socialInsurance_calculations`: `organizationId + year + month`
  - `socialInsurance_notifications`: `userId + read + createdAt`

#### 1.2 認証基盤
- [ ] Authentication設定（メール/パスワード）
  - Firebase Console > Authentication > Sign-in method でメール/パスワードを有効化
  - メール認証テンプレートの設定（送信元アドレスの設定が必要）
- [ ] 認証サービス実装
  - 既存アプリとは独立した認証フロー
  - 初回アカウント作成（メール認証）
  - 社員招待（パスワード設定）
  - ログイン（社員番号 or メールアドレス + パスワード）
- [ ] 認証ガード実装
  - `AuthGuard`: 認証済みチェック
  - `RoleGuard`: 権限チェック（owner/admin/employee）
  - `SetupGuard`: 初回セットアップ未完了チェック
- [ ] ログイン画面
  - 社員番号 or メールアドレス + パスワード
  - 新規登録リンク（初回アカウント用のみ）
- [ ] 新規登録画面（初回アカウント用）
  - 会社名、メールアドレス、パスワード設定
  - 利用規約・プライバシーポリシー同意チェック

#### 1.3 ルーティング設定
- [ ] ルート定義
- [ ] ガード適用
- [ ] リダイレクト設定

#### 1.4 基本レイアウト
- [ ] Angular Materialインストール・設定
  ```bash
  ng add @angular/material
  ```
- [ ] ヘッダーコンポーネント
  - サービス名表示
  - 通知アイコン（未読件数バッジ）
  - ユーザーメニュー（管理者のみモード切替表示）
  - ドロップダウン: 「自分の情報」「アカウント設定」「ログアウト」
- [ ] サイドバーコンポーネント
  - 管理者モード: ダッシュボード、社員管理、部署管理、申請管理、外部申請書類作成、月次計算、分析、設定
  - 社員モード: ダッシュボード、自分の申請、自分の情報
  - モード切替ボタン（管理者のみ）
- [ ] レイアウトコンポーネント
  - PC向け固定幅レイアウト（レスポンシブ不要）
  - ヘッダー + サイドバー + メインコンテンツエリア

---

### フェーズ2: 初回セットアップ機能（2-3週間）

#### 2.1 メール認証フロー
- [ ] メール認証送信機能
- [ ] 認証リンククリック後の処理
- [ ] 認証状態の管理

#### 2.2 初回セットアップウィザード
- [ ] ステップ1: 組織情報入力
- [ ] ステップ2: 部署作成
- [ ] ステップ3: 保険設定（健康保険、厚生年金、介護保険、雇用保険）
- [ ] ステップ4: 料率インポート（CSV/Excel）
- [ ] ステップ5: 申請フロー設定
- [ ] ステップ6: ドキュメント設定
- [ ] ステップ7: 最終確認

#### 2.3 セットアップガイド
- [ ] ToDoリスト表示
- [ ] 完了チェック機能
- [ ] ガイド表示/非表示制御

---

### フェーズ3: 社員管理機能（2-3週間）

#### 3.1 社員登録
- [ ] 個別登録フォーム
- [ ] CSV/Excel一括インポート
- [ ] バリデーション
- [ ] 事前登録状態の管理

#### 3.2 招待メール送信
- [ ] 招待メール送信機能
- [ ] パスワード設定画面
- [ ] 初回ログイン処理

#### 3.3 社員一覧・詳細
- [ ] 社員一覧表示（検索・フィルタ）
- [ ] 社員詳細画面
- [ ] 権限設定
- [ ] アカウント有効/無効化

#### 3.4 部署管理
- [ ] 部署一覧
- [ ] 部署作成・編集
- [ ] 部署責任者設定
- [ ] 部署別統計

---

### フェーズ4: 申請・承認フロー（3-4週間）

#### 4.1 申請フォーム作成
- [ ] 内部申請フォーム（扶養、住所変更、休職など）
- [ ] 外部申請フォーム（資格取得、喪失、扶養異動など）
- [ ] 動的フォーム生成（申請種別ごと）
- [ ] 添付ファイルアップロード

#### 4.2 申請管理
- [ ] 申請一覧（管理者/社員）
- [ ] 申請詳細画面
- [ ] 申請作成・編集・削除
- [ ] 申請ステータス管理

#### 4.3 承認フロー
- [ ] 承認/差戻し/却下機能
- [ ] 差戻し理由入力
- [ ] コメント機能
- [ ] 申請履歴管理
- [ ] 再申請機能（前回添付書類の再利用）

#### 4.4 外部申請
- [ ] 外部申請送信（疑似的）
- [ ] 送信ステータス管理
- [ ] 受理確認機能
- [ ] エラーハンドリング

---

### フェーズ5: 月次計算機能（3-4週間）

#### 5.1 計算ロジック
- [ ] 健康保険料計算
- [ ] 厚生年金料計算
- [ ] 介護保険料計算（40-64歳）
- [ ] 扶養者アリの場合の計算
- [ ] 日割り計算（中途入社・退職）
- [ ] 65歳以上対応

#### 5.2 計算実行
- [ ] 一括計算機能
- [ ] 個別計算機能
- [ ] 計算対象者判定
- [ ] 計算結果表示・確認

#### 5.3 計算履歴
- [ ] 計算履歴保存
- [ ] 過去計算再現
- [ ] 計算結果CSV出力

#### 5.4 特殊ケース対応
- [ ] 休職中の計算
- [ ] 免除申請対応
- [ ] 他社兼務対応
- [ ] 給与システム連携判定

---

### フェーズ6: 書類作成機能（2-3週間）

#### 6.1 PDF生成
- [ ] PDFライブラリ導入（jsPDF、pdfmake等）
- [ ] テンプレート定義
- [ ] 各種書類フォーマット実装

#### 6.2 書類作成画面
- [ ] 書類種別選択
- [ ] データ入力フォーム
- [ ] プレビュー機能
- [ ] PDF出力

#### 6.3 書類管理
- [ ] 作成済み書類一覧
- [ ] 書類ダウンロード
- [ ] 書類削除

---

### フェーズ7: 通知システム（2週間）

#### 7.1 通知管理
- [ ] 通知サービス実装
- [ ] 通知データモデル
- [ ] 通知作成・送信

#### 7.2 通知画面
- [ ] 通知一覧（申請単位でグループ化）
- [ ] 通知詳細
- [ ] 既読/未読管理
- [ ] フィルタ・検索

#### 7.3 リマインダー
- [ ] 期限リマインダー設定
- [ ] 自動通知送信（Cloud Functions）
- [ ] 通知タイミング設定

---

### フェーズ8: 設定機能（2週間）

#### 8.1 組織設定
- [ ] 組織情報編集
- [ ] ロゴアップロード

#### 8.2 保険料・標準報酬設定
- [ ] 料率設定（過去・現在・将来）
- [ ] 標準報酬上限・下限設定
- [ ] CSV/Excelインポート

#### 8.3 申請フロー設定
- [ ] ステータス設定
- [ ] 承認ルール設定
- [ ] 添付書類必須/任意設定

#### 8.4 通知設定
- [ ] 通知タイミング設定
- [ ] 通知対象設定
- [ ] リマインダー設定

#### 8.5 権限設定
- [ ] ロール管理
- [ ] 権限付与・剥奪

---

### フェーズ9: 分析機能（1-2週間）

#### 9.1 集計機能
- [ ] 部署別集計
- [ ] 申請種別別集計
- [ ] 月次・年度推移

#### 9.2 グラフ表示
- [ ] グラフライブラリ導入（Chart.js、ng2-charts等）
- [ ] 各種グラフ実装

#### 9.3 CSV出力
- [ ] 集計結果CSV出力

---

### フェーズ10: 外部連携（2週間）

#### 10.1 データインポート
- [ ] CSV/Excelインポート機能
- [ ] データ競合検出
- [ ] 差分表示・選択機能

#### 10.2 データエクスポート
- [ ] 社員選択機能
- [ ] 出力データ種別選択
- [ ] CSV/Excel出力

---

### フェーズ11: 自分の情報画面（1-2週間）

#### 11.1 情報表示
- [ ] 基本情報表示
- [ ] 扶養情報表示
- [ ] 保険料表示
- [ ] 申請ステータス表示

#### 11.2 情報編集
- [ ] 編集可能項目の編集
- [ ] 申請が必要な項目の申請作成

#### 11.3 申請作成
- [ ] 申請ボタン
- [ ] 申請フォーム遷移

---

### フェーズ12: テスト・最適化（継続的）

#### 12.1 テスト
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] E2Eテスト

#### 12.2 パフォーマンス最適化（大手企業規模対応）
- [ ] データ取得最適化
  - Firestoreインデックス最適化
  - ページネーション実装（一覧画面）
  - 必要最小限のデータ取得（フィールド選択）
  - キャッシュ戦略の実装
- [ ] 画像最適化
  - 画像リサイズ・圧縮（Storageにアップロード時）
  - 遅延読み込み（Lazy Loading）
- [ ] バンドルサイズ最適化
  - コード分割（Route-based lazy loading）
  - Tree shaking
  - 不要なライブラリの削除
- [ ] 大量データ対応
  - バッチ処理の実装（一括計算、一括インポート）
  - バックグラウンド処理の検討（Cloud Functions）
  - タイムアウト・リトライ処理

#### 12.3 セキュリティ
- [ ] Firestoreセキュリティルール
  - 組織単位でのアクセス制御
  - 権限に応じた読み書き制限
  - 既存アプリとの完全分離
- [ ] Storageセキュリティルール
  - 組織単位でのアクセス制御
  - ファイルサイズ・形式制限
  - 既存アプリとの完全分離
- [ ] 認証チェック強化
  - 各API呼び出しでの認証チェック
  - 権限チェックの徹底
  - セッション管理
- [ ] データバリデーション
  - クライアント側バリデーション
  - サーバー側（Firestore Rules）バリデーション

---

## 🗄️ データモデル設計

### Firestoreコレクション構造（確定版）

**⚠️ 重要**: すべてのコレクション名に `socialInsurance_` プレフィックスを付けて既存アプリと分離

```
socialInsurance_organizations/          # 組織（企業）
  {orgId}/
    - name: string
    - corporateNumber: string
    - address: {
        prefecture: string
        city: string
        street: string
        building: string
      }
    - phoneNumber: string
    - email: string
    - industry: string
    - logoUrl: string
    - insuranceSettings: {
        healthInsurance: {
          type: 'kyokai' | 'kumiai'
          officeNumber: string
        }
        pensionInsurance: {
          officeNumber: string
          roundingMethod: string
        }
        careInsurance: {
          targetOffice: boolean
        }
        employmentInsurance: {
          officeNumber: string
          laborInsuranceNumber: string
        }
      }
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_users/                  # ユーザー（認証情報）
  {userId}/
    - email: string
    - displayName: string
    - role: 'owner' | 'admin' | 'employee'
    - organizationId: string
    - employeeId: string | null
    - emailVerified: boolean
    - isActive: boolean
    - createdAt: timestamp
    - lastLoginAt: timestamp

socialInsurance_employees/              # 社員情報
  {employeeId}/
    - employeeNumber: string
    - name: string
    - nameKana: string
    - email: string
    - departmentId: string
    - joinDate: timestamp
    - status: 'active' | 'leave' | 'retired'
    - dependentInfo: [{
        name: string
        nameKana: string
        birthDate: timestamp
        relationship: string
        income: number
        livingTogether: boolean
      }]
    - insuranceInfo: {
        healthInsuranceNumber: string
        pensionNumber: string
        myNumber: string
        standardReward: number
        insuranceStartDate: timestamp
      }
    - otherCompanyInfo: {
        isOtherCompany: boolean
        isPrimary: boolean
        companyName: string
      }
    - address: {
        internal: object  # 社内表示用（自由編集可）
        official: object  # 正式住所（申請制）
      }
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_departments/            # 部署
  {departmentId}/
    - name: string
    - parentDepartmentId: string | null
    - managerId: string | null
    - code: string
    - email: string
    - organizationId: string
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_applications/            # 申請
  {applicationId}/
    - type: string                      # 'dependent' | 'address-change' | 'leave' | ...
    - category: 'internal' | 'external'
    - employeeId: string
    - organizationId: string
    - status: 'draft' | 'pending' | 'approved' | 'rejected' | 'returned' | 'withdrawn'
    - data: object                      # 申請種別ごとのデータ
    - attachments: [{
        fileName: string
        fileUrl: string
        uploadedAt: timestamp
      }]
    - comments: [{
        userId: string
        comment: string
        type: 'comment' | 'rejection_reason'
        createdAt: timestamp
      }]
    - externalApplicationStatus: string | null  # 'sent' | 'received' | 'error'
    - deadline: timestamp | null
    - createdAt: timestamp
    - updatedAt: timestamp
    - withdrawnAt: timestamp | null

socialInsurance_calculations/            # 月次計算結果
  {calculationId}/
    - employeeId: string
    - organizationId: string
    - year: number
    - month: number
    - healthInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
      }
    - pensionInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
      }
    - careInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
        applicable: boolean  # 40-64歳のみ
      }
    - total: {
        employeeTotal: number
        companyTotal: number
      }
    - calculationType: 'normal' | 'prorated' | 'individual'
    - calculatedAt: timestamp
    - calculatedBy: string

socialInsurance_insuranceRates/          # 保険料率マスタ
  {rateId}/
    - type: 'health' | 'pension' | 'care'
    - rate: number
    - effectiveFrom: timestamp
    - effectiveTo: timestamp | null
    - organizationId: string | null  # nullの場合は全組織共通
    - createdAt: timestamp

socialInsurance_standardRewards/          # 標準報酬等級表
  {rewardId}/
    - grade: number
    - minAmount: number
    - maxAmount: number
    - effectiveFrom: timestamp
    - effectiveTo: timestamp | null
    - createdAt: timestamp

socialInsurance_notifications/            # 通知（既存アプリのnotificationsと分離）
  {notificationId}/
    - userId: string
    - applicationId: string | null
    - type: 'application' | 'approval' | 'rejection' | 'reminder' | 'system'
    - title: string
    - message: string
    - read: boolean
    - priority: 'high' | 'medium' | 'low'
    - organizationId: string
    - createdAt: timestamp

socialInsurance_documents/               # 作成済み書類
  {documentId}/
    - type: string
    - applicationId: string | null
    - employeeId: string
    - organizationId: string
    - fileUrl: string
    - fileName: string
    - createdAt: timestamp
    - expiresAt: timestamp              # 6年後自動削除用

socialInsurance_settings/                # 組織設定
  {orgId}/
    - applicationFlow: {
        statuses: [{
          name: string
          order: number
          label: string
        }]
      }
    - notificationSettings: {
        internalDeadlineDays: number     # デフォルト3日前
        externalDeadlineDays: number     # デフォルト7日前
      }
    - documentSettings: {
        allowedFormats: string[]
        maxFileSize: number
        retentionYears: number          # デフォルト6年
      }
    - updatedAt: timestamp
```

### Storage構造（確定版）

**⚠️ 重要**: すべてのパスが `social-insurance/` で始まり、既存アプリと完全に分離

```
social-insurance/
  organizations/
    {orgId}/
      documents/
        {applicationId}/
          {fileName}                    # 申請添付書類
      logos/
        logo.{ext}                      # 組織ロゴ
  templates/
    csv/
      employee_import_template.csv      # 社員インポートテンプレート
      rate_import_template.csv          # 料率インポートテンプレート
    excel/
      employee_import_template.xlsx
      rate_import_template.xlsx
    pdf/
      {documentType}_template.pdf       # 各種書類テンプレート
```

### セキュリティルール設計

#### Firestoreセキュリティルール
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 既存アプリのコレクション（変更なし）
    match /{existingCollection}/{document=**} {
      // 既存アプリのルール
    }
    
    // 新アプリのコレクション（socialInsurance_プレフィックス）
    match /socialInsurance_{collection}/{document=**} {
      // 認証済みユーザーのみアクセス可能
      allow read, write: if request.auth != null 
        && resource.data.organizationId == getUserOrganization();
      
      // 組織作成時は認証済みであればOK
      allow create: if request.auth != null 
        && request.resource.data.organizationId != null;
    }
  }
}
```

#### Storageセキュリティルール
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 既存アプリのパス（変更なし）
    match /existing_app/{allPaths=**} {
      // 既存アプリのルール
    }
    
    // 新アプリのパス（social-insurance/で始まる）
    match /social-insurance/{allPaths=**} {
      // 認証済みユーザーのみアクセス可能
      allow read, write: if request.auth != null;
    }
  }
}
```

---

## 🛠️ 技術スタック

### フロントエンド
- **Angular 18** - フレームワーク
- **TypeScript** - 言語
- **RxJS** - リアクティブプログラミング
- **Angular Material** (推奨) - UIコンポーネント
- **Tailwind CSS** (オプション) - スタイリング

### Firebase
- **Firebase Authentication** - 認証
- **Cloud Firestore** - データベース
- **Cloud Storage** - ファイルストレージ
- **Cloud Functions** (オプション) - サーバーレス関数
- **Firebase Hosting** (オプション) - ホスティング

### ライブラリ
- **@angular/fire** - Firebase統合
- **@angular/material** - UIコンポーネント（確定）
- **jsPDF / pdfmake** - PDF生成
- **xlsx / papaparse** - Excel/CSV処理
- **Chart.js / ng2-charts** - グラフ表示
- **date-fns** - 日付処理
- **rxjs** - リアクティブプログラミング（Angular標準）

### パフォーマンス考慮事項（大手企業規模）
- **Firestoreインデックス**: 大量データ検索に対応
- **ページネーション**: 一覧画面は20-50件ずつ表示
- **バッチ処理**: 一括計算・一括インポートはバッチ処理
- **キャッシュ戦略**: 頻繁にアクセスするデータはキャッシュ
- **コード分割**: ルートベースの遅延読み込み

---

## ❓ 確認事項

### 1. Firebaseプロジェクトについて
- [ ] 既存のFirebaseプロジェクトIDは何ですか？→「kensyu10119」
- [ ] 既存アプリのデータ構造はどうなっていますか？（コレクション名など）→「commentReadStatus、notifications、projects、tasks、teamInvitations、teams、users」
- [ ] 既存アプリとの完全分離が必要ですか？それともコレクション分離で十分ですか？→コレクション分離でいいかな
→あと、strageの分離もフォルダを分ける形でお願いしたい

### 2. 認証について
- [ ] 既存アプリと同じ認証システムを使用しますか？→うーん、ちょっと変えた方がいい気がする。
- [ ] メール認証の送信元アドレスは設定済みですか？→わかんない

### 3. UI/UXについて
- [ ] UIフレームワークはAngular Materialを使用しますか？それとも独自スタイル？→使用する
- [ ] レスポンシブデザインは必要ですか？→PC向けのみで作るので不要

### 4. 外部連携について
- [x] 給与システムとの連携フォーマットは決まっていますか？→カタログに書いてある通りにお願い
  - **入力データ**: 従業員マスタ、月額給与・賞与額、勤務日数・欠勤日数・残業時間、出勤日数・勤務時間、休職日数・休暇取得状況、社員からの申請情報、休職・育休・介護休暇ステータス、雇用保険加入情報、雇用保険料計算結果
  - **出力データ**: 健康保険料、厚生年金保険料、介護保険料、保険料計算に使用した標準報酬月額や基礎情報、社内承認結果、更新済み社員情報の通知、社員基本情報、雇用形態情報、退職情報、休職情報、被扶養者情報
- [x] CSV/Excelのテンプレートは提供されますか？→最適なテンプレートをサンプルとして表示したい
  - テンプレートファイルを `assets/templates/` に配置
  - インポート画面でテンプレートダウンロードボタンを表示
  - サンプルデータを含むテンプレートを提供

### 5. パフォーマンスについて
- [x] 想定ユーザー数はどのくらいですか？→一応大手企業でも使える形がいい
  - **想定**: 最大10,000社員規模の企業に対応
  - **対策**: ページネーション、インデックス最適化、バッチ処理
- [x] 同時接続数の目安はありますか？→同上
  - **想定**: 同時100-500ユーザー
  - **対策**: Firestoreの同時接続制限を考慮した設計、キャッシュ戦略

### 6. セキュリティについて
- [ ] 特定のIPアドレスからのアクセス制限は必要ですか？→不要
- [ ] 2要素認証は必要ですか？→不要のつもり

### 7. 開発環境について
- [ ] 開発用と本番用でFirebaseプロジェクトを分けますか？→わけない
- [ ] CI/CDパイプラインは必要ですか？→不要

---

---

## 📋 実装前のチェックリスト

### Firebase設定
- [ ] Firebase Consoleでプロジェクト `kensyu10119` にアクセス
- [ ] 新規Webアプリ `social-insurance-management-app` を追加
- [ ] Firebase設定情報（apiKey, authDomain等）を取得
- [ ] Authentication > Sign-in method でメール/パスワードを有効化
- [ ] Authentication > Templates でメール認証テンプレートを確認・設定
- [ ] Firestore Database でインデックス作成（後で必要に応じて）
- [ ] Storage でセキュリティルールを設定

### 開発環境準備
- [ ] Node.js、npm がインストール済み
- [ ] Angular CLI がインストール済み
- [ ] Firebase CLI がインストール済み（オプション）
- [ ] Git リポジトリの準備（オプション）

### プロジェクト設定
- [ ] `environment.ts` にFirebase設定を追加
- [ ] `package.json` に必要なライブラリを追加
- [ ] Angular Material をインストール
- [ ] プロジェクト構造を作成

---

## 📝 次のステップ

1. ✅ **確認事項への回答** - 完了
2. **Firebaseプロジェクト設定** - 実施が必要
   - Firebase Consoleで新規Webアプリを追加
   - 設定情報を取得して `environment.ts` に追加
3. **フェーズ1（基盤構築）**から実装開始
   - Firebase SDKインストール
   - 認証基盤構築
   - 基本レイアウト作成

---

## ⚠️ 重要な注意事項

### データ分離について
- **Firestore**: すべてのコレクション名に `socialInsurance_` プレフィックスを付ける
- **Storage**: すべてのパスが `social-insurance/` で始まる
- **認証**: 既存アプリとは独立した認証フローを使用
- **セキュリティルール**: 既存アプリと新アプリを完全に分離

### パフォーマンスについて
- 大手企業規模を想定した設計
- ページネーション、インデックス最適化、バッチ処理を実装
- 大量データ処理に対応

### メール認証について
- Firebase Console > Authentication > Templates でメール認証テンプレートを設定
- 送信元アドレスの設定が必要（後で確認）

実装を開始する準備ができましたら、お知らせください！


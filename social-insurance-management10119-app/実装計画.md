# 社会保険管理システム 実装計画

## 📋 目次
1. [Firebaseプロジェクト設定](#firebaseプロジェクト設定)
2. [プロジェクト構造](#プロジェクト構造)
3. [フェーズ別実装計画](#フェーズ別実装計画)
4. [データモデル設計](#データモデル設計)
5. [技術スタック](#技術スタック)
6. [確認事項](#確認事項)

---

## 🔥 Firebaseプロジェクト設定

### プロジェクト情報
- **プロジェクトID**: `kensyu10119`
- **既存アプリのコレクション**: 
  - `commentReadStatus`
  - `notifications` (⚠️ 新アプリでも使用するため、名前を変更する必要あり)
  - `projects`
  - `tasks`
  - `teamInvitations`
  - `teams`
  - `users` (⚠️ 新アプリでも使用するため、名前を変更する必要あり)

### 既存Firebaseプロジェクトに2つ目のアプリを追加する方法

#### 方法1: Firebase Consoleから追加（推奨）
1. Firebase Console (https://console.firebase.google.com/) にアクセス
2. プロジェクト `kensyu10119` を選択
3. プロジェクト設定（⚙️アイコン）を開く
4. 「アプリを追加」セクションで「Webアプリ」を選択
5. アプリのニックネームを入力: `social-insurance-management-app`
6. Firebase Hostingの設定は後で行う場合はスキップ
7. 設定コードが表示されるので、これをAngularプロジェクトに追加

#### 方法2: Firebase CLIを使用
```bash
# Firebase CLIがインストールされている場合
firebase use kensyu10119  # 既存プロジェクトを選択
firebase apps:create WEB social-insurance-management-app
```

### データ分離の方法（確定）

#### Firestoreコレクション分離
**既存アプリのコレクション**（変更なし）:
- `commentReadStatus`
- `notifications` (既存アプリ用)
- `projects`
- `tasks`
- `teamInvitations`
- `teams`
- `users` (既存アプリ用)

**新アプリのコレクション**（完全に分離）:
- `socialInsurance_organizations` - 組織（企業）
- `socialInsurance_users` - ユーザー（認証情報）
- `socialInsurance_employees` - 社員情報
- `socialInsurance_departments` - 部署
- `socialInsurance_applications` - 申請
- `socialInsurance_calculations` - 月次計算結果
- `socialInsurance_insuranceRates` - 保険料率マスタ
- `socialInsurance_notifications` - 通知（既存アプリの`notifications`と分離）
- `socialInsurance_documents` - 作成済み書類
- `socialInsurance_standardRewards` - 標準報酬等級表
- `socialInsurance_settings` - 組織設定

**命名規則**: すべて `socialInsurance_` プレフィックスを付けて既存アプリと明確に分離

#### Cloud Storageフォルダ分離

**既存アプリのStorage構造**（推測）:
```
existing_app/
  (既存アプリのファイル)
```

**新アプリのStorage構造**:
```
social-insurance/
  organizations/
    {orgId}/
      documents/
        {applicationId}/
          {fileName}
      logos/
        logo.{ext}
  templates/
    csv/
    excel/
    pdf/
```

**セキュリティルールでの分離**:
- パスが `social-insurance/` で始まるもののみ新アプリがアクセス可能
- 既存アプリは `existing_app/` 配下のみアクセス可能

### 認証システムの分離

**既存アプリ**: 既存の認証システムを使用（変更なし）

**新アプリ**: 独立した認証システム
- Firebase Authenticationの同じプロジェクト内で別の認証フローを使用
- ユーザーUIDは同じFirebaseプロジェクト内で一意（既存アプリと重複しない）
- 認証状態は完全に独立して管理
- メール認証の送信元アドレスは後で設定（Firebase Console > Authentication > Templates で設定）

---

## 📁 プロジェクト構造

```
src/
├── app/
│   ├── core/                          # コア機能（認証、ガード、インターセプター）
│   │   ├── auth/
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.guard.ts
│   │   │   └── role.guard.ts
│   │   ├── guards/
│   │   ├── interceptors/
│   │   └── models/
│   │       ├── user.model.ts
│   │       ├── organization.model.ts
│   │       └── employee.model.ts
│   │
│   ├── features/                      # 機能別モジュール
│   │   ├── setup/                     # 初回セットアップ
│   │   │   ├── setup-wizard/
│   │   │   ├── organization-create/
│   │   │   └── setup-guide/
│   │   │
│   │   ├── auth/                      # 認証関連
│   │   │   ├── login/
│   │   │   ├── register/
│   │   │   ├── email-verification/
│   │   │   └── password-setup/
│   │   │
│   │   ├── dashboard/                 # ダッシュボード
│   │   │   ├── admin-dashboard/
│   │   │   └── employee-dashboard/
│   │   │
│   │   ├── employees/                 # 社員管理
│   │   │   ├── employee-list/
│   │   │   ├── employee-detail/
│   │   │   ├── employee-create/
│   │   │   └── employee-import/
│   │   │
│   │   ├── departments/               # 部署管理
│   │   │   ├── department-list/
│   │   │   └── department-detail/
│   │   │
│   │   ├── applications/              # 申請管理
│   │   │   ├── application-list/
│   │   │   ├── application-detail/
│   │   │   └── application-create/   # 申請作成（内部・外部統合）
│   │   │
│   │   ├── calculations/              # 月次計算
│   │   │   ├── monthly-calculation/
│   │   │   ├── calculation-detail/
│   │   │   └── calculation-history/
│   │   │
│   │   │   # 書類作成機能は申請作成機能に統合（フェーズ4）
│   │   │
│   │   ├── notifications/             # 通知
│   │   │   ├── notification-list/
│   │   │   └── notification-detail/
│   │   │
│   │   ├── settings/                  # 設定
│   │   │   ├── organization-settings/
│   │   │   ├── insurance-rates/
│   │   │   ├── application-flow/
│   │   │   ├── permissions/
│   │   │   └── notification-settings/
│   │   │
│   │   ├── analytics/                 # 分析
│   │   │   ├── department-analytics/
│   │   │   └── application-analytics/
│   │   │
│   │   ├── external-integration/      # 外部連携
│   │   │   ├── import/
│   │   │   └── export/
│   │   │
│   │   └── profile/                    # 自分の情報
│   │       ├── my-info/
│   │       └── account-settings/
│   │
│   ├── shared/                        # 共有コンポーネント・サービス
│   │   ├── components/
│   │   │   ├── header/
│   │   │   ├── sidebar/
│   │   │   ├── notification-bell/
│   │   │   ├── file-upload/
│   │   │   └── status-badge/
│   │   ├── services/
│   │   │   ├── firestore.service.ts
│   │   │   ├── storage.service.ts
│   │   │   └── notification.service.ts
│   │   └── pipes/
│   │       └── date-format.pipe.ts
│   │
│   ├── app.component.ts
│   ├── app.config.ts
│   └── app.routes.ts
│
├── environments/
│   ├── environment.ts
│   └── environment.prod.ts
│
└── assets/
    └── templates/                     # CSV/Excel/PDFテンプレート
      ├── csv/                         # CSVテンプレート
      ├── excel/                       # Excelテンプレート
      └── pdf/                         # PDFテンプレート（公式テンプレート）
```

---

## 🚀 フェーズ別実装計画

### フェーズ1: 基盤構築（1-2週間）

#### 1.1 Firebase設定
- [ ] Firebase SDKインストール
  ```bash
  npm install @angular/fire firebase
  ```
- [ ] Firebase設定ファイル作成（`environment.ts`）
  - プロジェクトID: `kensyu10119`
  - 新アプリの設定情報を追加
- [ ] Firebase初期化（`app.config.ts`）
  - Firestore、Authentication、Storage、Functions設定
  - コレクション名のプレフィックス設定（`socialInsurance_`）
  - Storageパスのプレフィックス設定（`social-insurance/`）
- [ ] Firestoreインデックス設計（パフォーマンス最適化のため）
  - `socialInsurance_applications`: `organizationId + status + createdAt`
  - `socialInsurance_employees`: `organizationId + departmentId + status`
  - `socialInsurance_calculations`: `organizationId + year + month`
  - `socialInsurance_notifications`: `userId + read + createdAt`

#### 1.2 認証基盤
- [ ] Authentication設定（メール/パスワード）
  - Firebase Console > Authentication > Sign-in method でメール/パスワードを有効化
  - メール認証テンプレートの設定（送信元アドレスの設定が必要）
- [ ] 認証サービス実装
  - 既存アプリとは独立した認証フロー
  - 初回アカウント作成（メール認証）
  - 社員招待（パスワード設定）
  - ログイン（社員番号 or メールアドレス + パスワード）
- [ ] 認証ガード実装
  - `AuthGuard`: 認証済みチェック
  - `RoleGuard`: 権限チェック（owner/admin/employee）
  - `SetupGuard`: 初回セットアップ未完了チェック
- [ ] ログイン画面
  - 社員番号 or メールアドレス + パスワード
  - 新規登録リンク（初回アカウント用のみ）
- [ ] 新規登録画面（初回アカウント用）
  - 会社名、メールアドレス、パスワード設定
  - 利用規約・プライバシーポリシー同意チェック

#### 1.3 ルーティング設定
- [ ] ルート定義
- [ ] ガード適用
- [ ] リダイレクト設定

#### 1.4 基本レイアウト
- [ ] Angular Materialインストール・設定
  ```bash
  ng add @angular/material
  ```
- [ ] ヘッダーコンポーネント
  - サービス名表示
  - 通知アイコン（未読件数バッジ）
  - ユーザーメニュー（管理者のみモード切替表示）
  - ドロップダウン: 「自分の情報」「アカウント設定」「ログアウト」
- [ ] サイドバーコンポーネント
  - 管理者モード: ダッシュボード、社員管理、部署管理、申請管理、月次計算、分析、設定
  - 社員モード: ダッシュボード、自分の申請、自分の情報
  - モード切替ボタン（管理者のみ）
- [ ] レイアウトコンポーネント
  - PC向け固定幅レイアウト（レスポンシブ不要）
  - ヘッダー + サイドバー + メインコンテンツエリア

---

### フェーズ2: 初回セットアップ機能（2-3週間）

#### 2.1 メール認証フロー
- [ ] メール認証送信機能
- [ ] 認証リンククリック後の処理
- [ ] 認証状態の管理

#### 2.2 初回セットアップウィザード
- [x] ステップ1: 組織情報入力
  - [x] 組織名、法人番号、事業所番号、住所、連絡先情報の入力
  - [x] 必須項目バリデーション（組織名、法人番号、事業所番号）
  - [x] スキップ機能（任意項目のみ入力可能）
- [x] ステップ2: 部署作成
  - [x] 部署の追加・編集・削除
  - [x] スキップ機能
  - [x] 戻るボタン
- [x] ステップ3: 保険設定（健康保険、厚生年金、介護保険、雇用保険）
  - [x] 健康保険設定（種類: 協会けんぽ固定、事業所番号、端数処理方式、保険証形式）
  - [x] 厚生年金保険設定（事業所番号、適用事業所区分、端数処理方式）
  - [x] 介護保険設定（対象事業所の選択、必須項目）
  - [x] 雇用保険設定（事業所番号、労働保険番号）
  - [x] すべての項目が必須項目
  - [x] スキップ機能
  - [x] 戻るボタン
- [x] ステップ4: 料率インポート（CSV/Excel）
  - [x] CSV/Excelファイルのアップロード
  - [x] 料率の自動抽出（Excel: 9行目、CSV: 3-4行目）
  - [x] データ行のパース（Excel: 12行目以降、CSV: 14行目以降）
  - [x] 適用開始日・適用終了日の設定
  - [x] 手動入力機能（行の追加・編集・削除）
  - [x] 料率の編集機能
  - [x] テーブルのコンパクト表示とスクロール
  - [x] 読み込み件数と有効件数の表示
- [x] ステップ5: 申請フロー設定
  - [x] 申請種別設定
    - [x] 内部申請種別（11種類のデフォルト種別）
      - [x] 被扶養者（異動）届
      - [x] 高齢任意加入（取得・喪失）
      - [x] 産前産後休業取得者申出書／変更（終了）
      - [x] 育児休業取得者申出書（新規・延長）／終了届
      - [x] 養育期間特例申出書・終了届
      - [x] 住所変更届
      - [x] 氏名変更届
      - [x] 生年月日訂正届
      - [x] 傷病手当金申請
      - [x] 出産手当金申請
      - [x] 任意継続資格取得届
    - [x] 外部申請種別（26種類のデフォルト種別）
      - [x] 被保険者資格取得届（健保、年金両方）
      - [x] 被保険者資格喪失届（健保、年金両方）
      - [x] 高齢任意加入被保険者（船員以外）資格取得申出／申請書（年金）
      - [x] 高齢任意加入被保険者（船員以外）資格喪失申出／申請書（年金）
      - [x] 被扶養者（異動）届（健保、年金両方）
      - [x] 被保険者所属選択／二以上事業所勤務届（健保、年金両方）
      - [x] 70歳以上被用者所属選択／二以上事業所勤務届（年金）
      - [x] 被保険者報酬月額算定基礎届（健保、年金両方）
      - [x] 被保険者報酬月額変更届（健保、年金両方）
      - [x] 被保険者賞与支払届（健保、年金）
      - [x] 賞与不支給報告書（健保、年金）
      - [x] 標準賞与額累計申出書（健保）
      - [x] 産前産後休業取得者申出書／変更（終了）届（健保、年金両方）
      - [x] 産前産後休業終了時報酬月額変更届（健保、年金両方）
      - [x] 育児休業等終了時報酬月額変更届（健保、年金両方）
      - [x] 育児休業等取得者申出書（新規・延長）／終了届（健保、年金両方）
      - [x] 養育期間標準報酬月額特例申出書・終了届（年金）
      - [x] 被保険者区分変更届（健保、年金両方）
      - [x] 資格確認書回収不能届（健保）
      - [x] 被保険者住所変更届（国民年金第3号被保険者住所変更届）（健保、年金両方）
      - [x] 被保険者氏名変更（訂正）届（健保、年金両方）
      - [x] 被保険者生年月日訂正届（健保、年金両方）
      - [x] 傷病手当金申請（健保）
      - [x] 出産手当金申請（健保）
      - [x] 任意継続被保険者資格取得届（健保）
    - [x] 申請種別の編集機能（名前、コード、説明、有効/無効）
    - [x] 内部申請種別の追加機能（カスタム申請種別）
    - [x] カスタム申請種別の削除機能
    - [x] 外部申請種別は削除不可
  - [x] 承認ルール設定
    - [x] 固定ルール：「管理者のいずれか一名の承認」
  - [x] 添付書類設定
    - [x] 申請種別ごとの設定
    - [x] ファイル形式制限（PDF、画像、Excel、Word、カスタム）
    - [x] ファイルサイズ制限（MB）
    - [x] 説明文の設定
  - [x] 通知設定
    - [x] 内部申請の承認期限（日数、デフォルト3日）
    - [x] 外部申請の提出期限（日数、デフォルト7日）
    - [x] リマインダー間隔（日数）
    - [x] 通知先設定（申請者、管理者）
    - [x] 通知タイミング設定（申請提出時、承認時、差戻し時、却下時）
- [x] ステップ6: ドキュメント設定
  - [x] ファイル形式制限（PDF、画像、Excel、Word、カスタム）
  - [x] ファイルサイズ制限（MB）
  - [x] 保存期間設定（年、デフォルト6年）
  - [x] 社員情報に添付する書類の設定（申請種別ごとの設定とは独立）
- [x] ステップ7: 最終確認
  - [x] 各ステップの設定内容サマリー表示
  - [x] 各ステップへの戻り機能
  - [x] スキップ項目のエラー表示
  - [x] 完了ボタン（全設定を保存、`setupCompleted`フラグを設定）

#### 2.3 セットアップガイド
- [x] ToDoリスト表示
  - [x] ダッシュボードにセットアップガイドカードを表示（`setupCompleted`が`false`の場合）
  - [x] 各ステップの完了状況をチェック
  - [x] 未完了項目の表示
- [x] 完了チェック機能
  - [x] ステップ1: 組織情報の必須項目チェック
  - [x] ステップ2: 部署の作成状況チェック
  - [x] ステップ3: 保険設定の必須項目チェック
  - [x] ステップ4: 料率テーブルのデータ有無チェック
  - [x] ステップ5: 申請フロー設定のスキップ状況チェック
  - [x] ステップ6: ドキュメント設定のスキップ状況チェック
- [x] ガイド表示/非表示制御
  - [x] `setupCompleted`が`true`の場合は非表示
  - [x] セットアップウィザードへのリンク機能
  - [x] 未完了ステップから開始する機能

---

### フェーズ3: 社員管理機能（2-3週間）

#### 3.1 社員登録
- [x] 個別登録フォーム
  - [x] マルチステップフォーム（基本情報、保険情報、住所情報、その他情報、確認）
  - [x] 必須項目バリデーション（基本情報、住所情報）
  - [x] カナ氏名のカタカナバリデーション
  - [x] 生年月日フィールドの追加
  - [x] 権限設定（管理者のみ'admin'選択可能）
  - [x] 重複チェック（社員番号、メールアドレス）
- [x] CSV/Excel一括インポート
  - [x] CSV/Excelファイルのアップロード
  - [x] データのパース（21列 + 権限列（9列目））
  - [x] プレビュー表示（全列表示、テキスト折り返しなし、横スクロール）
  - [x] エラーチェック（必須項目、データ形式、重複）
  - [x] サンプルデータ表示（全21列 + 権限列）
  - [x] 一括登録実行
  - [x] 権限設定列の追加（9列目、ステータスの後、必須項目、デフォルト: 'employee'）
  - [x] 既存の列構成（1-8列）は変更なし（後方互換性を保持）
  - [x] 日付フィールドのパース（Excelシリアル日付対応）
  - [x] 空値の正規化（"ー"、"-"を空値として扱う）
- [x] バリデーション
  - [x] 必須項目チェック（基本情報、住所情報）
  - [x] カナ氏名のカタカナチェック
  - [x] 日付形式チェック
  - [x] メールアドレス形式チェック
  - [x] 重複チェック（社員番号、メールアドレス）
- [x] 事前登録状態の管理
  - [x] ステータス管理（'active' | 'inactive' | 'pre_join'）
  - [x] 未入社ステータスの追加

#### 3.2 招待メール送信
- [x] 招待メール送信機能
  - [x] Firebase Authenticationアカウント作成
  - [x] パスワードリセットメール送信（招待メールとして使用）
  - [x] `invitationEmailSent`フラグの更新
  - [x] `auth/email-already-in-use`エラーハンドリング
  - [x] サイドバー変更問題の修正（現在ログイン中のユーザーを保持）
- [x] パスワード設定画面
  - [x] パスワード設定フォーム
  - [x] パスワード強度チェック
  - [x] `users`コレクションエントリの作成（パスワード設定完了時）
  - [x] `emailVerified`フラグの更新
  - [x] 自動ログインとダッシュボードへのリダイレクト
- [x] 初回ログイン処理
  - [x] パスワード設定後の自動ログイン
  - [x] ダッシュボードへのリダイレクト

#### 3.3 社員一覧・詳細
- [x] 社員一覧表示（検索・フィルタ）
  - [x] テーブル表示（社員番号、氏名、カナ氏名、ステータス、権限、部署、入社日）
  - [x] 検索機能（社員番号、氏名）
  - [x] フィルタ機能（ステータス、権限、部署）
  - [x] ソート機能
  - [x] ページネーション（日本語ラベル）
  - [x] メールアドレス表示の削除
  - [x] メールアドレス検索の削除
  - [x] 招待メール未送信バッジ表示
- [x] 社員詳細画面
  - [x] 基本情報表示（タブ形式）
  - [x] 保険情報表示
  - [x] 住所情報表示
  - [x] その他情報表示
  - [x] 招待メール送信機能
  - [x] 招待メール未送信バッジ表示
  - [x] 削除機能（未認証の社員のみ削除可能）
  - [x] 権限表示・編集機能
- [x] 社員情報編集機能
  - [x] 編集画面コンポーネントの作成（`employee-create`をベースに）
  - [x] ルーティング追加（`/employees/:id/edit`）
  - [x] 既存データの読み込み（`EmployeeService.getEmployee()`）
  - [x] フォームに既存データを設定（`populateForms()`）
  - [x] 更新処理（`EmployeeService.updateEmployee()`）
  - [x] バリデーション（登録フォームと同じ）
  - [x] 重複チェック（自分自身を除外）
  - [x] 更新成功後のリダイレクト（社員詳細画面へ）
- [x] 権限設定
  - [x] **データモデル**
    - [x] `Employee`モデルに`role?: 'admin' | 'employee'`フィールドを追加（デフォルト: 'employee'）
    - [x] `EmployeeService.convertToEmployee()`で`role`フィールドを読み込み
    - [x] `EmployeeService.createEmployee()`で`role`フィールドを保存
    - [x] `EmployeeService.updateEmployee()`で`role`フィールドを更新
  - [x] **社員登録フォーム（個別登録）**
    - [x] `basicInfoForm`に`role`フィールドを追加（デフォルト: 'employee'）
    - [x] 権限選択ドロップダウンを追加（'admin' | 'employee'）
    - [x] 管理者のみ'admin'を選択可能にする（一般社員は'employee'のみ）
    - [x] `onStep5Submit()`で権限を保存
  - [x] **CSV/Excel一括インポート**
    - [x] `ImportedEmployee`インターフェースに`role?: 'admin' | 'employee'`フィールドを追加
    - [x] `parseEmployeeRow()`で権限列（9列目、ステータスの後）を読み込み
    - [x] 権限列は必須項目として扱う（列数が9列未満の場合はエラー）
    - [x] 権限値のパース（'admin' | 'employee' | '管理者' | '一般社員'など）
    - [x] 権限が空の場合はエラーを追加
    - [x] `displayedColumns`に`'role'`を追加（9列目）
    - [x] `updateDisplayedColumns()`に`'role'`を追加
    - [x] `executeImport()`で権限を保存
    - [x] サンプルデータ（`sample-dialog.component.ts`）に権限列を追加
      - [x] `displayedColumns`に`'role'`を追加（9列目）
      - [x] サンプルデータに`role`フィールドを追加（例: '一般社員', '管理者'）
      - [x] CSVテキストのヘッダーに「権限 *」列を追加（9列目）
      - [x] CSVテキストのデータ行に権限値を追加
      - [x] HTMLテンプレートで権限列を9列目（ステータスの後）に配置
    - [x] プレビューテーブル（`employee-import.component.html`）に権限列を追加（9列目）
  - [x] **社員詳細画面**
    - [x] 基本情報タブに権限表示を追加（ステータスの後）
    - [x] 権限の表示ラベル（'admin' → '管理者', 'employee' → '一般社員'）
    - [x] 権限編集機能を追加（編集ボタン）
    - [x] 権限変更時に確認ダイアログを表示（日本語ラベルで表示）
    - [x] 権限変更時に`employees`コレクションと`users`コレクションの両方を更新
    - [x] 権限編集ダイアログで日本語・英語の両方の入力に対応
  - [x] **パスワード設定時の権限反映**
    - [x] `password-setup.component.ts`の`onSubmit()`で`employees`コレクションの`role`を取得
    - [x] `users`コレクション作成時に`employees`の`role`を使用（デフォルト: 'employee'）
    - [x] 既存の`users`コレクション更新時も`role`を更新
  - [x] **権限変更機能**
    - [x] `AuthService`に`updateUserRole(employeeId: string, role: 'admin' | 'employee')`メソッドを追加
    - [x] `employees`コレクションと`users`コレクションの両方を更新
    - [x] `users`コレクション更新時は`employeeId`で検索して該当ユーザーを更新
- [ ] アカウント有効/無効化

#### 3.4 社員情報編集ログ機能（後で実装）
- [ ] ログデータモデル設計
  - 編集者（管理者ID）
  - 編集日時
  - 変更前後の値
  - 変更項目
- [ ] ログ保存機能（Firestoreの`auditLogs`コレクション）
- [ ] ログ表示機能（社員詳細画面に「編集履歴」タブ）
- [ ] パフォーマンス最適化（インデックス設計）

#### 3.5 部署管理
- [x] 部署一覧
  - [x] テーブル表示（部署名、コード、責任者、社員数、作成日）
  - [x] 検索機能
  - [x] ソート機能
  - [x] 作成・編集・削除ボタン
- [x] 部署作成・編集
  - [x] 部署フォーム（部署名、コード、親部署、責任者、メールアドレス）
  - [x] バリデーション
  - [x] 作成・更新処理
  - [x] 削除処理
- [x] 部署責任者設定
  - [x] 責任者選択（社員一覧から選択）
  - [x] 責任者メールアドレス設定
- [x] 部署別統計
  - [x] 社員数の表示（部署一覧テーブルに表示）

---

### フェーズ4: 申請・承認フロー（3-4週間）

#### 4.1 申請データモデル・サービス
- [x] 申請データモデル（Application）の定義
- [x] ApplicationServiceの実装（CRUD操作）
- [x] 申請一覧画面（管理者/社員）の実装
- [x] 申請詳細画面の実装
- [x] 申請内容の見やすい表示（申請種別ごとの表示形式）

#### 4.2 申請作成フォーム

##### 4.2.1 内部申請
- [x] 申請種別選択（内部申請）
- [x] 申請内容入力フォーム（基本実装完了）
- [x] 添付ファイルアップロード機能
- [ ] その他の申請種別フォーム（全ての実装完了後に追加するかも）

##### 4.2.2 外部申請（新フロー）
- [x] 申請種別選択（外部申請）
  - [x] 変更した8種の外部申請種別を表示
    - [x] 被保険者資格取得届（INSURANCE_ACQUISITION）
    - [x] 被保険者資格喪失届（INSURANCE_LOSS）
    - [x] 被扶養者（異動）届（DEPENDENT_CHANGE_EXTERNAL）
    - [x] 被保険者住所変更届（ADDRESS_CHANGE_EXTERNAL）
    - [x] 被保険者氏名変更（訂正）届（NAME_CHANGE_EXTERNAL）
    - [x] 被保険者報酬月額算定基礎届（REWARD_BASE）
    - [x] 被保険者報酬月額変更届（REWARD_CHANGE）
    - [x] 被保険者賞与支払届（BONUS_PAYMENT）
  - [ ] その他の外部申請種別（HTMLテンプレートでコメントアウト済み、全ての実装完了後に追加するかも）
- [x] **社員選択機能**
  - [x] 対象社員の選択UI（被保険者資格取得届、被保険者資格喪失届、被扶養者（異動）届など）
  - [x] 選択した社員の情報取得
- [x] **社員情報からの自動データ抽出**
  - [x] 申請種別に必要なデータ項目の定義
  - [x] 社員情報から該当データの自動抽出（氏名、生年月日、被保険者整理番号など）
  - [x] 不足データの検出（ラベルは残してデータ表示部は空欄）
  - [ ] 月次計算からの情報取得（フェーズ5実装後に追加）
  - [x] **内部申請からの情報取得**
    - [x] `Application`モデルに`relatedInternalApplicationIds?: string[]`を追加（外部申請が参照する内部申請IDの配列）
    - [x] `Application`モデルに`relatedExternalApplicationIds?: string[]`を追加（内部申請が参照する外部申請IDの配列）
    - [x] `ApplicationService`の`convertToApplication`と`updateApplication`を修正
    - [x] 承認済み内部申請詳細画面から外部申請作成機能（管理者のみ、「外部申請を作成」ボタン）
    - [x] 外部申請作成画面で内部申請を選択できる機能（ステップ1: 申請種別選択時に「関連する内部申請を選択」セクション、単一選択）
    - [x] 選択した内部申請の情報を自動入力・統合（被扶養者（異動）届、住所変更届、氏名変更届）
    - [x] 外部申請詳細画面に「関連する内部申請」セクションを表示
    - [x] 内部申請詳細画面に「関連する外部申請」セクションを表示
- [x] **内容確認ステップ（入力フォームの前）**
  - [x] ステップ4に実装済み（内容確認ステップ）
  - [x] 申請内容の見やすい表示（申請詳細画面と同じ形式）
  - [x] 不足データの表示（ラベルは残してデータ表示部は空欄）
  - [x] 説明PDFの表示（申請種別ごとの説明PDFを`assets/templates/`に配置済み）
  - [x] 「保存」ボタンでFirestoreに保存（申請作成・更新機能として実装済み）
  - [x] 「編集」ボタンで入力フォームに移動（申請編集機能として実装済み）
- [x] **入力フォーム（編集用）**
  - [x] 被保険者資格取得届フォームの実装
  - [x] 組織情報から提出者情報の自動設定
  - [x] 被保険者情報の複数追加機能（FormArray）
  - [x] 年号付き日付入力
  - [x] 備考の選択式入力
  - [x] その他の申請種別フォーム（8種類実装済み）
- [x] 添付ファイルアップロード機能
- [x] **届書提出日の管理機能**
  - [x] Applicationモデルに`submissionDate`を追加（ルートレベル）
  - [x] ApplicationReturnHistoryに`submissionDate`を追加
  - [x] 全ての申請フォームから`submissionDate`入力項目を削除（作成・編集画面の全申請種別）
  - [x] 外部申請の送信ステータス変更時に`submissionDate`を設定（「送信済み（未受理）」「受理済み」に変更時）
  - [x] 内部申請の送信時に`submissionDate`を設定（初回送信・再送信時）
  - [x] 差戻し時に`submissionDate`を履歴に保存
  - [x] 詳細画面で`submissionDate`を表示（基本情報セクション）
  - [x] 申請内容表示から`data['submissionDate']`の表示を削除
  - [x] ApplicationServiceで`submissionDate`を処理（`convertToApplication`、`createApplication`、`updateApplication`）
  - [x] 外部申請の被扶養者（異動）届に「事業主等受付年月日」を追加
    - [x] 事業主情報の下に年号付き日付入力フィールドを追加
    - [x] 関連する内部申請が承認済みの場合、承認日を自動転記
    - [x] 手動入力も可能
  - [ ] ⚠️ 動作確認は後ほど実施予定

#### 4.3 PDF生成機能（一旦廃止）
**注意**: PDF生成機能は一旦廃止（コメントアウト）されました。
- [ ] ~~PDFライブラリ導入~~（コメントアウト）
- [ ] ~~PDF生成サービスの作成~~（コメントアウト）
- [ ] ~~被保険者資格取得届のPDF生成~~（コメントアウト）

#### 4.4 申請管理
- [x] 申請一覧（管理者/社員）
  - [x] 管理者モード：外部申請（自分が作成）+ 社員の内部申請（全て）
  - [x] 一般社員モード：自分の申請のみ
- [x] 申請詳細画面
- [x] 申請作成・削除（基本実装完了）
- [x] 申請編集機能
- [x] **申請詳細画面のCSV出力機能**
  - [x] 外部申請の詳細画面でCSV出力ボタンを追加
  - [x] 申請内容をCSV形式で出力

#### 4.5 承認フロー（最優先実装）
**実装順序**: ステップ1（内部申請の送信機能と連携するため最優先）

- [x] **申請ステータス管理の改善**
  - [x] `draft` → `pending`（送信時）のステータス変更
  - [x] `pending` → `approved` / `rejected` / `returned`（承認時）のステータス変更
  - [x] ステータス変更のバリデーション
- [x] **承認/差戻し/却下機能**
  - [x] 申請詳細画面に承認ボタン（管理者のみ、`pending`状態の内部申請）
  - [x] 差戻し理由入力ダイアログ
  - [x] 却下理由入力ダイアログ
  - [x] ステータス更新処理（`ApplicationService.updateStatus`）
  - [x] 差戻し時に申請データと添付ファイルのスナップショットを保存（`returnHistory`）
- [x] **コメント機能**
  - [x] コメント追加機能（申請詳細画面）
  - [x] コメント表示（申請詳細画面）
  - [x] コメントの種類（通常コメント/差戻し理由）
- [x] **申請履歴管理**
  - [x] 履歴の自動記録（送信、承認、差戻し、却下）
  - [x] 履歴表示（申請詳細画面）
  - [x] 履歴の時系列表示
- [x] **差戻し履歴表示機能**
  - [x] 差戻し履歴の折りたたみ表示（`mat-expansion-panel`）
  - [x] 差戻し履歴詳細表示コンポーネント（`ApplicationReturnHistoryViewComponent`）
  - [x] 差戻し時点の申請データと添付ファイルの表示
  - [x] 申請種別ごとのデータフォーマット表示（日本語表記）

#### 4.6 内部申請の送信機能（ステップ2）
**実装順序**: ステップ2（承認フロー実装後に実装）

- [x] **送信機能**
  - [x] 申請詳細画面に「送信」ボタン（内部申請のみ、`draft`状態の時、一般社員のみ）
  - [x] 送信時に`status`を`pending`に変更
  - [x] 送信履歴を記録（`ApplicationHistory`）
  - [x] 送信後の編集制限（`pending`状態の申請は編集不可）
  - [x] 差戻しされた申請（`returned`）で変更がある場合の再送信機能
- [x] **申請一覧の権限管理（改善）**
  - [x] 管理者モード：全申請を表示（外部申請 + 社員の内部申請）
  - [x] 一般社員モード：自分の申請のみ表示
  - [x] **モード管理機能（ModeService）とフィルタ機能の改善（同時実装）**
    - [x] `ModeService`の作成（`isAdminMode$: BehaviorSubject<boolean>`）
    - [x] `localStorage`への保存・読み込み（デフォルト: `true`）
    - [x] `setAdminMode(isAdminMode: boolean)`メソッド
    - [x] `getIsAdminMode(): boolean`メソッド
    - [x] `HeaderComponent`と`SidebarComponent`で`ModeService.isAdminMode$`を購読
    - [x] `ApplicationListComponent`で社員モード時は自分の内部申請のみ表示（管理者アカウントでも社員モードの場合は一般社員と同じ動作）
    - [x] `ApplicationDetailComponent`でもモード判定を修正
    - [x] フィルタ機能の改善（ステータス、カテゴリ、申請種別）
    - [x] 検索フィールドの削除（社員フィルタがあるため不要）
- [x] **申請詳細画面の権限管理**
  - [x] 管理者：全申請を閲覧・承認操作可能
  - [x] 社員：自分の申請のみ閲覧可能、承認操作不可

#### 4.7 再申請機能（ステップ3）
**実装順序**: ステップ3（差戻しされた申請を再提出できるようにする）

- [x] **再申請機能**
  - [x] 差戻しされた申請（`returned`）を編集可能にする
  - [x] 前回の添付ファイルを再利用（差戻し履歴から添付ファイルをコピー）
  - [x] 再送信時に履歴を記録
  - [x] 再申請時のステータス変更（`returned` → `pending`）
  - [x] **変更検出機能**
    - [x] 差戻し履歴の`dataSnapshot`と現在の`data`を比較
    - [x] 差戻し履歴の`attachmentsSnapshot`と現在の`attachments`を比較
    - [x] 1つでも変更がある場合のみ再送信可能にする（`hasChanges()`メソッド）
    - [x] `canSubmit()`で`returned`状態かつ変更がある場合も送信可能にする
    - [x] `submitApplication()`で変更がない場合はエラーメッセージを表示

#### 4.8 外部申請のステータス管理（ステップ4）
**実装順序**: ステップ4（外部申請は承認不要のため最後に実装）

- [x] **外部申請ステータスの手動変更機能（管理者のみ）**
  - [x] 外部申請詳細画面にステータス変更ボタンを追加（管理者のみ）
  - [x] `externalApplicationStatus`を手動で変更できる機能（`sent` | `received` | `error`、`null`はコメントアウト）
  - [x] ステータス変更時に確認ダイアログを表示
  - [x] `ApplicationService.updateApplication()`を使用して`externalApplicationStatus`を更新
  - [x] ステータス変更履歴を記録（`ApplicationHistory`に追加、`action: 'status_change'`）
  - [x] ステータス変更後に申請詳細を再読み込み
  - [x] 送信ステータス変更時に申請ステータスも連動（送信済み（未受理）→ `pending_not_received`、受理済み→ `pending_received`）
- [x] **申請ステータス変更機能（外部申請・受理済み時のみ）**
  - [x] 外部申請詳細画面に申請ステータス変更ボタンを追加（受理済み時のみ）
  - [x] 申請ステータスを手動で変更できる機能（`pending_received`、`approved`、`returned`、`rejected`）
  - [x] 差戻し時の挙動を内部申請と同様にする（スナップショット保存、編集可能、再送信可能）
  - [x] 却下時の挙動を内部申請と同様にする（スナップショット保存なし、編集不可、再送信不可）
- [x] **処理待ちステータスの拡張**
  - [x] `ApplicationStatus`型に`pending_received`（処理待ち（受理済み））と`pending_not_received`（処理待ち（未受理））を追加
  - [x] ステータスラベルとカラーの追加
  - [x] 送信ステータス変更時の連動を実装
- [ ] **外部申請の送信機能（一旦なし、CSV出力があるため）**
  - [ ] ~~申請作成/編集画面に「送信」ボタン（外部申請のみ、管理者のみ）~~（一旦なし、CSV出力があるため、あとで実装するかも？）
  - [ ] ~~送信時に`externalApplicationStatus`を`sent`に更新~~（一旦なし）
  - [ ] ~~送信履歴を記録~~（一旦なし）
- [ ] **受理確認機能（一旦なし、CSV出力があるため）**
  - [ ] ~~外部申請の受理確認ボタン~~（一旦なし、CSV出力があるため、あとで実装するかも？）
  - [ ] ~~`externalApplicationStatus`を`received`に更新~~（一旦なし）
- [ ] **エラーハンドリング（一旦なし）**
  - [ ] ~~送信エラー時の処理~~（一旦なし）
  - [ ] ~~`externalApplicationStatus`を`error`に更新~~（一旦なし）
- [x] **外部申請承認時のデータ反映機能**
  - [x] 外部申請が`approved`になった時に社員データに反映する機能
  - [x] 申請種別ごとのデータ反映ロジック（被扶養者（異動）届、住所変更届、氏名変更届、報酬月額算定基礎届・変更届）
  - [x] 社員データの変更履歴を保存（申請ID、変更前/変更後の情報）
  - [x] 社員詳細画面で変更履歴を折りたたみリストで表示（申請名、変更前/変更後情報）
  - [x] 過去データの保持（変更履歴として保存）
  - [x] **報酬月額算定基礎届・変更届の等級自動計算機能**
    - [x] 申請データの`adjustedAverage`または`average`を`Employee.insuranceInfo.averageReward`に保存
    - [x] `averageReward`から等級を自動計算（健康保険等級・厚生年金等級）
    - [x] 等級に対応する`standardRewardAmount`（規定値）を`Employee.insuranceInfo.standardReward`に設定
    - [x] `grade`、`pensionGrade`を社員データに保存
    - [x] 申請承認日時点で有効な保険料率テーブルを使用して等級を計算
  - **注意**: `Employee`モデルを`name`/`nameKana`から`firstName`/`lastName`/`firstNameKana`/`lastNameKana`に変更。`address.internal`はコメントアウトし、`address.official`のみ使用。後方互換性のため、既存データの`name`/`nameKana`は自動的に分割される。

---

## ⚠️ 重要な注意事項

### Employeeモデルの変更（フェーズ4実装時）
- **変更内容**: `name`/`nameKana` → `firstName`/`lastName`/`firstNameKana`/`lastNameKana`に変更
- **address.internal**: コメントアウト（`address.official`のみ使用）
- **後方互換性**: 既存データの`name`/`nameKana`は自動的に分割される（`EmployeeService.convertToEmployee`で処理）
- **影響範囲**: 
  - `employee-create`, `employee-edit`, `employee-import`コンポーネントのフォーム構造変更
  - 社員一覧・詳細画面の表示変更
  - 申請作成・編集画面での社員選択時の自動入力処理変更
- **マイグレーション**: 既存データは自動変換されるため、手動マイグレーションは不要

---

### フェーズ5: 月次計算機能（3-4週間）

#### 5.1 計算ロジック
- [ ] 健康保険料計算
- [ ] 厚生年金料計算
- [ ] 介護保険料計算（40-64歳）
- [ ] 扶養者アリの場合の計算
- [ ] ~~日割り計算（中途入社・退職）~~（一旦実装しない）
- [ ] ~~65歳以上対応~~（一旦実装しない）

#### 5.1.1 標準報酬月額と等級の管理（✅ 実装済み）
- [x] `Employee.insuranceInfo`に以下を追加：
  - `averageReward?: number` - 申請された平均月額（`adjustedAverage`または`average`）
  - `grade?: number` - 健康保険の等級
  - `pensionGrade?: number` - 厚生年金の等級
- [x] 外部申請承認時の等級自動計算機能
  - 申請データの`adjustedAverage`または`average`から等級を自動計算
  - 等級に対応する`standardRewardAmount`（規定値）を`standardReward`に設定
  - `averageReward`、`grade`、`pensionGrade`を社員データに保存
- [x] 保険料計算時の標準報酬月額の使用
  - `Employee.insuranceInfo.standardReward`（等級により決められた額・規定値）を使用
  - `averageReward`から等級を判定し、その等級の`standardRewardAmount`を`standardReward`に設定する仕組み
- [x] 社員情報画面での表示・入力機能
  - 社員詳細画面に`averageReward`、`grade`、`pensionGrade`の表示を追加
  - 社員編集画面に`averageReward`、`grade`、`pensionGrade`の入力項目を追加
  - 社員作成画面に`averageReward`、`grade`、`pensionGrade`の入力項目を追加
- [x] 自動計算機能（blurイベント）
  - `averageReward`入力時：等級と`standardReward`を自動計算
  - `standardReward`入力時：等級を自動計算
  - `grade`入力時：`standardReward`を自動計算
  - 組織固有の保険料率テーブルのみを使用（全組織共通テーブルはコメントアウト）

**実装詳細**:
- `reflectRewardChange`メソッドで申請承認時に等級計算と標準報酬月額の設定を実行
- `InsuranceRateTableService`を使用して保険料率テーブルから等級を判定
- 申請承認日時点で有効な保険料率テーブルを使用して等級を計算
- 社員編集・作成画面で`blur`イベントにより自動計算を実行
- 保険料率テーブルは組織固有のもののみを使用（`getCommonRateTables()`はコメントアウト）

#### 5.2 計算実行
- [x] 一括計算機能
  - 計算一覧画面から年月を選択して一括計算を実行
  - 計算対象者を自動判定（在籍中、標準報酬月額設定済み、該当月に在籍）
  - 計算結果を自動保存
- [x] 個別計算機能
  - 社員詳細画面の保険情報タブに「保険料計算」ボタンを追加（管理者のみ表示）
  - 年月選択ダイアログで計算対象年月を選択
  - 標準報酬月額が設定されているか確認
  - 計算実行後、計算詳細画面に遷移
- [x] 計算対象者判定
  - 在籍中（status === 'active'）
  - 標準報酬月額が設定されている
  - 該当月に在籍していた（joinDate <= 該当月の月末）
- [x] 計算結果表示・確認
  - 計算詳細画面で計算結果を表示
  - 保険料の内訳（健康保険料、厚生年金料、合計、会社負担額、従業員負担額）を表示

#### 5.3 計算履歴
- [x] 計算履歴保存（基本実装済み）
- [x] 過去計算再現
  - [x] 計算一覧画面で年月を選択して過去の計算結果を表示
  - [x] 計算詳細画面に以下の情報を追加表示：
    - [x] その月の支給額（給与データから取得、後で実装予定）
    - [x] 家族構成（被扶養者情報）
    - [x] 料率（健康保険料率、厚生年金料率）- 健康保険料率は介護保険料込かどうかも表示
    - [x] 生年月日
    - [x] 入社日
  - [x] 給与データからの支給額取得機能（給与データから`totalPayment`を取得して`monthlyPaymentAmount`に設定）
  - [x] 計算詳細画面に「その月の支給額」を表示（`monthlyPaymentAmount`が存在する場合）
  - [x] 再計算機能の実装
    - [x] 確定済みまたは出力済みの計算結果を再計算する機能
    - [x] 再計算理由の入力（任意）
    - [x] 再計算履歴の保存と表示（古い順）
    - [x] 差額情報の計算と表示
    - [x] 遡及控除月選択ダイアログの表示
- [x] 計算結果CSV出力
  - [x] 計算一覧画面にCSV出力ボタンを追加
  - [x] フィルタ済みの計算結果をCSV形式で出力
  - [x] BOM付きUTF-8で出力（Excel対応）
  - [x] ファイル名：計算結果_YYYY年MM月_YYYYMMDDHHmmss.csv
- [x] 計算結果ステータス管理機能（修正８.txtに基づく）
  - [x] 計算履歴モデルの拡張（再計算履歴を追加）
  - [x] 下書きの上書き機能（同じ社員・年月のdraftがある場合、新規作成ではなく更新）
  - [x] 確定機能（詳細画面から確定、一覧画面から一括確定）
  - [x] 再計算機能（確定済みの計算結果を再計算、履歴に保存）
    - [x] 再計算時に年月選択ダイアログを表示せず、詳細画面の年月を自動使用
  - [x] 削除機能（draftのみ削除可能、confirmed/exportedは削除不可）
  - [x] CSV出力時のステータス変更（exportedに変更、出力日時を記録）
  - [x] 履歴表示（詳細画面に再計算履歴を表示）
- [x] **修正９の実装（等級・標準報酬月額適用年月日、被扶養者になった年月日、再計算時の差額計算・遡及控除）**
  - [x] **モデルの変更**
    - [x] `DependentInfo`に`becameDependentDate?: Date | Timestamp`を追加（被扶養者になった年月日）
    - [x] `InsuranceInfo`に`gradeAndStandardRewardEffectiveDate?: Date | Timestamp`を追加（等級・標準報酬月額適用年月日）
    - [x] `MonthlyCalculation`に`PremiumDifference`インターフェースを追加（保険料差額情報）
    - [x] `MonthlyCalculation`に`RetroactiveDeduction`インターフェースを追加（遡及控除情報）
  - [x] **申請承認時の反映処理**
    - [x] 算定基礎届の`applicableDate`を`gradeAndStandardRewardEffectiveDate`に反映
    - [x] 報酬月額変更届の`changeDate`を`gradeAndStandardRewardEffectiveDate`に反映
    - [x] 被扶養者異動届の`dependentStartDate`/`changeDate`を`becameDependentDate`に反映
  - [x] **社員詳細・編集画面の実装**
    - [x] 社員編集画面の保険情報フォームに適用年月日の入力欄を追加
    - [x] 社員編集画面の扶養情報フォームに被扶養者になった年月日の入力欄を追加
    - [x] 社員詳細画面の保険情報タブに適用年月日を表示
    - [x] 社員詳細画面の扶養情報タブに被扶養者になった年月日を表示
  - [x] **月次計算の再計算時の差額計算機能**
    - [x] 再計算時に前回結果と比較して差額を計算（4つの差額：健保・介護全額、厚生年金全額、会社負担額折半、従業員負担額折半）
    - [x] 計算詳細画面に差額情報セクションを追加（前回値、新値、差額を表示）
  - [x] **遡及控除月選択ダイアログ**
    - [x] 差額がある場合に遡及控除月選択ダイアログを表示
    - [x] 過去12ヶ月から適用月を選択（複数選択可能、基本は1ヶ月）
    - [x] 選択した月に遡及控除額を記録
  - [x] **反映月の計算詳細画面に遡及控除情報を表示**
    - [x] 遡及控除情報セクションを追加
    - [x] 適用年月と4つの差額を表示

#### 5.3.1 月変計算の判定ロジック修正（✅ 実装済み）
- [x] **月変計算の判定ロジックを修正**
  - [x] `detectFixedSalaryChanges`を使わず、フィルタで指定された月から直接判定
  - [x] **A月フィルタの場合**:
    - [x] (A-3)月と(A-2)月の`fixedSalary`を直接比較して変動があるかチェック
    - [x] 変動があれば、(A-2)月からA月までの3か月期間で基礎日数17日以上を満たしているかチェック
    - [x] 条件を満たしていれば表示
  - [x] 一括計算・個別計算メソッドの修正
    - [x] フィルタで指定された年・月から変動月（(A-2)月）を計算
    - [x] その変動月で計算を実行

#### 5.4 特殊ケース対応

##### 5.4.1 休職中の計算

**データモデル追加:**
- [x] **Employeeモデルに休職情報を追加**
  - [x] `leaveInfo?: LeaveInfo[]` を追加
  - [x] `LeaveInfo`インターフェースを定義
    - `type: 'maternity' | 'childcare' | string`（産前産後休業、育児休業等、後で追加するかも）
    - `startDate: Date | Timestamp`（休職開始（予定）日）
    - `endDate?: Date | Timestamp`（休職終了（予定）日）
    - `isApproved: boolean`（申請承認済みかどうか、チェックボックスでフラグ管理）
  - [ ] 後々実装予定の休業関連の申請詳細から反映させる機能（今は手入力のみ）

**UI実装:**
- [x] **社員詳細画面に休職情報の表示を追加**
  - [x] 基本情報タブに「休職情報」セクションを追加
  - [x] 休職情報の一覧を表示（休職種別、開始日、終了日、承認状態）
  - [x] 休職情報がない場合は「休職情報が登録されていません」と表示

- [x] **社員編集画面に休職情報の入力機能を追加**
  - [x] 新しいステップ「ステップ6: 休職情報」を追加
  - [x] `FormArray`で複数の休職情報を管理
  - [x] 各休職情報の入力項目：
    - 休職種別（産前産後休業、育児休業等）
    - 休職開始（予定）日
    - 休職終了（予定）日
    - 申請承認済み（チェックボックス）
  - [x] 休職情報の追加・削除ボタン
  - [x] 休職情報の読み込み・保存処理

- [x] **社員作成画面に休職情報の入力機能を追加**
  - [x] 編集画面と同様の休職情報入力機能を追加

- [ ] **Organizationモデルに保険料徴収方法を追加（後で実装）**
  - [ ] `leaveInsuranceCollectionMethod?: 'prepaid' | 'postpaid' | 'direct_transfer'` を追加
  - [ ] デフォルト値: `'postpaid'`（後払い）
  - [ ] ※組織情報設定機能が初回セットアップのみのため、組織情報設定機能の拡張後に実装

**計算ロジック:**
- [x] **申請承認済みの場合**
  - [x] 休職開始日を含む月～休職終了日の翌日を含む月の前月まで、全額免除（社員負担・会社負担ともに0、計算自体をスキップ）
  - [x] 計算をスキップして全額0の計算結果を返す
  - [x] 計算結果に免除理由を記録（`notes`フィールドに記録）

- [ ] **申請承認されていない場合（設定機能実装時に実装）**
  - [ ] 組織情報の保険料徴収方法が実装された後に実装
  - [ ] **前払い選択の場合:**
    - [ ] 休職前最後の月に休職期間分の保険料を一括徴収
    - [ ] 未来分の計算も実行（等級表は未来のその月時点で有効なものを使用）
    - [ ] 通常分と前払い分を分けて表示、合計も表示
  - [ ] **後払い選択の場合:**
    - [ ] 毎月計算は実行（会社分は支払いが必要）
    - [ ] 詳細に「休職中特例で復職後徴収」と記載
    - [ ] 休職終了日の翌日を含む月の計算で、休職中の社員徴収分を追記し、合計を追記
  - [ ] **本人振込選択の場合:**
    - [ ] 通常通り計算
    - [ ] 社員負担分に「給与天引きではない」旨を記載

**一覧表示:**
- [x] 休職中も一覧に表示
- [x] 一括計算の対象外（個別計算のみ可能）
- [ ] 一覧で休職中であることを表示（UI改善として後で実装）

##### 5.4.2 免除申請対応
- [ ] 一旦なし（休職中の計算の要件に伴って）

##### 5.4.3 他社兼務対応（修正12）
- [x] **計算対象の変更**
  - [x] 主たる勤務先・従たる勤務先の両方を計算対象にする
  - [x] `getCalculationTargetEmployees`と`getBonusCalculationTargetEmployees`から`isPrimary`チェックを削除

- [x] **他社勤務情報の拡張**
  - [x] `OtherCompanyInfo`を配列化（複数社対応）
  - [x] `OtherCompanyInfo`インターフェースを変更：
    ```typescript
    interface OtherCompanyInfo {
      companyId: string; // 他社識別ID（UUID）
      companyName: string; // 会社名
      isPrimary: boolean; // 主たる勤務先かどうか
    }
    ```
  - [x] `Employee`モデルの`otherCompanyInfo`を`OtherCompanyInfo[]`に変更

- [x] **他社給与データの管理**
  - [x] `OtherCompanySalaryData`モデルを作成
  - [x] Firestoreコレクション`otherCompanySalaryData`を作成
  - [x] `OtherCompanySalaryDataService`を作成（CRUD操作）

- [x] **他社給与入力ページの実装**
  - [x] 社員詳細画面から遷移する他社給与入力ページを作成
  - [x] 最新月含め過去1年分を表示（表示上は「〇月分」）
  - [x] 表示されていない過去分は内部で保持
  - [x] 「保存」ボタン：下書き反映
  - [x] 「確定」ボタン：正式反映

- [x] **他社兼務社員の標準報酬月額管理**
  - [x] 他社兼務社員の標準報酬月額は申請承認の反映をしない（手入力のみ）
  - [x] 外部申請承認時のデータ反映処理で、`otherCompanyInfo`が存在する場合は`standardReward`の更新をスキップ

- [x] **計算可能条件の追加**
  - [x] 現在の給与確定の条件がある前提で、プラスして他社兼務者の場合は該当月の他社給与データが確定済みかチェック
  - [x] `calculateEmployeePremium`で、他社兼務者の場合は該当月の他社給与データ（月額報酬）が確定済みかチェック
  - [x] `calculateEmployeeBonusPremium`で、他社兼務者の場合は該当月の他社給与データ（賞与）が確定済みかチェック

- [x] **保険料計算ロジックの変更**
  - [x] 保険料 = 標準報酬月額 × 料率 × 自社給与 / (自社給与 + 他社月額報酬合算)
  - [x] 他社月額報酬合算 = 該当月の確定済み他社給与データの`monthlyReward`の合計
  - [x] 自社給与 = 該当月の確定済み給与データの`totalPayment`
  - [x] 折半等は通常と同様（端数処理も同様）
  - [x] 月次計算と賞与計算の両方に適用

- [x] **計算結果詳細の表示追加**
  - [x] `MonthlyCalculation`と`BonusCalculation`に以下を追加：
    ```typescript
    isOtherCompany?: boolean; // 他社兼務かどうか
    ownCompanySalary?: number; // 自社給与
    otherCompanySalaryTotal?: number; // 他社月額報酬合算
    ```
  - [x] 計算結果詳細画面に以下を追加表示：
    - [x] 他社兼務であること（フラグ表示）
    - [x] 自社給与
    - [x] 他社月額報酬合算

##### 5.4.4 給与システム連携判定
- [ ] なしで良い（CSV出力と給与情報入力でカバー可能）

##### 5.4.5 年齢による特例
- [x] **70歳以上75歳未満**
  - [x] 厚生年金の計算はしない（健康保険料のみ計算）
  - [x] 月次計算と賞与計算の両方に適用
- [x] **75歳以上**
  - [x] 全ての計算はしない（健康保険料も厚生年金も計算しない）
  - [x] 一覧表示から除外（`getCalculationTargetEmployees`と`getBonusCalculationTargetEmployees`で除外）

##### 5.4.6 保険料の端数処理変更（修正11）
- [x] **計算順序の変更**
  - [x] 各保険料の全額を四捨五入しない（`Math.round()`を削除）
  - [x] 等級表から折半額（`half`）を直接取得
  - [x] `calculateHealthInsurance`と`calculatePensionInsurance`を`half`を返すように変更

- [x] **折半額の端数処理（通常）**
  - [x] 50銭以下を切り捨て、50銭超を切り上げ（10000.50 → 10000、10000.51 → 10001）
  - [x] 実装：`half % 1 <= 0.5 ? Math.floor(half) : Math.ceil(half)`
  - [x] 月次計算と賞与計算の両方に適用

- [ ] **折半額の端数処理（申請承認されていない休職者で、保険料徴収方法が本人支払の場合）**
  - [ ] 50銭以上を切り上げ、50銭未満を切り捨て（10000.50 → 10001、10000.49 → 10000）
  - [ ] 実装：`half % 1 >= 0.5 ? Math.ceil(half) : Math.floor(half)`
  - [ ] 組織情報の`leaveInsuranceCollectionMethod`が`'direct_transfer'`かつ`leave.isApproved === false`で判定
  - [ ] ※組織情報の保険料徴収方法が実装された後に実装

- [x] **表示の変更**
  - [x] 会社負担額の表示を「想定会社負担額」に変更
  - [x] 月次計算・賞与計算の一覧・詳細画面で適用

- [x] **会社負担額総額の計算**
  - [x] その月の全保険料から、社員負担額の合計を引いた額が会社負担額となる
  - [x] 計算一覧画面に合計セクションを追加（想定合計保険料、社員負担額合計、想定会社負担額総額）
  - [x] 計算式：想定会社負担額総額 = 想定合計保険料（全額） - 社員負担額合計（折半額）
  - [x] 想定合計保険料の計算結果は端数切捨てで表示（`Math.floor()`）

##### 5.4.7 計算対象者の判定ロジック変更
- [x] **Employeeモデルに退職日を追加**
  - [x] `retirementDate?: Date | Timestamp`を追加

- [x] **ステータス判定から入社日・退職日判定への変更**
  - [x] 月次計算・賞与計算・算定計算・月変計算のすべてで、ステータス判定を削除
  - [x] 入社日・退職日での該当月の在籍判定に変更
    - 入社日 <= 該当月の月末
    - 退職日の翌日が含まれる月以降は除外（退職日の翌日が含まれる月は除外）

- [x] **休職終了日の判定ロジック変更**
  - [x] 休職終了日の判定を退職日と同じロジックに変更
  - [x] 休職終了日の翌日が含まれる月は除外（免除対象外）

- [x] **算定計算の対象者条件**
  - [x] 入社日が5月31日以前の社員のみ対象（6月1日以降に入社した社員は対象外）
  - [x] 退職日の判定：退職日の翌日が含まれる月以降は除外（退職日が6月30日以前の場合、7月は対象外）

#### 5.5 算定／月変計算機能（✅ 実装済み）
**実装順序**: フェーズ5の後に実装

##### 5.5.1 給与情報入力機能
- [x] **給与情報入力ページの実装**
  - [x] 給与情報入力コンポーネント（`SalaryInputComponent`）の作成
  - [x] 年・月・部署・確定ステータスでのフィルタリング機能
  - [x] 社員一覧表示（給与データと共に表示）
  - [x] 給与データの入力項目（基礎日数、固定賃金、総支給、遡及支払額）
  - [x] 給与データの保存機能（下書き保存）
  - [x] 給与データの確定機能（確定済みデータは編集不可）
  - [x] Excel/CSVインポート機能（社員番号、社員名、年、月、基礎日数、固定賃金、総支給、遡及支払額）
  - [x] 給与データモデル（`SalaryData`）の実装
    - `year`, `month`, `baseDays`, `fixedSalary`, `totalPayment`, `retroactivePayment`
    - `isConfirmed`, `confirmedAt`, `confirmedBy`
    - `changeHistory`（確定後の修正履歴）
  - [x] `SalaryDataService`の実装
    - `getSalaryDataByEmployeeAndMonth()` - 特定社員・年月の給与データ取得
    - `getSalaryDataListByEmployee()` - 社員の給与データ一覧取得
    - `saveSalaryData()` - 給与データの保存（下書き）
    - `confirmSalaryData()` - 給与データの確定
    - `updateConfirmedSalaryData()` - 確定済み給与データの修正（履歴付き）

##### 5.5.2 算定計算機能
- [x] **算定計算ロジックの実装**
  - [x] `StandardRewardCalculationService`の実装
    - `calculateStandardReward()` - 算定計算の実行
      - 4月、5月、6月の給与データを取得
      - 基礎日数17日以上の月のみ集計
      - 遡及支払額を考慮した平均月額計算（総支給から遡及支払額を引いてから平均を計算）
      - 平均月額の端数処理：円未満切り捨て（`Math.floor()`）
      - 9月時点で適用される等級表を使用して等級・標準報酬月額を決定
    - `saveCalculation()` - 計算結果の保存
    - `getCalculation()` - 計算履歴の取得
    - `getCalculationsByOrganizationAndType()` - 組織・タイプ別の計算履歴取得
    - `updateCalculation()` - 計算履歴の更新（申請IDの紐付け等）
    - `recalculateCalculation()` - 再計算機能（履歴保存付き）
  - [x] `StandardRewardCalculation`モデルの実装
    - `calculationType: 'standard' | 'monthly_change'`
    - `targetYear`, `targetMonth`
    - `baseMonths`（算定の場合：4月、5月、6月）
    - `salaryData`（計算に使用した給与データ）
    - `averageReward`, `grade`, `pensionGrade`, `standardReward`
    - `status: 'draft' | 'applied' | 'approved'`
    - `applicationId`（申請IDの紐付け）
    - `recalculationHistory`（再計算履歴）

##### 5.5.3 月変計算機能
- [x] **月変計算ロジックの実装**
  - [x] 固定賃金変動の検出機能（`detectFixedSalaryChanges()`）
    - 過去12ヶ月分の給与データをチェック
    - 前月との固定賃金比較（1円でも変動があれば検出）
  - [x] `calculateMonthlyChange()` - 月変計算の実行
    - 変動月を含む3ヶ月の給与データを取得
    - 3ヶ月全ての給与が確定済みであることを確認
    - 3ヶ月全てで基礎日数17日以上を満たすことを確認
    - 基礎日数17日以上の月のみ集計し、遡及支払額を考慮（総支給から遡及支払額を引いてから平均を計算）
    - 平均月額の端数処理：円未満切り捨て（`Math.floor()`）
    - 固定賃金変動月から4ヶ月目時点で適用される等級表を使用
    - 従前等級との比較で等級変動を計算
    - 2等級以上変動の場合は申請が必要（`requiresApplication: true`）
  - [x] `StandardRewardCalculation`モデルの拡張（月変用フィールド）
    - `changeMonth`（変動月）
    - `calculationMonths`（変動月を含む3ヶ月）
    - `previousGrade`（従前等級）
    - `gradeChange`（等級変動）
    - `requiresApplication`（申請要否）

##### 5.5.4 算定／月変計算一覧ページ
- [x] **算定／月変計算一覧コンポーネントの実装**
  - [x] `StandardRewardCalculationListComponent`の作成
  - [x] タブ表示（算定タブ・月変タブ）
  - [x] **算定タブ**
    - [x] 年フィルタ（タブ内に配置）
    - [x] 対象社員の表示（5月31日以前に入社した社員かつ6月給与が確定済み、6月1日以降に入社した社員は対象外）
    - [x] 退職日の判定：退職日の翌日が含まれる月以降は除外（退職日が6月30日以前の場合、7月は対象外）
    - [x] 計算結果の表示（平均月額、等級、標準報酬月額、ステータス）
    - [x] 計算実行ボタン（未計算の場合）
    - [x] 詳細表示ボタン（計算済みの場合）
    - [x] 申請作成ボタン（申請が必要な場合）
  - [x] **月変タブ**
    - [x] 年・月フィルタ（タブ内に配置）
    - [x] 対象社員の表示（固定賃金変動があり、変動月を含む3ヶ月目の給与が確定済み、基礎日数17日以上を満たす）
    - [x] 計算結果の表示（変動月、平均月額、等級、等級変動、申請要否、ステータス）
    - [x] 計算実行ボタン（未計算の場合）
    - [x] 詳細表示ボタン（計算済みの場合）
    - [x] 申請作成ボタン（申請が必要な場合）
  - [x] 給与情報入力ページへのリンクボタン
  - [x] サイドバーへのメニュー追加（「申請管理」と「月次計算」の間）

##### 5.5.5 計算履歴詳細画面
- [x] **計算履歴詳細コンポーネントの実装**
  - [x] `StandardRewardCalculationDetailComponent`の作成
  - [x] 基本情報の表示（計算タイプ、対象年月、社員情報、部署）
  - [x] **算定計算の場合**
    - [x] 対象期間の表示（4月～6月）
    - [x] 平均月額、決定等級、厚生年金等級、標準報酬月額の表示
  - [x] **月変計算の場合**
    - [x] 変動月の表示
    - [x] 計算対象期間の表示（変動月を含む3ヶ月）
    - [x] 従前等級、等級変動の表示
    - [x] 申請要否の表示
  - [x] 給与データの表示（拡張パネル）
  - [x] 再計算履歴の表示（拡張パネル）
  - [x] 操作ボタン（戻る、再計算、申請作成）
  - [x] ルーティング設定（`/standard-reward-calculations/:id`）

##### 5.5.6 申請作成との連携
- [x] **計算履歴から申請作成機能**
  - [x] 計算履歴詳細画面から申請作成画面への遷移（クエリパラメータで計算履歴IDを渡す）
  - [x] 申請作成画面での計算履歴IDの読み取り
  - [x] 申請種別の自動選択
    - 算定計算 → 「被保険者報酬月額算定基礎届」（外部申請）
    - 月変計算 → 「被保険者報酬月額変更届」（外部申請）
  - [x] 申請種別の固定（変更不可）
  - [x] 計算履歴データの自動入力（`autoFillFromCalculation()`）
    - 被保険者情報の自動入力
    - 給与データの自動入力
    - 適用年月・変更年月の自動入力
  - [x] 申請作成時に計算履歴IDを申請データに保存（`data.calculationId`）
  - [x] 申請作成後に計算履歴のステータスを「申請済み」に更新（`status: 'applied'`）
  - [x] 申請作成後に計算履歴に申請IDを紐付け（`applicationId`）

##### 5.5.7 実装時の注意事項
- [x] `Employee`モデルに`salaryData`フィールドを追加
- [x] `EmployeeService.convertToEmployee()`で`salaryData`の日付変換処理を追加
- [x] 算定タブ：6月給与が確定済みかチェック
- [x] 算定タブ：入社日が5月31日以前の社員のみ対象（6月1日以降に入社した社員は対象外）
- [x] 算定タブ：退職日の判定（退職日の翌日が含まれる月以降は除外、退職日が6月30日以前の場合、7月は対象外）
- [x] 月変タブ：変動検出ロジックの実装（変動がある社員のみ表示）
- [x] 月変タブ：変動月を含む3ヶ月目の給与が確定済みかチェック
- [x] 月変タブ：基礎日数17日以上を満たすかチェック
- [x] 各タブ内にフィルタを配置（算定タブ：年、月変タブ：年と月）
- [x] タブ切り替え時に該当タブのデータを読み込み
- [x] フィルタ変更時に該当タブのデータのみ再読み込み
- [x] 月変計算の判定ロジック修正（A月フィルタで(A-3)月と(A-2)月を比較）
- [x] 算定／月変計算の一括計算・一括確定機能の実装

#### 5.6 賞与計算機能（✅ 実装済み）
**実装順序**: フェーズ5の後に実装

##### 5.6.1 賞与データ管理
- [x] **賞与データモデルの実装**
  - [x] `BonusData`インターフェースの作成
  - [x] `Employee`モデルに`bonusData?: BonusData[]`を追加
- [x] **賞与データサービスの実装**
  - [x] `BonusDataService`の作成
  - [x] 標準賞与額の計算ロジック（1000円未満切り捨て）

##### 5.6.2 給与情報入力ページへの賞与項目追加
- [x] **給与情報入力ページに賞与項目を追加**
  - [x] 賞与額の入力欄を追加
  - [x] Excel/CSVインポート機能に賞与項目を追加
  - [x] Excel/CSVエクスポート機能に賞与項目を追加

##### 5.6.3 賞与保険料計算機能
- [x] **賞与計算ロジックの実装**
  - [x] `BonusCalculation`モデルの実装
  - [x] `CalculationService.calculateEmployeeBonusPremium()`の実装
  - [x] 賞与データが確定済みかチェック（計算実行時のみ）

##### 5.6.4 保険料計算ページのタブ化
- [x] **保険料計算ページをタブ化**
  - [x] 現在のページを「月次」タブとして維持
  - [x] 「賞与」タブを新規追加
  - [x] タブの上に「給与情報入力」ボタンを追加
  - [x] 賞与タブの一覧表示・一括操作機能

##### 5.6.5 賞与計算詳細画面（✅ 実装済み）
- [x] **賞与計算詳細コンポーネントの実装**
  - [x] `BonusCalculationDetailComponent`の作成
  - [x] 基本情報の表示（計算対象年月、社員情報、部署）
  - [x] 標準賞与額の表示
  - [x] 保険料詳細の表示
  - [x] 被扶養者情報の表示
  - [x] 過去計算再現用情報の表示（料率、生年月日、入社日）
  - [x] 差額情報の表示（再計算時）
  - [x] 遡及控除情報の表示
  - [x] 再計算履歴の表示
  - [x] 操作ボタン（計算実行、確定、再計算、削除）
  - [x] ルーティング設定（`/bonus-calculations/:id`）

##### 5.6.6 賞与計算の再計算機能（✅ 実装済み）
- [x] **賞与計算の再計算機能の実装**
  - [x] `CalculationService.recalculateBonusCalculation()`の実装
    - [x] 確定済み・出力済みの賞与計算結果を再計算
    - [x] 再計算前のデータを履歴に保存
    - [x] 差額を計算（4つの差額）
    - [x] 遡及控除月選択ダイアログの表示（差額がある場合）
    - [x] 遡及控除情報の保存
  - [x] 賞与計算詳細画面に再計算ボタンを追加
  - [x] 再計算履歴の表示

##### 5.6.7 実装時の注意事項
- [x] 賞与データは月次給与データとは別のデータとして管理
- [x] 標準賞与額は1000円未満を切り捨て
- [x] 賞与計算のロジックは月次計算と同様（標準報酬月額が標準賞与額になっただけ）
- [x] 扶養者の扱いは月次計算と同様
- [x] 給与情報確定チェックは計算実行時のみ（表示は未確定でも可能）

---

### フェーズ6: 書類作成機能（フェーズ4に統合）

**注意**: 書類作成機能は申請作成機能に統合されました。
- PDF生成機能はフェーズ4.3に移動
- 書類管理は申請管理画面（フェーズ4.4）に統合
- 「外部申請書類作成」メニューは削除（申請作成機能に統合）

---

### フェーズ7: 通知システム（2週間）

#### 7.1 通知管理
- [x] 通知サービス実装
- [x] 通知データモデル
- [x] 通知作成・送信

#### 7.2 通知画面
- [x] 通知一覧（申請単位でグループ化、同一トリガーで発生した通知をまとめる）
- [x] 通知詳細（申請情報、通知一覧、既読管理）
- [x] 既読/未読管理
- [x] フィルタ・検索

#### 7.3 リマインダー
- [x] 期限リマインダー設定
  - [x] 管理者向け：法定期限のX日前（デフォルト7日）の通知設定
  - [x] 社員向け：管理者設定期限のY日前（デフォルト3日）の通知設定
  - [x] 期限超過、当日、事前通知の設定（設定可能）
  - [x] 設定画面の実装（/settings）
- [x] 期限リマインダーの実装
  - [x] 法定期限計算ロジック（申請種別ごと）
  - [x] 事前通知（X日前、Y日前）
  - [x] 当日通知（10時くらい）
  - [x] 期限超過通知（毎日）
  - [x] 内部申請が絡む外部申請で法定期限超過時の処理（社員の申請日＋1営業日を期限とする）
  - [x] ダッシュボード読み込み時にチェック
- [x] 算定計算のリマインダー
  - [x] 算定計算を実行する時期になったら管理者へ通知を送信
  - [x] 通知内容：「算定計算を実行してください。7月10日までに計算して算定届を提出してください」等のリマインダーメッセージ
  - [x] 通知タイミング：7月1日になったら通知
  - [x] 未計算の社員がいる場合のみ通知を送信（計算済みチェック）
- [x] 月変計算のリマインダー
  - [x] 月変計算を実行する時期になったら管理者へ通知を送信
  - [x] 通知内容：「X年X月の固定賃金変動で月変計算未計算の社員がいます（社員名）。月変計算を実行してください。」
  - [x] 通知タイミング：変動月から4か月目に入ったら通知
  - [x] 未計算の社員がいる場合のみ通知を送信（計算済みチェック）
- [ ] 自動通知送信（Cloud Functions）
  - [x] 期限リマインダーの自動送信機能（ダッシュボード読み込み時にチェック）
  - [x] 算定計算リマインダーの自動送信機能（ダッシュボード読み込み時にチェック）
  - [x] 月変計算リマインダーの自動送信機能（ダッシュボード読み込み時にチェック）
  - [ ] 月次計算日の通知送信機能（設定機能実装時に実装）
- [ ] 通知タイミング設定
  - [ ] リマインダー送信タイミングの設定機能

#### 実装済み機能
- [x] 通知データモデル（`Notification`インターフェース）
- [x] 通知サービス（`NotificationService`）
  - [x] 通知の作成・取得・更新・削除
  - [x] ユーザー別通知取得
  - [x] 未読通知数のリアルタイム監視
  - [x] 既読/未読管理（個別・一括・申請単位）
  - [x] 申請ステータス変更時の通知作成ヘルパー
  - [x] 外部申請ステータス変更時の通知作成ヘルパー（受理確認・エラー通知）
- [x] 通知一覧画面（申請単位でグループ化、同一トリガーで発生した通知をまとめる）
  - [x] 申請単位でグループ化表示
  - [x] 未読通知数の表示
  - [x] フィルタ・検索機能
  - [x] 既読/未読管理機能
  - [x] 申請名クリックで申請詳細へ遷移
  - [x] 通知件数クリックで通知詳細へ遷移
- [x] 通知詳細画面
  - [x] 申請情報の表示
  - [x] 通知一覧の表示（時系列）
  - [x] 既読/未読管理機能（個別・一括）
  - [x] 申請詳細画面へのリンク
- [x] ヘッダーコンポーネントに未読通知数表示
- [x] 申請詳細コンポーネントに通知作成ロジック統合
  - [x] 申請提出時（`pending`）
  - [x] 申請承認時（`approved`）
  - [x] 申請却下時（`rejected`）
  - [x] 申請差戻し時（`returned`）
  - [x] 外部申請受理確認時（`external_received`）
  - [x] 外部申請エラー時（`external_error`）
- [x] 期限リマインダー機能
  - [x] 法定期限計算ロジック（申請種別ごと）
  - [x] 事前通知（X日前、Y日前）
  - [x] 当日通知（10時くらい）
  - [x] 期限超過通知（毎日）
  - [x] 内部申請が絡む外部申請で法定期限超過時の処理
  - [x] 設定画面の実装（/settings）
  - [x] 期限設定時の即時通知機能
    - [x] 入社日設定時：資格取得届の期限を計算して即時通知（事前通知のリマインダー日を過ぎている場合）
    - [x] 退職日設定時：資格喪失届の期限を計算して即時通知（事前通知のリマインダー日を過ぎている場合）
    - [x] 内部申請送信時：関連する外部申請の期限を計算して即時通知（被扶養者（異動）届・住所変更届・氏名変更届）
    - [x] 通知終了条件：該当社員の外部申請が外部送信（`externalApplicationStatus: 'sent'`）されたら通知終了
  - [x] 重複チェックの改善
    - [x] 各ユーザーごとの重複チェック実装（`sendDeadlineReminder`内で各`targetUserIds`のユーザーごとに重複チェックを実行）
    - [x] 申請なしの場合の期限超過通知でも各ユーザーごとの重複チェックを実装（`checkOverdueNotificationsWithoutApplication`）
  - [x] 手動送信時の重複チェックスキップ機能（テスト用）
  - [x] 算定基礎届の通知グループ化を諦める方針に変更
    - [x] `createdAt`が秒単位で異なるため、グループ化が困難であることを確認
    - [x] `isRewardBaseGroup`関連のロジックを削除し、算定基礎届の通知も個別に表示するように変更
    - [x] 通知一覧画面：各通知が個別のグループとして表示される
    - [x] 通知詳細画面：展開パネルを削除し、通常の通知一覧表示に統一
    - [x] `checkAndSendStandardRewardReminders`に`skipDuplicateCheck`パラメータを追加
    - [x] `checkAndSendMonthlyChangeReminders`に`skipDuplicateCheck`パラメータを追加
    - [x] `checkAndSendDeadlineReminders`に`skipDuplicateCheck`パラメータを追加
    - [x] `checkOverdueNotificationsWithoutApplication`に`skipDuplicateCheck`パラメータを追加
    - [x] `sendDeadlineReminder`に`skipDuplicateCheck`パラメータを追加
    - [x] `checkRemindersManually`から`skipDuplicateCheck: true`を指定して呼び出すように実装
    - [x] **テスト終了時の戻し方**: `admin-dashboard.component.ts`の`checkRemindersManually`メソッド内で、`checkReminders`の呼び出し時に`skipDuplicateCheck: true`を削除するか、`skipDuplicateCheck`パラメータを省略してデフォルト値（`false`）を使用するように変更することで、元の動作（重複チェックあり）に戻す

#### 未実装機能（設定機能実装時に実装予定）
- [ ] 月次計算日の通知
  - [ ] 組織情報に給与支払日を設定する欄を追加
  - [ ] 給与支払日をもとに月次計算日の通知を送信する機能（Cloud Functions）

---

### フェーズ8: 設定機能（2週間）

#### 8.1 組織設定
- [x] 組織情報編集
  - [x] 組織名、法人番号、事業所番号の編集
  - [x] 住所情報の編集（都道府県、市区町村、番地、建物名）
  - [x] 連絡先情報の編集（電話番号、メールアドレス、業種）
- [x] ロゴアップロード
  - [x] Firebase Storageを使用したロゴアップロード機能
  - [x] 画像プレビュー機能
  - [x] ファイルサイズ・形式チェック（最大5MB、画像ファイルのみ）
  - [x] 古いロゴの自動削除機能
- [x] 給与支払日の設定（月次計算日の通知用）
  - [x] `Organization`モデルに`payrollDate`フィールドを追加（1-31日の選択）
  - [x] 給与支払日の設定UI実装

#### 8.2 保険料・標準報酬設定
- [x] 料率設定（過去・現在・将来）
  - [x] 保険料率テーブルの一覧表示
  - [x] 適用開始年でのフィルタリング機能
  - [x] 保険料率テーブルの新規作成・編集機能
  - [x] 保険料率テーブルの削除機能
- [x] 標準報酬上限・下限設定
  - [x] 標準報酬月額の設定（等級ごと）
  - [x] 最小値・最大値の設定
- [x] CSV/Excelインポート
  - [x] CSV/Excelファイルのアップロード機能
  - [x] ファイルプレビュー機能（最初の5行）
  - [x] 保険料率テーブルの一括インポート機能

#### 8.3 申請フロー設定
- [x] 申請種別設定
  - [x] 内部申請種別の一覧表示・編集機能
  - [x] 外部申請種別の一覧表示・編集機能
  - [x] 内部申請種別の追加・削除機能（カスタム申請種別のみ削除可能）
  - [x] 申請種別の有効/無効設定
  - [x] 申請種別名・コード・説明の編集機能
- [x] 承認ルール設定
  - [x] 承認ルールの説明文編集機能（承認方法は固定：管理者のいずれか一名の承認）
- [x] 添付書類必須/任意設定
  - [x] 申請種別ごとの添付書類設定
  - [x] 許可ファイル形式の設定（PDF、画像、Excel、Word等）
  - [x] 最大ファイルサイズの設定（MB単位）
  - [x] 添付書類設定の追加・編集・削除機能

#### 8.4 通知設定
- [x] 通知タイミング設定
  - [x] 申請提出時の通知ON/OFF設定
  - [x] 承認時の通知ON/OFF設定
  - [x] 差戻し時の通知ON/OFF設定
  - [x] 却下時の通知ON/OFF設定
- [x] 通知対象設定
  - [x] 申請者への通知ON/OFF設定
  - [x] 管理者への通知ON/OFF設定
- [x] リマインダー設定
  - [x] 管理者向け：法定期限のX日前（デフォルト7日）の通知設定
  - [x] 申請者向け：管理者設定期限のY日前（デフォルト3日）の通知設定
  - [x] 期限超過、当日、事前通知の設定（設定可能）
- [ ] 月次計算日の通知設定
  - [ ] 給与支払日をもとに月次計算日の通知を送信する機能（Cloud Functions）

#### 8.5 権限設定
- [x] ロール管理
  - [x] 社員一覧の表示（権限情報を含む）
  - [x] 権限の表示（管理者/一般社員）
  - [x] オーナーの表示（権限変更不可）
- [x] 権限付与・剥奪
  - [x] 権限変更ダイアログ
  - [x] 権限変更の確認機能
  - [x] employeesコレクションとusersコレクションの両方を更新
  - [x] 現在ログイン中のユーザーの権限変更時のリアルタイム更新
- [ ] モード切替制限（将来の検討事項）
  - [ ] オーナーは一般社員モード使用不可にする機能（検討中）（←現状一般社員モードで申請作成できない。）

---

### フェーズ9: 分析機能（1-2週間）

#### 9.1 集計機能
- [ ] 部署別集計
- [ ] 申請種別別集計
- [ ] 月次・年度推移

#### 9.2 グラフ表示
- [ ] グラフライブラリ導入（Chart.js、ng2-charts等）
- [ ] 各種グラフ実装

#### 9.3 CSV出力
- [ ] 集計結果CSV出力

---

### フェーズ10: 外部連携（2週間）

#### 10.1 データインポート
- [ ] CSV/Excelインポート機能
- [ ] データ競合検出
- [ ] 差分表示・選択機能

#### 10.2 データエクスポート
- [ ] 社員選択機能
- [ ] 出力データ種別選択
- [ ] CSV/Excel出力

---

### フェーズ11: 自分の情報画面（1-2週間）

#### 11.1 情報表示
- [ ] 基本情報表示
- [ ] 扶養情報表示
- [ ] 保険料表示
- [ ] 申請ステータス表示

#### 11.2 情報編集
- [ ] 編集可能項目の編集
- [ ] 申請が必要な項目の申請作成

#### 11.3 申請作成
- [ ] 申請ボタン
- [ ] 申請フォーム遷移

---

### フェーズ12: テスト・最適化（継続的）

#### 12.1 テスト
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] E2Eテスト

#### 12.2 パフォーマンス最適化（大手企業規模対応）
- [ ] データ取得最適化
  - Firestoreインデックス最適化
  - ページネーション実装（一覧画面）
  - 必要最小限のデータ取得（フィールド選択）
  - キャッシュ戦略の実装
- [ ] 画像最適化
  - 画像リサイズ・圧縮（Storageにアップロード時）
  - 遅延読み込み（Lazy Loading）
- [ ] バンドルサイズ最適化
  - コード分割（Route-based lazy loading）
  - Tree shaking
  - 不要なライブラリの削除
- [ ] 大量データ対応
  - バッチ処理の実装（一括計算、一括インポート）
  - バックグラウンド処理の検討（Cloud Functions）
  - タイムアウト・リトライ処理

#### 12.3 セキュリティ
- [ ] Firestoreセキュリティルール
  - 組織単位でのアクセス制御
  - 権限に応じた読み書き制限
  - 既存アプリとの完全分離
- [ ] Storageセキュリティルール
  - 組織単位でのアクセス制御
  - ファイルサイズ・形式制限
  - 既存アプリとの完全分離
- [ ] 認証チェック強化
  - 各API呼び出しでの認証チェック
  - 権限チェックの徹底
  - セッション管理
- [ ] データバリデーション
  - クライアント側バリデーション
  - サーバー側（Firestore Rules）バリデーション

---

## 🗄️ データモデル設計

### Firestoreコレクション構造（確定版）

**⚠️ 重要**: すべてのコレクション名に `socialInsurance_` プレフィックスを付けて既存アプリと分離

```
socialInsurance_organizations/          # 組織（企業）
  {orgId}/
    - name: string
    - corporateNumber: string
    - address: {
        prefecture: string
        city: string
        street: string
        building: string
      }
    - phoneNumber: string
    - email: string
    - industry: string
    - logoUrl: string
    - insuranceSettings: {
        healthInsurance: {
          type: 'kyokai' | 'kumiai'
          officeNumber: string
        }
        pensionInsurance: {
          officeNumber: string
          roundingMethod: string
        }
        careInsurance: {
          targetOffice: boolean
        }
        employmentInsurance: {
          officeNumber: string
          laborInsuranceNumber: string
        }
      }
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_users/                  # ユーザー（認証情報）
  {userId}/
    - email: string
    - displayName: string
    - role: 'owner' | 'admin' | 'employee'
    - organizationId: string
    - employeeId: string | null
    - emailVerified: boolean
    - isActive: boolean
    - createdAt: timestamp
    - lastLoginAt: timestamp

socialInsurance_employees/              # 社員情報
  {employeeId}/
    - employeeNumber: string
    - name: string
    - nameKana: string
    - email: string
    - departmentId: string
    - joinDate: timestamp
    - birthDate: timestamp
    - status: 'active' | 'leave' | 'retired' | 'pre_join'
    - role: 'admin' | 'employee'  # 権限（任意、デフォルト: 'employee'）
    - dependentInfo: [{
        name: string
        nameKana: string
        birthDate: timestamp
        relationship: string
        income: number
        livingTogether: boolean
      }]
    - insuranceInfo: {
        healthInsuranceNumber: string
        pensionNumber: string
        myNumber: string
        standardReward: number
        insuranceStartDate: timestamp
      }
    - otherCompanyInfo: {
        isOtherCompany: boolean
        isPrimary: boolean
        companyName: string
      }
    - address: {
        internal: object  # 社内表示用（自由編集可）
        official: object  # 正式住所（申請制）
      }
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_departments/            # 部署
  {departmentId}/
    - name: string
    - parentDepartmentId: string | null
    - managerId: string | null
    - code: string
    - email: string
    - organizationId: string
    - createdAt: timestamp
    - updatedAt: timestamp

socialInsurance_applications/            # 申請
  {applicationId}/
    - type: string                      # 'dependent' | 'address-change' | 'leave' | ...
    - category: 'internal' | 'external'
    - employeeId: string
    - organizationId: string
    - status: 'draft' | 'pending' | 'approved' | 'rejected' | 'returned' | 'withdrawn'
    - data: object                      # 申請種別ごとのデータ
    - attachments: [{
        fileName: string
        fileUrl: string
        uploadedAt: timestamp
      }]
    - comments: [{
        userId: string
        comment: string
        type: 'comment' | 'rejection_reason'
        createdAt: timestamp
      }]
    - externalApplicationStatus: string | null  # 'sent' | 'received' | 'error'
    - deadline: timestamp | null
    - createdAt: timestamp
    - updatedAt: timestamp
    - withdrawnAt: timestamp | null

socialInsurance_calculations/            # 月次計算結果
  {calculationId}/
    - employeeId: string
    - organizationId: string
    - year: number
    - month: number
    - healthInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
      }
    - pensionInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
      }
    - careInsurance: {
        standardReward: number
        rate: number
        employeeAmount: number
        companyAmount: number
        applicable: boolean  # 40-64歳のみ
      }
    - total: {
        employeeTotal: number
        companyTotal: number
      }
    - calculationType: 'normal' | 'prorated' | 'individual'
    - calculatedAt: timestamp
    - calculatedBy: string

socialInsurance_insuranceRates/          # 保険料率マスタ
  {rateId}/
    - type: 'health' | 'pension' | 'care'
    - rate: number
    - effectiveFrom: timestamp
    - effectiveTo: timestamp | null
    - organizationId: string | null  # nullの場合は全組織共通
    - createdAt: timestamp

socialInsurance_standardRewards/          # 標準報酬等級表
  {rewardId}/
    - grade: number
    - minAmount: number
    - maxAmount: number
    - effectiveFrom: timestamp
    - effectiveTo: timestamp | null
    - createdAt: timestamp

socialInsurance_notifications/            # 通知（既存アプリのnotificationsと分離）
  {notificationId}/
    - userId: string
    - applicationId: string | null
    - type: 'application' | 'approval' | 'rejection' | 'reminder' | 'system'
    - title: string
    - message: string
    - read: boolean
    - priority: 'high' | 'medium' | 'low'
    - organizationId: string
    - createdAt: timestamp

socialInsurance_documents/               # 作成済み書類
  {documentId}/
    - type: string
    - applicationId: string | null
    - employeeId: string
    - organizationId: string
    - fileUrl: string
    - fileName: string
    - createdAt: timestamp
    - expiresAt: timestamp              # 6年後自動削除用

socialInsurance_settings/                # 組織設定
  {orgId}/
    - applicationFlow: {
        statuses: [{
          name: string
          order: number
          label: string
        }]
      }
    - notificationSettings: {
        internalDeadlineDays: number     # デフォルト3日前
        externalDeadlineDays: number     # デフォルト7日前
      }
    - documentSettings: {
        allowedFormats: string[]
        maxFileSize: number
        retentionYears: number          # デフォルト6年
      }
    - updatedAt: timestamp
```

### Storage構造（確定版）

**⚠️ 重要**: すべてのパスが `social-insurance/` で始まり、既存アプリと完全に分離

```
social-insurance/
  organizations/
    {orgId}/
      documents/
        {applicationId}/
          {fileName}                    # 申請添付書類
      logos/
        logo.{ext}                      # 組織ロゴ
  templates/
    csv/
      employee_import_template.csv      # 社員インポートテンプレート
      rate_import_template.csv          # 料率インポートテンプレート
    excel/
      employee_import_template.xlsx
      rate_import_template.xlsx
    pdf/
      insurance_acquisition_template.pdf # 被保険者資格取得届PDFテンプレート（公式）
      # その他の申請種別のPDFテンプレート（順次追加）
```

### セキュリティルール設計

#### Firestoreセキュリティルール
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 既存アプリのコレクション（変更なし）
    match /{existingCollection}/{document=**} {
      // 既存アプリのルール
    }
    
    // 新アプリのコレクション（socialInsurance_プレフィックス）
    match /socialInsurance_{collection}/{document=**} {
      // 認証済みユーザーのみアクセス可能
      allow read, write: if request.auth != null 
        && resource.data.organizationId == getUserOrganization();
      
      // 組織作成時は認証済みであればOK
      allow create: if request.auth != null 
        && request.resource.data.organizationId != null;
    }
  }
}
```

#### Storageセキュリティルール
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 既存アプリのパス（変更なし）
    match /existing_app/{allPaths=**} {
      // 既存アプリのルール
    }
    
    // 新アプリのパス（social-insurance/で始まる）
    match /social-insurance/{allPaths=**} {
      // 認証済みユーザーのみアクセス可能
      allow read, write: if request.auth != null;
    }
  }
}
```

---

## 🛠️ 技術スタック

### フロントエンド
- **Angular 18** - フレームワーク
- **TypeScript** - 言語
- **RxJS** - リアクティブプログラミング
- **Angular Material** (推奨) - UIコンポーネント
- **Tailwind CSS** (オプション) - スタイリング

### Firebase
- **Firebase Authentication** - 認証
- **Cloud Firestore** - データベース
- **Cloud Storage** - ファイルストレージ
- **Cloud Functions** (オプション) - サーバーレス関数
- **Firebase Hosting** (オプション) - ホスティング

### ライブラリ
- **@angular/fire** - Firebase統合
- **@angular/material** - UIコンポーネント（確定）
- **jsPDF / pdfmake** - PDF生成
- **xlsx / papaparse** - Excel/CSV処理
- **Chart.js / ng2-charts** - グラフ表示
- **date-fns** - 日付処理
- **rxjs** - リアクティブプログラミング（Angular標準）

### パフォーマンス考慮事項（大手企業規模）
- **Firestoreインデックス**: 大量データ検索に対応
- **ページネーション**: 一覧画面は20-50件ずつ表示
- **バッチ処理**: 一括計算・一括インポートはバッチ処理
- **キャッシュ戦略**: 頻繁にアクセスするデータはキャッシュ
- **コード分割**: ルートベースの遅延読み込み

---

## ❓ 確認事項

### 1. Firebaseプロジェクトについて
- [ ] 既存のFirebaseプロジェクトIDは何ですか？→「kensyu10119」
- [ ] 既存アプリのデータ構造はどうなっていますか？（コレクション名など）→「commentReadStatus、notifications、projects、tasks、teamInvitations、teams、users」
- [ ] 既存アプリとの完全分離が必要ですか？それともコレクション分離で十分ですか？→コレクション分離でいいかな
→あと、strageの分離もフォルダを分ける形でお願いしたい

### 2. 認証について
- [ ] 既存アプリと同じ認証システムを使用しますか？→うーん、ちょっと変えた方がいい気がする。
- [ ] メール認証の送信元アドレスは設定済みですか？→わかんない

### 3. UI/UXについて
- [ ] UIフレームワークはAngular Materialを使用しますか？それとも独自スタイル？→使用する
- [ ] レスポンシブデザインは必要ですか？→PC向けのみで作るので不要

### 4. 外部連携について
- [x] 給与システムとの連携フォーマットは決まっていますか？→カタログに書いてある通りにお願い
  - **入力データ**: 従業員マスタ、月額給与・賞与額、勤務日数・欠勤日数・残業時間、出勤日数・勤務時間、休職日数・休暇取得状況、社員からの申請情報、休職・育休・介護休暇ステータス、雇用保険加入情報、雇用保険料計算結果
  - **出力データ**: 健康保険料、厚生年金保険料、介護保険料、保険料計算に使用した標準報酬月額や基礎情報、社内承認結果、更新済み社員情報の通知、社員基本情報、雇用形態情報、退職情報、休職情報、被扶養者情報
- [x] CSV/Excelのテンプレートは提供されますか？→最適なテンプレートをサンプルとして表示したい
  - テンプレートファイルを `assets/templates/` に配置
  - インポート画面でテンプレートダウンロードボタンを表示
  - サンプルデータを含むテンプレートを提供

### 5. パフォーマンスについて
- [x] 想定ユーザー数はどのくらいですか？→一応大手企業でも使える形がいい
  - **想定**: 最大10,000社員規模の企業に対応
  - **対策**: ページネーション、インデックス最適化、バッチ処理
- [x] 同時接続数の目安はありますか？→同上
  - **想定**: 同時100-500ユーザー
  - **対策**: Firestoreの同時接続制限を考慮した設計、キャッシュ戦略

### 6. セキュリティについて
- [ ] 特定のIPアドレスからのアクセス制限は必要ですか？→不要
- [ ] 2要素認証は必要ですか？→不要のつもり

### 7. 開発環境について
- [ ] 開発用と本番用でFirebaseプロジェクトを分けますか？→わけない
- [ ] CI/CDパイプラインは必要ですか？→不要

---

---

## 📋 実装前のチェックリスト

### Firebase設定
- [ ] Firebase Consoleでプロジェクト `kensyu10119` にアクセス
- [ ] 新規Webアプリ `social-insurance-management-app` を追加
- [ ] Firebase設定情報（apiKey, authDomain等）を取得
- [ ] Authentication > Sign-in method でメール/パスワードを有効化
- [ ] Authentication > Templates でメール認証テンプレートを確認・設定
- [ ] Firestore Database でインデックス作成（後で必要に応じて）
- [ ] Storage でセキュリティルールを設定

### 開発環境準備
- [ ] Node.js、npm がインストール済み
- [ ] Angular CLI がインストール済み
- [ ] Firebase CLI がインストール済み（オプション）
- [ ] Git リポジトリの準備（オプション）

### プロジェクト設定
- [ ] `environment.ts` にFirebase設定を追加
- [ ] `package.json` に必要なライブラリを追加
- [ ] Angular Material をインストール
- [ ] プロジェクト構造を作成

---

## 📝 次のステップ

1. ✅ **確認事項への回答** - 完了
2. **Firebaseプロジェクト設定** - 実施が必要
   - Firebase Consoleで新規Webアプリを追加
   - 設定情報を取得して `environment.ts` に追加
3. **フェーズ1（基盤構築）**から実装開始
   - Firebase SDKインストール
   - 認証基盤構築
   - 基本レイアウト作成

---

## ⚠️ 重要な注意事項

### データ分離について
- **Firestore**: すべてのコレクション名に `socialInsurance_` プレフィックスを付ける
- **Storage**: すべてのパスが `social-insurance/` で始まる
- **認証**: 既存アプリとは独立した認証フローを使用
- **セキュリティルール**: 既存アプリと新アプリを完全に分離

### パフォーマンスについて
- 大手企業規模を想定した設計
- ページネーション、インデックス最適化、バッチ処理を実装
- 大量データ処理に対応

### メール認証について
- Firebase Console > Authentication > Templates でメール認証テンプレートを設定
- 送信元アドレスの設定が必要（後で確認）

### Employeeモデルの変更（フェーズ4実装時）
- **変更内容**: `name`/`nameKana` → `firstName`/`lastName`/`firstNameKana`/`lastNameKana`に変更
- **address.internal**: コメントアウト（`address.official`のみ使用）
- **後方互換性**: 既存データの`name`/`nameKana`は自動的に分割される（`EmployeeService.convertToEmployee`で処理）
- **影響範囲**: 
  - `employee-create`, `employee-edit`, `employee-import`コンポーネントのフォーム構造変更
  - 社員一覧・詳細画面の表示変更
  - 申請作成・編集画面での社員選択時の自動入力処理変更
- **マイグレーション**: 既存データは自動変換されるため、手動マイグレーションは不要

実装を開始する準備ができましたら、お知らせください！


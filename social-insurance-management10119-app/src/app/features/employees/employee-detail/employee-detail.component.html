<div class="employee-detail-container" *ngIf="!isLoading && employee">
  <mat-card>
    <mat-card-header>
      <div class="header-content">
        <div>
          <mat-card-title>
            <mat-icon>person</mat-icon>
            {{ employee.lastName }} {{ employee.firstName }} の詳細情報
          </mat-card-title>
          <mat-card-subtitle>
            <mat-chip [color]="getStatusColor(employee.status)">
              {{ getStatusLabel(employee.status) }}
            </mat-chip>
            <mat-chip *ngIf="!employee.invitationEmailSent" color="warn" style="margin-left: 8px;">
              <mat-icon style="font-size: 16px; height: 16px; width: 16px;">mail_outline</mat-icon>
              未送信
            </mat-chip>
          </mat-card-subtitle>
        </div>
        <div class="header-actions">
          <button mat-raised-button color="accent" (click)="inviteEmployee()" [disabled]="isInviting">
            <mat-icon>mail</mat-icon>
            {{ isInviting ? '送信中...' : '招待メール送信' }}
          </button>
          <button mat-raised-button color="primary" (click)="editEmployee()">
            <mat-icon>edit</mat-icon>
            編集
          </button>
          <button mat-raised-button color="warn" (click)="deleteEmployee()">
            <mat-icon>delete</mat-icon>
            削除
          </button>
          <button mat-button (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
            戻る
          </button>
        </div>
      </div>
    </mat-card-header>
    <mat-card-content>
      <mat-tab-group>
        <!-- 基本情報タブ -->
        <mat-tab label="基本情報">
          <div class="tab-content">
            <mat-list>
              <mat-list-item>
                <span matListItemTitle>社員番号</span>
                <span matListItemLine>{{ employee.employeeNumber }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>氏名</span>
                <span matListItemLine>{{ employee.lastName }} {{ employee.firstName }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>氏名カナ</span>
                <span matListItemLine>{{ employee.lastNameKana }} {{ employee.firstNameKana }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>メールアドレス</span>
                <span matListItemLine>{{ employee.email }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>部署</span>
                <span matListItemLine>{{ department?.name || '未設定' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>入社日</span>
                <span matListItemLine>{{ formatDate(employee.joinDate) }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>生年月日</span>
                <span matListItemLine>{{ formatDate(employee.birthDate) }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>ステータス</span>
                <span matListItemLine>
                  <mat-chip [color]="getStatusColor(employee.status)">
                    {{ getStatusLabel(employee.status) }}
                  </mat-chip>
                </span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>権限</span>
                <span matListItemLine>
                  <mat-chip [color]="getRoleColor(employee.role)">
                    {{ getRoleLabel(employee.role) }}
                  </mat-chip>
                  <button *ngIf="isAdmin()" mat-icon-button (click)="editRole()" matTooltip="権限を編集">
                    <mat-icon>edit</mat-icon>
                  </button>
                </span>
              </mat-list-item>
              <mat-divider></mat-divider>
            </mat-list>
            
            <!-- 休職情報セクション -->
            <div class="leave-info-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px;">休職情報</h3>
              <div *ngIf="employee.leaveInfo && employee.leaveInfo.length > 0; else noLeaveInfo">
                <mat-list>
                  <mat-list-item *ngFor="let leave of employee.leaveInfo; let i = index">
                    <div class="leave-item" style="width: 100%;">
                      <h4 style="margin-bottom: 8px;">休職情報 {{ i + 1 }}</h4>
                      <mat-list>
                        <mat-list-item>
                          <span matListItemTitle>休職種別</span>
                          <span matListItemLine>{{ getLeaveTypeLabel(leave.type) }}</span>
                        </mat-list-item>
                        <mat-divider></mat-divider>
                        <mat-list-item>
                          <span matListItemTitle>休職開始（予定）日</span>
                          <span matListItemLine>{{ formatDate(leave.startDate) }}</span>
                        </mat-list-item>
                        <mat-divider></mat-divider>
                        <mat-list-item>
                          <span matListItemTitle>休職終了（予定）日</span>
                          <span matListItemLine>{{ formatDate(leave.endDate) || '未設定' }}</span>
                        </mat-list-item>
                        <mat-divider></mat-divider>
                        <mat-list-item>
                          <span matListItemTitle>申請承認済み</span>
                          <span matListItemLine>
                            <mat-chip [color]="leave.isApproved ? 'primary' : 'warn'">
                              {{ leave.isApproved ? '承認済み' : '未承認' }}
                            </mat-chip>
                          </span>
                        </mat-list-item>
                      </mat-list>
                    </div>
                    <mat-divider *ngIf="i < employee.leaveInfo!.length - 1" style="margin-top: 16px;"></mat-divider>
                  </mat-list-item>
                </mat-list>
              </div>
              <ng-template #noLeaveInfo>
                <p class="no-data">休職情報が登録されていません</p>
              </ng-template>
            </div>
          </div>
        </mat-tab>

        <!-- 保険情報タブ -->
        <mat-tab label="保険情報">
          <div class="tab-content">
            <mat-list *ngIf="employee.insuranceInfo; else noInsuranceInfo">
              <mat-list-item>
                <span matListItemTitle>健康保険被保険者番号</span>
                <span matListItemLine>{{ employee.insuranceInfo.healthInsuranceNumber || '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>厚生年金被保険者番号</span>
                <span matListItemLine>{{ employee.insuranceInfo.pensionNumber || '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>マイナンバー</span>
                <span matListItemLine>{{ employee.insuranceInfo.myNumber || '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>平均報酬月額</span>
                <span matListItemLine>{{ employee.insuranceInfo.averageReward ? (employee.insuranceInfo.averageReward | number) + '円' : '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>健康保険等級</span>
                <span matListItemLine>{{ employee.insuranceInfo.grade || '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>厚生年金等級</span>
                <span matListItemLine>{{ employee.insuranceInfo.pensionGrade || '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>標準報酬月額</span>
                <span matListItemLine>{{ employee.insuranceInfo.standardReward ? (employee.insuranceInfo.standardReward | number) + '円' : '-' }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>保険適用開始日</span>
                <span matListItemLine>{{ formatDate(employee.insuranceInfo.insuranceStartDate) }}</span>
              </mat-list-item>
              <mat-divider></mat-divider>
              <mat-list-item>
                <span matListItemTitle>等級・標準報酬月額適用年月日</span>
                <span matListItemLine>{{ formatDate(employee.insuranceInfo.gradeAndStandardRewardEffectiveDate) || '-' }}</span>
              </mat-list-item>
            </mat-list>
            <ng-template #noInsuranceInfo>
              <p class="no-data">保険情報が登録されていません</p>
            </ng-template>
          </div>
        </mat-tab>

        <!-- 扶養情報タブ -->
        <mat-tab label="扶養情報">
          <div class="tab-content">
            <div *ngIf="employee.dependentInfo && employee.dependentInfo.length > 0; else noDependentInfo">
              <mat-list>
                <mat-list-item *ngFor="let dependent of employee.dependentInfo; let i = index">
                  <div class="dependent-item">
                    <h4>扶養者 {{ i + 1 }}</h4>
                    <mat-list>
                      <mat-list-item>
                        <span matListItemTitle>氏名</span>
                        <span matListItemLine>{{ dependent.name }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>氏名カナ</span>
                        <span matListItemLine>{{ dependent.nameKana }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>生年月日</span>
                        <span matListItemLine>{{ formatDate(dependent.birthDate) }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>続柄</span>
                        <span matListItemLine>{{ dependent.relationship }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>年収</span>
                        <span matListItemLine>{{ dependent.income ? (dependent.income | number) + '円' : '-' }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>同一世帯</span>
                        <span matListItemLine>{{ dependent.livingTogether ? 'はい' : 'いいえ' }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <mat-list-item>
                        <span matListItemTitle>被扶養者になった年月日</span>
                        <span matListItemLine>{{ formatDate(dependent.becameDependentDate) || '-' }}</span>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                    </mat-list>
                  </div>
                  <mat-divider *ngIf="i < employee.dependentInfo!.length - 1"></mat-divider>
                </mat-list-item>
              </mat-list>
            </div>
            <ng-template #noDependentInfo>
              <p class="no-data">扶養情報が登録されていません</p>
            </ng-template>
          </div>
        </mat-tab>

        <!-- 他社勤務情報タブ -->
        <mat-tab label="他社勤務情報">
          <div class="tab-content">
            <div *ngIf="employee.otherCompanyInfo && employee.otherCompanyInfo.length > 0; else noOtherCompanyInfo">
              <div class="header-actions" style="margin-bottom: 16px;">
                <button mat-raised-button color="primary" (click)="goToOtherCompanySalaryInput()">
                  <mat-icon>work</mat-icon>
                  他社給与入力
                </button>
              </div>
              <mat-list *ngFor="let company of employee.otherCompanyInfo; let i = index">
                <h4 *ngIf="employee.otherCompanyInfo!.length > 1">他社 {{ i + 1 }}</h4>
                <mat-list-item>
                  <span matListItemTitle>会社名</span>
                  <span matListItemLine>{{ company.companyName || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>主たる勤務先</span>
                  <span matListItemLine>{{ company.isPrimary ? 'はい' : 'いいえ' }}</span>
                </mat-list-item>
                <mat-divider *ngIf="i < employee.otherCompanyInfo!.length - 1"></mat-divider>
              </mat-list>
            </div>
            <ng-template #noOtherCompanyInfo>
              <p class="no-data">他社勤務情報が登録されていません</p>
            </ng-template>
          </div>
        </mat-tab>

        <!-- 住所情報タブ -->
        <mat-tab label="住所情報">
          <div class="tab-content">
            <!-- 社内表示用住所はコメントアウト（address.officialのみ使用） -->
            <!-- <div *ngIf="employee.address?.internal; else noAddressInfo">
              <h4>社内表示用住所</h4>
              <mat-list>
                <mat-list-item>
                  <span matListItemTitle>郵便番号</span>
                  <span matListItemLine>{{ employee.address?.internal?.postalCode || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>都道府県</span>
                  <span matListItemLine>{{ employee.address?.internal?.prefecture || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>市区町村</span>
                  <span matListItemLine>{{ employee.address?.internal?.city || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>町名・番地</span>
                  <span matListItemLine>{{ employee.address?.internal?.street || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>建物名・部屋番号</span>
                  <span matListItemLine>{{ employee.address?.internal?.building || '-' }}</span>
                </mat-list-item>
              </mat-list>
            </div> -->
            <div *ngIf="employee.address?.official; else noAddressInfo">
              <h4>正式住所</h4>
              <mat-list>
                <mat-list-item>
                  <span matListItemTitle>郵便番号</span>
                  <span matListItemLine>{{ employee.address?.official?.postalCode || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>都道府県</span>
                  <span matListItemLine>{{ employee.address?.official?.prefecture || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>市区町村</span>
                  <span matListItemLine>{{ employee.address?.official?.city || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>町名・番地</span>
                  <span matListItemLine>{{ employee.address?.official?.street || '-' }}</span>
                </mat-list-item>
                <mat-divider></mat-divider>
                <mat-list-item>
                  <span matListItemTitle>建物名・部屋番号</span>
                  <span matListItemLine>{{ employee.address?.official?.building || '-' }}</span>
                </mat-list-item>
              </mat-list>
            </div>
            <ng-template #noAddressInfo>
              <p class="no-data">住所情報が登録されていません</p>
            </ng-template>
          </div>
        </mat-tab>

        <!-- 変更履歴タブ -->
        <mat-tab label="変更履歴">
          <div class="tab-content">
            <div *ngIf="employee.changeHistory && employee.changeHistory.length > 0; else noChangeHistory">
              <mat-accordion>
                <mat-expansion-panel *ngFor="let history of getSortedChangeHistory(); let i = index">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{ history.applicationName }}
                    </mat-panel-title>
                    <mat-panel-description>
                      {{ formatDate(history.changedAt) }}
                    </mat-panel-description>
                  </mat-expansion-panel-header>
                  <div class="change-history-content">
                    <div *ngFor="let change of history.changes" class="change-item">
                      <h4>{{ getFieldLabel(change.field) }}</h4>
                      <div class="change-details">
                        <div class="change-before">
                          <strong>変更前:</strong>
                          <pre>{{ formatChangeValue(change.before) }}</pre>
                        </div>
                        <div class="change-after">
                          <strong>変更後:</strong>
                          <pre>{{ formatChangeValue(change.after) }}</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>
            <ng-template #noChangeHistory>
              <p class="no-data">変更履歴がありません</p>
            </ng-template>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="isLoading" class="loading-container">
  <mat-icon>hourglass_empty</mat-icon>
  <p>読み込み中...</p>
</div>


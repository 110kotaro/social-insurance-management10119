<div class="employee-create-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>person_add</mat-icon>
        社員登録
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-stepper #stepper [linear]="true" [selectedIndex]="0">
        <!-- ステップ1: 基本情報 -->
        <mat-step [stepControl]="basicInfoForm">
          <ng-template matStepLabel>基本情報</ng-template>
          <form [formGroup]="basicInfoForm">
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>社員番号</mat-label>
                <input matInput formControlName="employeeNumber" required>
                <mat-error *ngIf="basicInfoForm.get('employeeNumber')?.hasError('required')">
                  社員番号を入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>氏</mat-label>
                <input matInput formControlName="lastName" required>
                <mat-error *ngIf="basicInfoForm.get('lastName')?.hasError('required')">
                  氏を入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>名</mat-label>
                <input matInput formControlName="firstName" required>
                <mat-error *ngIf="basicInfoForm.get('firstName')?.hasError('required')">
                  名を入力してください
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>氏カナ</mat-label>
                <input matInput formControlName="lastNameKana" required>
                <mat-error *ngIf="basicInfoForm.get('lastNameKana')?.hasError('required')">
                  氏カナを入力してください
                </mat-error>
                <mat-error *ngIf="basicInfoForm.get('lastNameKana')?.hasError('katakana')">
                  カタカナで入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>名カナ</mat-label>
                <input matInput formControlName="firstNameKana" required>
                <mat-error *ngIf="basicInfoForm.get('firstNameKana')?.hasError('required')">
                  名カナを入力してください
                </mat-error>
                <mat-error *ngIf="basicInfoForm.get('firstNameKana')?.hasError('katakana')">
                  カタカナで入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>メールアドレス</mat-label>
                <input matInput type="email" formControlName="email" required>
                <mat-error *ngIf="basicInfoForm.get('email')?.hasError('required')">
                  メールアドレスを入力してください
                </mat-error>
                <mat-error *ngIf="basicInfoForm.get('email')?.hasError('email')">
                  有効なメールアドレスを入力してください
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>部署</mat-label>
                <mat-select formControlName="departmentId" required>
                  <mat-option *ngFor="let dept of departments" [value]="dept.id">
                    {{ dept.name }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="basicInfoForm.get('departmentId')?.hasError('required')">
                  部署を選択してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>入社日</mat-label>
                <input matInput [matDatepicker]="picker1" formControlName="joinDate" required>
                <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle>
                <mat-datepicker #picker1></mat-datepicker>
                <mat-error *ngIf="basicInfoForm.get('joinDate')?.hasError('required')">
                  入社日を選択してください
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>生年月日</mat-label>
                <input matInput [matDatepicker]="pickerBirthDate" formControlName="birthDate" required>
                <mat-datepicker-toggle matIconSuffix [for]="pickerBirthDate"></mat-datepicker-toggle>
                <mat-datepicker #pickerBirthDate></mat-datepicker>
                <mat-error *ngIf="basicInfoForm.get('birthDate')?.hasError('required')">
                  生年月日を選択してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>ステータス</mat-label>
                <mat-select formControlName="status" required>
                  <mat-option value="active">在籍</mat-option>
                  <mat-option value="leave">休職</mat-option>
                  <mat-option value="retired">退職</mat-option>
                  <mat-option value="pre_join">未入社</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>退職（予定）日</mat-label>
                <input matInput [matDatepicker]="pickerRetirementDate" formControlName="retirementDate">
                <mat-datepicker-toggle matIconSuffix [for]="pickerRetirementDate"></mat-datepicker-toggle>
                <mat-datepicker #pickerRetirementDate></mat-datepicker>
                <mat-hint>任意項目です。申請時に使用されます。</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>権限</mat-label>
                <mat-select formControlName="role" required>
                  <mat-option value="employee">一般社員</mat-option>
                  <mat-option *ngIf="isAdmin()" value="admin">管理者</mat-option>
                </mat-select>
                <mat-hint>管理者のみ管理者権限を設定できます</mat-hint>
              </mat-form-field>
            </div>

            <div class="button-group">
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep1Submit()" [disabled]="basicInfoForm.invalid">
                次へ
              </button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ2: 保険情報 -->
        <mat-step>
          <ng-template matStepLabel>保険情報</ng-template>
          <form [formGroup]="insuranceInfoForm">
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>被保険者整理番号（健康保険）</mat-label>
                <input matInput formControlName="healthInsuranceNumber">
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>基礎年金番号</mat-label>
                <input matInput formControlName="pensionNumber">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>マイナンバー</mat-label>
                <input matInput formControlName="myNumber">
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>平均報酬月額</mat-label>
                <input matInput type="number" formControlName="averageReward" (blur)="onAverageRewardBlur()">
                <mat-hint>入力すると等級と標準報酬月額が自動計算されます</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>健康保険等級</mat-label>
                <input matInput type="number" formControlName="grade" (blur)="onGradeBlur()">
                <mat-hint>入力すると標準報酬月額が自動計算されます</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>厚生年金等級</mat-label>
                <input matInput type="number" formControlName="pensionGrade">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>標準報酬月額</mat-label>
                <input matInput type="number" formControlName="standardReward" (blur)="onStandardRewardBlur()">
                <mat-hint>入力すると等級が自動計算されます</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>保険適用開始日</mat-label>
                <input matInput [matDatepicker]="picker2" formControlName="insuranceStartDate">
                <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle>
                <mat-datepicker #picker2></mat-datepicker>
              </mat-form-field>
            </div>

            <div class="button-group">
              <button mat-button type="button" (click)="stepper.previous()">戻る</button>
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep2Submit()">次へ</button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ3: 扶養情報 -->
        <mat-step>
          <ng-template matStepLabel>扶養情報</ng-template>
          <form [formGroup]="dependentInfoForm">
            <div class="dependents-section">
              <div class="section-header">
                <h3>扶養者</h3>
                <button mat-raised-button type="button" (click)="addDependent()">
                  <mat-icon>add</mat-icon>
                  扶養者を追加
                </button>
              </div>

              <div formArrayName="dependents" class="dependents-list">
                <div *ngFor="let dependent of dependentsFormArray.controls; let i = index" 
                     [formGroupName]="i" class="dependent-item">
                  <mat-card>
                    <mat-card-content>
                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>氏</mat-label>
                          <input matInput formControlName="lastName" required>
                          <mat-error *ngIf="dependent.get('lastName')?.hasError('required')">
                            氏を入力してください
                          </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>名</mat-label>
                          <input matInput formControlName="firstName" required>
                          <mat-error *ngIf="dependent.get('firstName')?.hasError('required')">
                            名を入力してください
                          </mat-error>
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>氏（カナ）</mat-label>
                          <input matInput formControlName="lastNameKana" required>
                          <mat-error *ngIf="dependent.get('lastNameKana')?.hasError('required')">
                            氏（カナ）を入力してください
                          </mat-error>
                          <mat-error *ngIf="dependent.get('lastNameKana')?.hasError('katakana')">
                            カタカナで入力してください
                          </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>名（カナ）</mat-label>
                          <input matInput formControlName="firstNameKana" required>
                          <mat-error *ngIf="dependent.get('firstNameKana')?.hasError('required')">
                            名（カナ）を入力してください
                          </mat-error>
                          <mat-error *ngIf="dependent.get('firstNameKana')?.hasError('katakana')">
                            カタカナで入力してください
                          </mat-error>
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>生年月日</mat-label>
                          <input matInput [matDatepicker]="picker3" formControlName="birthDate" required>
                          <mat-datepicker-toggle matIconSuffix [for]="picker3"></mat-datepicker-toggle>
                          <mat-datepicker #picker3></mat-datepicker>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>続柄</mat-label>
                          <mat-select formControlName="relationship" required>
                            <mat-option *ngFor="let rel of relationshipOptions" [value]="rel.value">
                              {{ rel.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field *ngIf="dependent.get('relationship')?.value === 'other'" appearance="outline" class="form-field">
                          <mat-label>続柄（その他）</mat-label>
                          <textarea matInput formControlName="relationshipOther" rows="2" required></textarea>
                        </mat-form-field>
                      </div>

                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>年収</mat-label>
                          <input matInput type="number" formControlName="income">
                        </mat-form-field>

                        <mat-checkbox formControlName="livingTogether">同一世帯</mat-checkbox>
                      </div>

                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>被扶養者になった年月日</mat-label>
                          <input matInput [matDatepicker]="pickerDependentDate" formControlName="becameDependentDate">
                          <mat-datepicker-toggle matIconSuffix [for]="pickerDependentDate"></mat-datepicker-toggle>
                          <mat-datepicker #pickerDependentDate></mat-datepicker>
                        </mat-form-field>
                      </div>

                      <div class="dependent-actions">
                        <button mat-icon-button type="button" (click)="removeDependent(i)" color="warn">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>

                <div *ngIf="dependentsFormArray.length === 0" class="no-dependents">
                  <p>扶養者が登録されていません</p>
                </div>
              </div>
            </div>

            <div class="button-group">
              <button mat-button type="button" (click)="stepper.previous()">戻る</button>
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep3Submit()">次へ</button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ4: 他社勤務情報 -->
        <mat-step>
          <ng-template matStepLabel>他社勤務情報</ng-template>
          <form [formGroup]="otherCompanyForm">
            <div class="other-company-section">
              <div class="section-header">
                <h3>他社勤務情報</h3>
                <button mat-raised-button type="button" (click)="addOtherCompany()">
                  <mat-icon>add</mat-icon>
                  他社を追加
                </button>
              </div>

              <div formArrayName="companies" class="other-company-list">
                <div *ngFor="let company of otherCompanyFormArray.controls; let i = index" 
                     [formGroupName]="i" class="other-company-item">
                  <mat-card>
                    <mat-card-content>
                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>会社名</mat-label>
                          <input matInput formControlName="companyName" required>
                          <mat-error *ngIf="company.get('companyName')?.hasError('required')">
                            会社名を入力してください
                          </mat-error>
                        </mat-form-field>

                        <mat-checkbox formControlName="isPrimary">
                          主たる勤務先
                        </mat-checkbox>
                      </div>

                      <div class="other-company-actions">
                        <button mat-icon-button type="button" (click)="removeOtherCompany(i)" color="warn">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>

                <div *ngIf="otherCompanyFormArray.length === 0" class="no-other-company">
                  <p>他社勤務情報が登録されていません</p>
                </div>
              </div>
            </div>

            <div class="button-group">
              <button mat-button type="button" (click)="stepper.previous()">戻る</button>
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep4Submit()">次へ</button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ5: 住所情報 -->
        <mat-step>
          <ng-template matStepLabel>住所情報</ng-template>
          <form [formGroup]="addressForm">
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>郵便番号</mat-label>
                <input matInput formControlName="postalCode" placeholder="例: 123-4567" required>
                <mat-error *ngIf="addressForm.get('postalCode')?.hasError('required')">
                  郵便番号を入力してください
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>都道府県</mat-label>
                <input matInput formControlName="prefecture" required>
                <mat-error *ngIf="addressForm.get('prefecture')?.hasError('required')">
                  都道府県を入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>市区町村</mat-label>
                <input matInput formControlName="city" required>
                <mat-error *ngIf="addressForm.get('city')?.hasError('required')">
                  市区町村を入力してください
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>町名・番地</mat-label>
                <input matInput formControlName="street" required>
                <mat-error *ngIf="addressForm.get('street')?.hasError('required')">
                  町名・番地を入力してください
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>建物名・部屋番号</mat-label>
                <input matInput formControlName="building">
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>住所（カナ）</mat-label>
                <input matInput formControlName="kana" placeholder="例: トウキョウトシブヤク">
              </mat-form-field>
            </div>

            <div class="button-group">
              <button mat-button type="button" (click)="stepper.previous()">戻る</button>
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep5Submit()">次へ</button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ6: 休職情報 -->
        <mat-step>
          <ng-template matStepLabel>休職情報</ng-template>
          <form [formGroup]="leaveInfoForm">
            <div formArrayName="leaveInfo">
              <div *ngFor="let leave of leaveInfoFormArray.controls; let i = index" [formGroupName]="i" class="leave-info-item" style="margin-bottom: 24px; padding: 16px; border: 1px solid #e0e0e0; border-radius: 4px;">
                <h4 style="margin-bottom: 16px;">休職情報 {{ i + 1 }}</h4>
                
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>休職種別</mat-label>
                    <mat-select formControlName="type" required>
                      <mat-option value="maternity">産前産後休業</mat-option>
                      <mat-option value="childcare">育児休業</mat-option>
                      <mat-option value="other">その他</mat-option>
                    </mat-select>
                    <mat-error *ngIf="leave.get('type')?.hasError('required')">
                      休職種別を選択してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>休職開始（予定）日</mat-label>
                    <input matInput [matDatepicker]="startPicker" formControlName="startDate" required>
                    <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                    <mat-error *ngIf="leave.get('startDate')?.hasError('required')">
                      休職開始（予定）日を入力してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>休職終了（予定）日</mat-label>
                    <input matInput [matDatepicker]="endPicker" formControlName="endDate">
                    <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-checkbox formControlName="isApproved">申請承認済み</mat-checkbox>
                </div>

                <div class="button-group" style="margin-top: 8px;">
                  <button mat-icon-button type="button" color="warn" (click)="removeLeaveInfo(i)" *ngIf="leaveInfoFormArray.length > 1">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <div class="button-group" style="margin-top: 16px;">
              <button mat-raised-button type="button" (click)="addLeaveInfo()">
                <mat-icon>add</mat-icon>
                休職情報を追加
              </button>
            </div>

            <div class="button-group" style="margin-top: 24px;">
              <button mat-button type="button" (click)="stepper.previous()">戻る</button>
              <button mat-button type="button" (click)="cancel()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="onStep6Submit()" [disabled]="isLoading">
                <mat-icon *ngIf="isLoading">hourglass_empty</mat-icon>
                {{ isLoading ? '登録中...' : '登録' }}
              </button>
            </div>
          </form>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
  </mat-card>
</div>


<div class="dashboard-container">
  <!-- セットアップガイド -->
  <mat-card *ngIf="showSetupGuide" class="setup-guide-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>checklist</mat-icon>
        セットアップガイド
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="setup-description">初回セットアップを完了するために、以下の項目を順番に設定してください。</p>
      
      <mat-list>
        <mat-list-item *ngFor="let task of setupTasks" [class.completed-task]="task.completed">
          <mat-checkbox [checked]="task.completed" [disabled]="true"></mat-checkbox>
          <span class="task-label" [class.completed]="task.completed">{{ task.label }}</span>
        </mat-list-item>
      </mat-list>

      <div class="button-group">
        <button mat-raised-button color="primary" (click)="navigateToSetup()">
          <mat-icon>arrow_forward</mat-icon>
          セットアップウィザードを開始
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- 通常のダッシュボードコンテンツ -->
  <mat-card *ngIf="!showSetupGuide">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>dashboard</mat-icon>
        ダッシュボード
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="welcome-section">
        <p>ようこそ、{{ currentUser?.displayName || currentUser?.email }}さん</p>
      </div>

      <div class="dashboard-content">
    <!-- ローディング表示 -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>データを読み込み中...</p>
    </div>

    <!-- 管理者モードのダッシュボード -->
    <div *ngIf="!isLoading && isAdminMode" class="dashboard-grid">
      <!-- 必須①：要対応サマリー -->
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>warning</mat-icon>
            要対応サマリー
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="summary-items">
            <div 
              class="summary-item clickable" 
              (click)="navigateToApplications({ status: 'pending', category: 'internal' })"
              *ngIf="pendingInternalApplicationsCount > 0">
              <div class="summary-item-icon pending">
                <mat-icon>description</mat-icon>
              </div>
              <div class="summary-item-content">
                <div class="summary-item-label">未承認の内部申請</div>
                <div class="summary-item-value">{{ pendingInternalApplicationsCount }}件</div>
              </div>
            </div>
            
            <!-- 【修正20】期限超過・期限間近の申請は期限・リマインダーセクションに移動 -->
            
            <div 
              class="summary-item clickable" 
              (click)="navigateToCalculations()"
              *ngIf="unconfirmedCalculationsCount > 0">
              <div class="summary-item-icon calculation">
                <mat-icon>calculate</mat-icon>
              </div>
              <div class="summary-item-content">
                <div class="summary-item-label">計算未確定の保険料</div>
                <div class="summary-item-value">{{ unconfirmedCalculationsCount }}件</div>
              </div>
            </div>
            
            <!-- 【修正20】未提出申請（申請種別ごと） -->
            <div *ngFor="let item of unsubmittedApplicationsByType" class="summary-item clickable" 
                 (click)="navigateToApplicationsByType(item.typeId, ['draft', 'created', 'returned'])">
              <div class="summary-item-icon pending">
                <mat-icon>description</mat-icon>
              </div>
              <div class="summary-item-content">
                <div class="summary-item-label">{{ item.typeName }}（未提出）</div>
                <div class="summary-item-value">{{ item.count }}件</div>
              </div>
            </div>
            
            <div class="summary-item no-items" *ngIf="pendingInternalApplicationsCount === 0 && unconfirmedCalculationsCount === 0 && (!unsubmittedApplicationsByType || unsubmittedApplicationsByType.length === 0)">
              <mat-icon>check_circle</mat-icon>
              <span>対応が必要な項目はありません</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 必須②：期限・リマインダー系 -->
      <mat-card class="deadline-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>schedule</mat-icon>
            期限・リマインダー
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- 【修正20】申請種別ごとの期限超過・期限5日以内件数 -->
          <div class="deadline-section" *ngIf="overdueApplicationsByType.length > 0">
            <div class="summary-items" style="display: flex; flex-direction: column; gap: 8px;">
              <div *ngFor="let item of overdueApplicationsByType" class="summary-item clickable" 
                   (click)="navigateToApplicationsByType(item.typeId, [])">
                <div class="summary-item-icon deadline">
                  <mat-icon>{{ item.overdueCount > 0 ? 'error' : 'schedule' }}</mat-icon>
                </div>
                <div class="summary-item-content">
                  <div class="summary-item-label">{{ item.typeName }}</div>
                  <div class="summary-item-value">
                    <span *ngIf="item.overdueCount > 0">期限超過：{{ item.overdueCount }}件</span>
                    <span *ngIf="item.overdueCount > 0 && item.nearDeadlineCount > 0">、</span>
                    <span *ngIf="item.nearDeadlineCount > 0">期限5日以内：{{ item.nearDeadlineCount }}件</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 直近の期限アラート -->
          <div *ngIf="recentDeadlineAlerts.length > 0" class="deadline-section">
            <h4>直近の期限アラート</h4>
            <mat-list>
              <mat-list-item 
                *ngFor="let app of recentDeadlineAlerts" 
                class="deadline-item clickable"
                (click)="navigateToApplicationDetail(app.id!)">
                <mat-icon matListItemIcon>warning</mat-icon>
                <div matListItemTitle>{{ getApplicationTypeLabel(app.type) }}</div>
                <div matListItemLine>期限: {{ formatDate(app.deadline) }}</div>
              </mat-list-item>
            </mat-list>
          </div>

          <!-- 被保険者資格取得届の期限 -->
          <div *ngIf="insuranceAcquisitionDeadlines.length > 0" class="deadline-section">
            <h4>被保険者資格取得届の期限</h4>
            <mat-list>
              <mat-list-item 
                *ngFor="let app of insuranceAcquisitionDeadlines" 
                class="deadline-item clickable"
                (click)="navigateToApplicationDetail(app.id!)">
                <mat-icon matListItemIcon>person_add</mat-icon>
                <div matListItemTitle>資格取得届</div>
                <div matListItemLine>期限: {{ formatDate(app.deadline) }}</div>
              </mat-list-item>
            </mat-list>
          </div>

          <!-- 月額変更届対象者 -->
          <div *ngIf="hasMonthlyChangeTargets" class="deadline-section">
            <div class="info-message">
              <mat-icon>info</mat-icon>
              <span>月額変更届の対象者がいます</span>
            </div>
          </div>

          <div *ngIf="overdueApplicationsByType.length === 0 && recentDeadlineAlerts.length === 0 && insuranceAcquisitionDeadlines.length === 0 && !hasMonthlyChangeTargets" class="no-items">
            <mat-icon>check_circle</mat-icon>
            <span>期限に関するアラートはありません</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 必須③：最近の動き -->
      <mat-card class="activity-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>history</mat-icon>
            最近の動き
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-list *ngIf="recentActivities.length > 0">
            <mat-list-item *ngFor="let activity of recentActivities">
              <mat-icon matListItemIcon>{{ getActivityIcon(activity.type) }}</mat-icon>
              <div matListItemTitle>{{ activity.message }}</div>
              <div matListItemLine>{{ formatDate(activity.date) }}</div>
            </mat-list-item>
          </mat-list>
          <div *ngIf="recentActivities.length === 0" class="no-items">
            <mat-icon>info</mat-icon>
            <span>最近の動きはありません</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 任意：今月の概況 -->
      <mat-card class="summary-card" *ngIf="currentUser?.role === 'owner' || currentUser?.role === 'admin'">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>analytics</mat-icon>
            今月の概況
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="monthly-summary">
            <div class="summary-stat">
              <div class="stat-label">被保険者数</div>
              <div class="stat-value">{{ currentMonthInsuredCount }}名</div>
            </div>
            <mat-divider [vertical]="true"></mat-divider>
            <div class="summary-stat">
              <div class="stat-label">保険料合計（概算）</div>
              <div class="stat-value">{{ currentMonthPremiumTotal | number }}円</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 開発・テスト用機能 -->
      <!-- 【修正20】通知機能を削除するためコメントアウト -->
      <!--
      <mat-card *ngIf="currentUser?.role === 'owner' || currentUser?.role === 'admin'" class="dev-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>settings</mat-icon>
            開発・テスト用機能
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="checkRemindersManually()">
            <mat-icon>notifications</mat-icon>
            リマインダーを手動でチェック
          </button>
        </mat-card-content>
      </mat-card>
      -->
    </div>

    <!-- 【修正21】社員モードのダッシュボード -->
    <div *ngIf="!isLoading && !isAdminMode" class="dashboard-grid">
      <!-- 自分の申請状況 -->
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>description</mat-icon>
            自分の申請状況
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="myApplicationsByType.length > 0" class="my-applications-section">
            <div *ngFor="let typeData of myApplicationsByType" class="application-type-section">
              <h4 class="type-title">{{ typeData.typeName }}</h4>
              <div class="status-list">
                <div *ngFor="let statusData of typeData.statuses" class="status-item clickable"
                     (click)="navigateToMyApplications(typeData.typeId, statusData.status)">
                  <div class="status-info">
                    <mat-chip [color]="getStatusChipColor(statusData.status)">
                      {{ statusData.statusLabel }}
                    </mat-chip>
                    <span class="status-count">{{ statusData.count }}件</span>
                  </div>
                  <!-- 直近の申請リスト（最大5件） -->
                  <mat-list *ngIf="statusData.applications.length > 0" class="recent-applications-list">
                    <mat-list-item *ngFor="let app of statusData.applications" 
                                   class="application-item clickable"
                                   (click)="navigateToApplicationDetail(app.id!)">
                      <mat-icon matListItemIcon>description</mat-icon>
                      <div matListItemTitle>
                        {{ getApplicationTypeLabel(app.type) }}
                        <span class="application-date">（{{ formatDate(app.createdAt) }}）</span>
                      </div>
                    </mat-list-item>
                  </mat-list>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="myApplicationsByType.length === 0" class="no-items">
            <mat-icon>info</mat-icon>
            <span>申請はありません</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- 申請作成のショートカット -->
      <mat-card class="create-shortcut-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>add_circle</mat-icon>
            申請作成
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="internalApplicationTypes.length > 0" class="application-types-grid">
            <button *ngFor="let type of internalApplicationTypes" 
                    mat-raised-button 
                    color="primary" 
                    class="create-button"
                    (click)="navigateToCreateApplication(type.id)">
              <mat-icon>add</mat-icon>
              {{ type.name }}を作成
            </button>
          </div>
          <div *ngIf="internalApplicationTypes.length === 0" class="no-items">
            <mat-icon>info</mat-icon>
            <span>作成可能な申請種別がありません</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>


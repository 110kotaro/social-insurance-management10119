<div class="application-create-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>edit</mat-icon>
        申請編集
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-stepper #stepper linear>
        <!-- ステップ1: 申請内容入力（編集モードでは申請種別選択ステップは非表示） -->
        <mat-step [stepControl]="getStep2FormControl()">
          <ng-template matStepLabel>申請内容入力</ng-template>
          
          <!-- 申請説明書セクション -->
          <div class="explanation-section" *ngIf="getExplanationPdfs().length > 0">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>description</mat-icon>
                  申請説明書
                </mat-panel-title>
              </mat-expansion-panel-header>
              <mat-list>
                <mat-list-item *ngFor="let pdfFile of getExplanationPdfs(); let i = index">
                  <mat-icon matListItemIcon>picture_as_pdf</mat-icon>
                  <span matListItemTitle>説明書{{ i + 1 }}</span>
                  <span matListItemLine>{{ pdfFile }}</span>
                  <a [href]="getExplanationPdfPath(pdfFile)" target="_blank" matListItemMeta class="pdf-link">
                    <mat-icon>open_in_new</mat-icon>
                    <span>開く</span>
                  </a>
                </mat-list-item>
              </mat-list>
            </mat-expansion-panel>
          </div>
          
          <!-- 被保険者資格取得届の詳細フォーム -->
          <form *ngIf="isInsuranceAcquisitionForm && insuranceAcquisitionForm" [formGroup]="insuranceAcquisitionForm">
            <div class="step-content">
              <h3>被保険者資格取得届</h3>

              <!-- 提出者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>提出者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content formGroupName="submitterInfo">
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>事業所整理記号</mat-label>
                      <input matInput formControlName="officeSymbol">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>事業所番号</mat-label>
                      <input matInput formControlName="officeNumber" required>
                      <mat-error *ngIf="insuranceAcquisitionForm.get('submitterInfo.officeNumber')?.hasError('required')">
                        事業所番号を入力してください
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                    <mat-error *ngIf="insuranceAcquisitionForm.get('submitterInfo.officeAddress')?.hasError('required')">
                      事業所所在地を入力してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                    <mat-error *ngIf="insuranceAcquisitionForm.get('submitterInfo.officeName')?.hasError('required')">
                      事業所名称を入力してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="insuredPersons">
                    <div *ngFor="let person of insuredPersonsFormArray?.controls; let i = index" 
                         [formGroupName]="i" class="insured-person-item">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>被保険者 {{ i + 1 }}</mat-card-title>
                          <button *ngIf="insuredPersonsFormArray && insuredPersonsFormArray.length > 1" 
                                  mat-icon-button (click)="removeInsuredPerson(i)" type="button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                          <div *ngIf="person.get('employeeId')?.value; else employeeSelectTemplate">
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員</mat-label>
                              <input matInput [value]="getEmployeeDisplayNameById(person.get('employeeId')?.value)" readonly>
                              <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                            </mat-form-field>
                          </div>
                          <ng-template #employeeSelectTemplate>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員を選択（情報を自動入力）</mat-label>
                              <mat-select (selectionChange)="onEmployeeSelect(i, $event.value)" [value]="null">
                                <mat-option value="">選択してください</mat-option>
                                <mat-option *ngFor="let employee of employees" [value]="employee.id">
                                  {{ getEmployeeDisplayName(employee) }}
                                </mat-option>
                              </mat-select>
                              <mat-hint>社員を選択すると、氏名・生年月日などの情報が自動入力されます</mat-hint>
                            </mat-form-field>
                          </ng-template>

                          <mat-divider style="margin: 16px 0;"></mat-divider>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>被保険者整理番号</mat-label>
                              <input matInput formControlName="insuranceNumber">
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏</mat-label>
                              <input matInput formControlName="lastName" required>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('lastName')?.hasError('required')">
                                氏を入力してください
                              </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名</mat-label>
                              <input matInput formControlName="firstName" required>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('firstName')?.hasError('required')">
                                名を入力してください
                              </mat-error>
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏（カナ）</mat-label>
                              <input matInput formControlName="lastNameKana" required>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('lastNameKana')?.hasError('required')">
                                氏（カナ）を入力してください
                              </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名（カナ）</mat-label>
                              <input matInput formControlName="firstNameKana" required>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('firstNameKana')?.hasError('required')">
                                名（カナ）を入力してください
                              </mat-error>
                            </mat-form-field>
                          </div>

                          <!-- 生年月日 -->
                          <div class="form-section-title">生年月日 *</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                  {{ era.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>種別</mat-label>
                              <mat-select formControlName="type" required>
                                <mat-option *ngFor="let type of typeOptions" [value]="type.value">
                                  {{ type.label }}
                                </mat-option>
                              </mat-select>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('type')?.hasError('required')">
                                種別を選択してください
                              </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>取得区分</mat-label>
                              <mat-select formControlName="acquisitionType" required>
                                <mat-option *ngFor="let acqType of acquisitionTypeOptions" [value]="acqType.value">
                                  {{ acqType.label }}
                                </mat-option>
                              </mat-select>
                              <mat-error *ngIf="getInsuredPersonFormGroup(i).get('acquisitionType')?.hasError('required')">
                                取得区分を選択してください
                              </mat-error>
                            </mat-form-field>
                          </div>

                          <!-- 個人番号 or 基礎年金番号 -->
                          <div class="form-section-title">個人番号または基礎年金番号</div>
                          <mat-radio-group formControlName="identificationType" required>
                            <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                            <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                          </mat-radio-group>

                          <mat-form-field *ngIf="getInsuredPersonFormGroup(i).get('identificationType')?.value === 'personal_number'" 
                                          appearance="outline" class="full-width">
                            <mat-label>個人番号</mat-label>
                            <input matInput formControlName="personalNumber">
                          </mat-form-field>

                          <mat-form-field *ngIf="getInsuredPersonFormGroup(i).get('identificationType')?.value === 'basic_pension_number'" 
                                          appearance="outline" class="full-width">
                            <mat-label>基礎年金番号</mat-label>
                            <input matInput formControlName="basicPensionNumber">
                          </mat-form-field>

                          <!-- 取得（該当）年月日 -->
                          <div class="form-section-title">取得（該当）年月日</div>
                          <div formGroupName="acquisitionDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                  {{ era.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被扶養者</mat-label>
                            <mat-select formControlName="hasDependents" required>
                              <mat-option value="no">なし</mat-option>
                              <mat-option value="yes">あり</mat-option>
                            </mat-select>
                            <mat-error *ngIf="getInsuredPersonFormGroup(i).get('hasDependents')?.hasError('required')">
                              被扶養者を選択してください
                            </mat-error>
                          </mat-form-field>

                          <!-- 報酬月額 -->
                          <div class="form-section-title">報酬月額</div>
                          <div formGroupName="remuneration" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>通貨</mat-label>
                              <input matInput type="number" formControlName="currency">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>現物</mat-label>
                              <input matInput type="number" formControlName="inKind">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>合計</mat-label>
                              <input matInput type="number" formControlName="total">
                              <mat-hint>通貨と現物の合計が自動計算されます</mat-hint>
                            </mat-form-field>
                          </div>

                          <!-- 備考 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <mat-select formControlName="remarks">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let remark of remarksOptions" [value]="remark.value">
                                {{ remark.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field *ngIf="getInsuredPersonFormGroup(i).get('remarks')?.value === 'other'" 
                                          appearance="outline" class="full-width">
                            <mat-label>備考（その他）</mat-label>
                            <textarea matInput formControlName="remarksOther" rows="2"></textarea>
                          </mat-form-field>

                          <!-- 住所（基礎年金番号の場合は必須） -->
                          <div *ngIf="isAddressRequired(i)" formGroupName="address">
                            <div class="form-section-title">住所（カナも必要）</div>
                            <div class="form-row">
                              <mat-form-field appearance="outline" class="form-field">
                                <mat-label>郵便番号</mat-label>
                                <input matInput formControlName="postalCode">
                              </mat-form-field>
                            </div>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>都道府県</mat-label>
                              <input matInput formControlName="prefecture">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>市区町村</mat-label>
                              <input matInput formControlName="city">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>町名・番地</mat-label>
                              <input matInput formControlName="street">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>建物名・部屋番号</mat-label>
                              <input matInput formControlName="building">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>住所（カナ）</mat-label>
                              <input matInput formControlName="addressKana">
                            </mat-form-field>
                          </div>

                          <mat-checkbox formControlName="certificateRequired">
                            資格確認書発行要否
                          </mat-checkbox>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addInsuredPerson()" class="add-button">
                    <mat-icon>add</mat-icon>
                    被保険者を追加
                  </button>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="insuranceAcquisitionForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者資格喪失届の詳細フォーム -->
          <form *ngIf="isInsuranceLossForm && insuranceLossForm" [formGroup]="insuranceLossForm">
            <div class="step-content">
              <h3>被保険者資格喪失届</h3>

              <!-- 提出者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>提出者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content formGroupName="submitterInfo">
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>事業所整理記号</mat-label>
                      <input matInput formControlName="officeSymbol">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>事業所番号</mat-label>
                      <input matInput formControlName="officeNumber" required>
                      <mat-error *ngIf="insuranceLossForm.get('submitterInfo.officeNumber')?.hasError('required')">
                        事業所番号を入力してください
                      </mat-error>
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                    <mat-error *ngIf="insuranceLossForm.get('submitterInfo.officeAddress')?.hasError('required')">
                      事業所所在地を入力してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                    <mat-error *ngIf="insuranceLossForm.get('submitterInfo.officeName')?.hasError('required')">
                      事業所名称を入力してください
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="insuredPersons">
                    <div *ngFor="let person of insuredPersonsFormArray?.controls; let i = index" 
                         [formGroupName]="i" class="insured-person-item">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>被保険者 {{ i + 1 }}</mat-card-title>
                          <button *ngIf="insuredPersonsFormArray && insuredPersonsFormArray.length > 1" 
                                  mat-icon-button (click)="removeInsuredPersonForLoss(i)" type="button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                          <div *ngIf="person.get('employeeId')?.value; else employeeSelectForLossTemplate">
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員</mat-label>
                              <input matInput [value]="getEmployeeDisplayNameById(person.get('employeeId')?.value)" readonly>
                              <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                            </mat-form-field>
                          </div>
                          <ng-template #employeeSelectForLossTemplate>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員を選択（情報を自動入力）</mat-label>
                              <mat-select (selectionChange)="onEmployeeSelectForLoss(i, $event.value)" [value]="null">
                                <mat-option value="">選択してください</mat-option>
                                <mat-option *ngFor="let employee of employees" [value]="employee.id">
                                  {{ getEmployeeDisplayName(employee) }}
                                </mat-option>
                              </mat-select>
                              <mat-hint>社員を選択すると、氏名・生年月日などの情報が自動入力されます</mat-hint>
                            </mat-form-field>
                          </ng-template>

                          <mat-divider style="margin: 16px 0;"></mat-divider>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>被保険者整理番号</mat-label>
                              <input matInput formControlName="insuranceNumber">
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏</mat-label>
                              <input matInput formControlName="lastName" required>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名</mat-label>
                              <input matInput formControlName="firstName" required>
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏（カナ）</mat-label>
                              <input matInput formControlName="lastNameKana" required>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名（カナ）</mat-label>
                              <input matInput formControlName="firstNameKana" required>
                            </mat-form-field>
                          </div>

                          <!-- 生年月日 -->
                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                  {{ era.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <!-- 個人番号 or 基礎年金番号 -->
                          <div class="form-section-title">個人番号または基礎年金番号</div>
                          <mat-radio-group formControlName="identificationType" required>
                            <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                            <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                          </mat-radio-group>

                          <mat-form-field *ngIf="getInsuredPersonFormGroupForLoss(i).get('identificationType')?.value === 'personal_number'" 
                                          appearance="outline" class="full-width">
                            <mat-label>個人番号</mat-label>
                            <input matInput formControlName="personalNumber">
                          </mat-form-field>

                          <mat-form-field *ngIf="getInsuredPersonFormGroupForLoss(i).get('identificationType')?.value === 'basic_pension_number'" 
                                          appearance="outline" class="full-width">
                            <mat-label>基礎年金番号</mat-label>
                            <input matInput formControlName="basicPensionNumber">
                          </mat-form-field>

                          <!-- 喪失年月日 -->
                          <div class="form-section-title">喪失年月日</div>
                          <div formGroupName="lossDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                  {{ era.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <!-- 喪失原因 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>喪失原因</mat-label>
                            <mat-select formControlName="lossReason" required>
                              <mat-option *ngFor="let reason of lossReasonOptions" [value]="reason.value">
                                {{ reason.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 退職等した日（退職等選択時） -->
                          <div *ngIf="isRetirementDateRequired(i)" formGroupName="retirementDate">
                            <div class="form-section-title">退職等した日</div>
                            <div class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era">
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                    {{ era.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" min="1" max="31">
                              </mat-form-field>
                            </div>
                          </div>

                          <!-- 死亡した日（死亡選択時） -->
                          <div *ngIf="isDeathDateRequired(i)" formGroupName="deathDate">
                            <div class="form-section-title">死亡した日</div>
                            <div class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era">
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                    {{ era.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" min="1" max="31">
                              </mat-form-field>
                            </div>
                          </div>

                          <!-- 備考 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <mat-select formControlName="remarks">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let remark of lossRemarksOptions" [value]="remark.value">
                                {{ remark.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field *ngIf="getInsuredPersonFormGroupForLoss(i).get('remarks')?.value === 'other'" 
                                          appearance="outline" class="full-width">
                            <mat-label>備考（その他）</mat-label>
                            <textarea matInput formControlName="remarksOther" rows="2"></textarea>
                          </mat-form-field>

                          <!-- 資格確認書回収 -->
                          <div class="form-section-title">資格確認書回収</div>
                          <div formGroupName="certificateCollection" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>添付（枚）</mat-label>
                              <input matInput type="number" formControlName="attached">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>返不能（枚）</mat-label>
                              <input matInput type="number" formControlName="unrecoverable">
                            </mat-form-field>
                          </div>

                          <!-- 70歳不該当 -->
                          <mat-checkbox formControlName="over70NotApplicable">
                            70歳以上被用者不該当（70歳以上の被用者ではないということではありません）
                          </mat-checkbox>

                          <!-- 不該当年月日（チェック時） -->
                          <div *ngIf="isOver70NotApplicableDateRequired(i)" formGroupName="over70NotApplicableDate">
                            <div class="form-section-title">不該当年月日</div>
                            <div class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era">
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">
                                    {{ era.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" min="1" max="31">
                              </mat-form-field>
                            </div>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addInsuredPersonForLoss()" class="add-button">
                    <mat-icon>add</mat-icon>
                    被保険者を追加
                  </button>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="insuranceLossForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者住所変更届の詳細フォーム -->
          <form *ngIf="isAddressChangeForm && addressChangeForm" [formGroup]="addressChangeForm">
            <div class="step-content">
              <h3>被保険者住所変更届</h3>

              <!-- 事業所情報 -->
              <mat-card class="form-section" formGroupName="businessInfo">
                <mat-card-header>
                  <mat-card-title>事業所情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                  <div *ngIf="addressChangeForm.get('insuredPerson.employeeId')?.value; else employeeSelectForAddressChangeTemplate">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員</mat-label>
                      <input matInput [value]="getEmployeeDisplayNameById(addressChangeForm.get('insuredPerson.employeeId')?.value)" readonly>
                      <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                    </mat-form-field>
                  </div>
                  <ng-template #employeeSelectForAddressChangeTemplate>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員を選択（情報を自動入力）</mat-label>
                      <mat-select (selectionChange)="onEmployeeSelectForAddressChange($event.value)" [value]="null">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option *ngFor="let employee of employees" [value]="employee.id">
                          {{ getEmployeeDisplayName(employee) }}
                        </mat-option>
                      </mat-select>
                      <mat-hint>社員を選択すると、氏名・生年月日などの情報が自動入力されます</mat-hint>
                    </mat-form-field>
                  </ng-template>

                  <mat-divider style="margin: 16px 0;"></mat-divider>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="addressChangeForm.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="addressChangeForm.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="lastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="firstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="lastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="firstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                    <mat-label>変更後郵便番号</mat-label>
                      <input matInput formControlName="newPostalCode" placeholder="例: 123-4567">
                  </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>都道府県</mat-label>
                      <input matInput formControlName="newPrefecture">
                  </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>市区町村</mat-label>
                      <input matInput formControlName="newCity">
                  </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>町名・番地</mat-label>
                      <input matInput formControlName="newStreet">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>建物名・部屋番号</mat-label>
                      <input matInput formControlName="newBuilding">
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>住所（カナ）</mat-label>
                      <input matInput formControlName="newAddressKana" placeholder="例: トウキョウトシブヤク">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>変更前住所</mat-label>
                    <textarea matInput formControlName="oldAddress" rows="2"></textarea>
                  </mat-form-field>

                  <div class="form-section-title">変更年月日</div>
                  <div formGroupName="changeDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>備考</mat-label>
                    <mat-select formControlName="remarks">
                      <mat-option value="">選択してください</mat-option>
                      <mat-option *ngFor="let remark of addressChangeRemarksOptions" [value]="remark.value">
                        {{ remark.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-checkbox formControlName="livingWithSpouse">
                    被保険者と配偶者は同居している
                  </mat-checkbox>

                  <!-- 配偶者情報（同居チェック時） -->
                  <div *ngIf="addressChangeForm.get('insuredPerson.livingWithSpouse')?.value" class="spouse-section">
                    <div class="form-section-title">配偶者情報</div>
                    <div class="form-section-title">個人番号または基礎年金番号</div>
                    <mat-radio-group formControlName="spouseIdentificationType">
                      <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                      <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                    </mat-radio-group>

                    <mat-form-field *ngIf="addressChangeForm.get('insuredPerson.spouseIdentificationType')?.value === 'personal_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>配偶者の個人番号</mat-label>
                      <input matInput formControlName="spousePersonalNumber">
                    </mat-form-field>

                    <mat-form-field *ngIf="addressChangeForm.get('insuredPerson.spouseIdentificationType')?.value === 'basic_pension_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>配偶者の基礎年金番号</mat-label>
                      <input matInput formControlName="spouseBasicPensionNumber">
                    </mat-form-field>

                    <div class="form-section-title">配偶者の生年月日</div>
                    <div formGroupName="spouseBirthDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の氏</mat-label>
                        <input matInput formControlName="spouseLastName">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の名</mat-label>
                        <input matInput formControlName="spouseFirstName">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の氏（カナ）</mat-label>
                        <input matInput formControlName="spouseLastNameKana">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の名（カナ）</mat-label>
                        <input matInput formControlName="spouseFirstNameKana">
                      </mat-form-field>
                    </div>
                  </div>

                  <!-- 配偶者情報（別居時） -->
                  <div *ngIf="!addressChangeForm.get('insuredPerson.livingWithSpouse')?.value" class="spouse-section">
                    <div class="form-section-title">配偶者情報</div>
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                      <mat-label>配偶者の変更後郵便番号</mat-label>
                        <input matInput formControlName="spouseNewPostalCode" placeholder="例: 123-4567">
                    </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>都道府県</mat-label>
                        <input matInput formControlName="spouseNewPrefecture">
                    </mat-form-field>

                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>市区町村</mat-label>
                        <input matInput formControlName="spouseNewCity">
                    </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>町名・番地</mat-label>
                        <input matInput formControlName="spouseNewStreet">
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>建物名・部屋番号</mat-label>
                        <input matInput formControlName="spouseNewBuilding">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>住所（カナ）</mat-label>
                        <input matInput formControlName="spouseNewAddressKana" placeholder="例: トウキョウトシブヤク">
                      </mat-form-field>
                    </div>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の変更前住所</mat-label>
                      <textarea matInput formControlName="spouseOldAddress" rows="2"></textarea>
                    </mat-form-field>
                    <div class="form-section-title">配偶者の変更年月日</div>
                    <div formGroupName="spouseChangeDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の備考</mat-label>
                      <mat-select formControlName="spouseRemarks">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option *ngFor="let remark of addressChangeRemarksOptions" [value]="remark.value">
                          {{ remark.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="addressChangeForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者氏名変更（訂正）届の詳細フォーム -->
          <form *ngIf="isNameChangeForm && nameChangeForm" [formGroup]="nameChangeForm">
            <div class="step-content">
              <h3>被保険者氏名変更（訂正）届</h3>

              <!-- 事業所情報 -->
              <mat-card class="form-section" formGroupName="businessInfo">
                <mat-card-header>
                  <mat-card-title>事業所情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                  <div *ngIf="nameChangeForm.get('insuredPerson.employeeId')?.value; else employeeSelectForNameChangeTemplate">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員</mat-label>
                      <input matInput [value]="getEmployeeDisplayNameById(nameChangeForm.get('insuredPerson.employeeId')?.value)" readonly>
                      <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                    </mat-form-field>
                  </div>
                  <ng-template #employeeSelectForNameChangeTemplate>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員を選択（情報を自動入力）</mat-label>
                      <mat-select (selectionChange)="onEmployeeSelectForNameChange($event.value)" [value]="null">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option *ngFor="let employee of employees" [value]="employee.id">
                          {{ getEmployeeDisplayName(employee) }}
                        </mat-option>
                      </mat-select>
                      <mat-hint>社員を選択すると、氏名・生年月日などの情報が自動入力されます</mat-hint>
                    </mat-form-field>
                  </ng-template>

                  <mat-divider style="margin: 16px 0;"></mat-divider>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="nameChangeForm.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="nameChangeForm.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">被保険者の氏名（変更後）</div>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="newLastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="newFirstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="newLastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="newFirstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">変更前の氏名</div>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="oldLastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="oldFirstName" required>
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>備考</mat-label>
                    <textarea matInput formControlName="remarks" rows="3"></textarea>
                  </mat-form-field>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="nameChangeForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被扶養者（異動）届の詳細フォーム -->
          <form *ngIf="isDependentChangeForm && dependentChangeForm" [formGroup]="dependentChangeForm">
            <div class="step-content">
              <h3>被扶養者（異動）届</h3>
              <p class="form-note">※ 被扶養者（異動）届は複雑なフォームのため、基本的な項目のみ実装しています。詳細な項目は今後追加予定です。</p>

              <!-- 事業主情報 -->
              <mat-card class="form-section" formGroupName="businessOwnerInfo">
                <mat-card-header>
                  <mat-card-title>事業主情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 事業主等受付年月日 -->
              <mat-card class="form-section" formGroupName="businessOwnerReceiptDate">
                <mat-card-header>
                  <mat-card-title>事業主等受付年月日</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option value="reiwa">令和</mat-option>
                        <mat-option value="heisei">平成</mat-option>
                        <mat-option value="showa">昭和</mat-option>
                        <mat-option value="taisho">大正</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>
                  <mat-hint>関連する内部申請が承認済みの場合、承認日が自動転記されます</mat-hint>
                </mat-card-content>
              </mat-card>

              <!-- 提出日 -->
              <mat-card class="form-section" formGroupName="submissionDate">
                <mat-card-header>
                  <mat-card-title>提出日</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era">
                        <mat-option value="reiwa">令和</mat-option>
                        <mat-option value="heisei">平成</mat-option>
                        <mat-option value="showa">昭和</mat-option>
                        <mat-option value="taisho">大正</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" min="1" max="31">
                    </mat-form-field>
                  </div>
                  <mat-hint>被保険者が送信した年月日が自動転記されます</mat-hint>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                  <div *ngIf="dependentChangeForm.get('insuredPerson.employeeId')?.value; else employeeSelectForDependentChangeTemplate">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員</mat-label>
                      <input matInput [value]="getEmployeeDisplayNameById(dependentChangeForm.get('insuredPerson.employeeId')?.value)" readonly>
                      <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                    </mat-form-field>
                  </div>
                  <ng-template #employeeSelectForDependentChangeTemplate>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>社員を選択（情報を自動入力）</mat-label>
                      <mat-select (selectionChange)="onEmployeeSelectForDependentChange($event.value)" [value]="null">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option *ngFor="let employee of employees" [value]="employee.id">
                          {{ getEmployeeDisplayName(employee) }}
                        </mat-option>
                      </mat-select>
                      <mat-hint>社員を選択すると、氏名・生年月日などの情報が自動入力されます</mat-hint>
                    </mat-form-field>
                  </ng-template>

                  <mat-divider style="margin: 16px 0;"></mat-divider>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="lastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="firstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="lastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="firstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>性別</mat-label>
                    <mat-select formControlName="gender" required>
                      <mat-option value="male">男</mat-option>
                      <mat-option value="female">女</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="dependentChangeForm.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="dependentChangeForm.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-section-title">取得年月日</div>
                  <div formGroupName="acquisitionDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>収入（年収）</mat-label>
                    <input matInput type="number" formControlName="income">
                  </mat-form-field>

                  <div *ngIf="dependentChangeForm.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                       formGroupName="address" class="form-section-title">
                    住所（基礎年金番号記入の場合は必要）
                  </div>
                  <div *ngIf="dependentChangeForm.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                       formGroupName="address">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>郵便番号</mat-label>
                      <input matInput formControlName="postalCode">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>都道府県</mat-label>
                      <input matInput formControlName="prefecture">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>市区町村</mat-label>
                      <input matInput formControlName="city">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>町名・番地</mat-label>
                      <input matInput formControlName="street">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>建物名・部屋番号</mat-label>
                      <input matInput formControlName="building">
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- 配偶者である被扶養者情報 -->
              <mat-card class="form-section" formGroupName="spouseDependent">
                <mat-card-header>
                  <mat-card-title>配偶者である被扶養者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 異動がない場合のフラグ -->
                  <mat-checkbox formControlName="noChange">
                    異動がない場合（配偶者の収入のみ記入）
                  </mat-checkbox>

                  <!-- 異動がない場合の配偶者の収入 -->
                  <div *ngIf="isSpouseNoChange()">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の収入（年収）</mat-label>
                      <input matInput type="number" formControlName="spouseIncome" required>
                    </mat-form-field>
                  </div>

                  <!-- 異動がある場合の入力フォーム -->
                  <div *ngIf="!isSpouseNoChange()">
                    <!-- 被保険者がこの届書を事業主に提出した日 -->
                    <!-- 氏名 -->
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>氏名</mat-label>
                        <input matInput formControlName="name">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>氏名（カナ）</mat-label>
                        <input matInput formControlName="nameKana">
                      </mat-form-field>
                    </div>

                    <!-- 生年月日 -->
                    <div class="form-section-title">生年月日</div>
                    <div formGroupName="birthDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>

                    <!-- 続柄（性別） -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>続柄</mat-label>
                      <mat-select formControlName="relationship" required>
                        <mat-option *ngFor="let rel of relationshipOptions" [value]="rel.value">
                          {{ rel.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 個人番号または基礎年金番号 -->
                    <div class="form-section-title">個人番号または基礎年金番号</div>
                    <mat-radio-group formControlName="identificationType">
                      <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                      <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                    </mat-radio-group>

                    <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.identificationType')?.value === 'personal_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>個人番号</mat-label>
                      <input matInput formControlName="personalNumber">
                    </mat-form-field>

                    <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.identificationType')?.value === 'basic_pension_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>基礎年金番号</mat-label>
                      <input matInput formControlName="basicPensionNumber">
                    </mat-form-field>

                    <!-- 外国籍 -->
                    <mat-checkbox formControlName="isForeigner">
                      外国籍
                    </mat-checkbox>

                    <div *ngIf="dependentChangeForm.get('spouseDependent.isForeigner')?.value">
                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>外国人通称名</mat-label>
                          <input matInput formControlName="foreignName">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>外国人通称名（カナ）</mat-label>
                          <input matInput formControlName="foreignNameKana">
                        </mat-form-field>
                      </div>
                    </div>

                    <!-- 住所 -->
                    <div class="form-section-title">住所</div>
                    <div formGroupName="address">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>住所</mat-label>
                        <textarea matInput formControlName="address" rows="2"></textarea>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>同居・別居</mat-label>
                        <mat-select formControlName="livingTogether">
                          <mat-option value="living_together">同居</mat-option>
                          <mat-option value="separate">別居</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <!-- 電話番号 -->
                    <div class="form-section-title">電話番号</div>
                    <div formGroupName="phoneNumber">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>電話番号</mat-label>
                        <input matInput formControlName="phone">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>種別</mat-label>
                        <mat-select formControlName="type">
                          <mat-option *ngFor="let type of phoneTypeOptions" [value]="type.value">
                            {{ type.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>異動種別</mat-label>
                      <mat-select formControlName="changeType" required>
                        <mat-option *ngFor="let type of changeTypeOptions" [value]="type.value">
                          {{ type.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 異動種別「該当」の場合 -->
                    <div *ngIf="isSpouseChangeTypeApplicable()">
                      <div class="form-section-title">被扶養者になった日</div>
                      <div formGroupName="dependentStartDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>被扶養者になった理由</mat-label>
                        <mat-select formControlName="dependentStartReason" required>
                          <mat-option *ngFor="let reason of dependentStartReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.dependentStartReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>被扶養者になった理由（その他）</mat-label>
                        <textarea matInput formControlName="dependentStartReasonOther" rows="2" required></textarea>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>職業</mat-label>
                        <mat-select formControlName="occupation" required>
                          <mat-option *ngFor="let occ of occupationOptions" [value]="occ.value">
                            {{ occ.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.occupation')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>職業（その他）</mat-label>
                        <textarea matInput formControlName="occupationOther" rows="2" required></textarea>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>収入（年収）</mat-label>
                        <input matInput type="number" formControlName="income" required>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別「非該当」の場合 -->
                    <div *ngIf="isSpouseChangeTypeNotApplicable()">
                      <div class="form-section-title">被扶養者でなくなった日</div>
                      <div formGroupName="dependentEndDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="dependentEndReason" required>
                          <mat-option *ngFor="let reason of dependentEndReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <!-- 死亡の場合の日付 -->
                      <div *ngIf="isSpouseEndReasonDeath()">
                        <div class="form-section-title">死亡した日</div>
                        <div formGroupName="deathDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era" required>
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year" required>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" required min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" required min="1" max="31">
                          </mat-form-field>
                        </div>
                      </div>

                      <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.dependentEndReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="dependentEndReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別「変更」の場合 -->
                    <div *ngIf="isSpouseChangeTypeChange()">
                      <h4>変更前の情報</h4>
                      <!-- 変更前の情報は上記の該当・非該当のフィールドを使用 -->
                      <!-- 変更後の情報を下に追加 -->
                      <h4>変更後の情報</h4>
                      <div formGroupName="changeAfter">
                        <!-- 変更後：被扶養者になった日 -->
                        <div class="form-section-title">被扶養者になった日</div>
                        <div formGroupName="dependentStartDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era">
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" min="1" max="31">
                          </mat-form-field>
                        </div>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>被扶養者になった理由</mat-label>
                          <mat-select formControlName="dependentStartReason">
                            <mat-option *ngFor="let reason of dependentStartReasonOptions" [value]="reason.value">
                              {{ reason.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.changeAfter.dependentStartReason')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>被扶養者になった理由（その他）</mat-label>
                          <textarea matInput formControlName="dependentStartReasonOther" rows="2"></textarea>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>職業</mat-label>
                          <mat-select formControlName="occupation">
                            <mat-option *ngFor="let occ of occupationOptions" [value]="occ.value">
                              {{ occ.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.changeAfter.occupation')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>職業（その他）</mat-label>
                          <textarea matInput formControlName="occupationOther" rows="2"></textarea>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>収入（年収）</mat-label>
                          <input matInput type="number" formControlName="income">
                        </mat-form-field>

                        <!-- 変更後：被扶養者でなくなった日 -->
                        <div class="form-section-title">被扶養者でなくなった日</div>
                        <div formGroupName="dependentEndDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era">
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" min="1" max="31">
                          </mat-form-field>
                        </div>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>理由</mat-label>
                          <mat-select formControlName="dependentEndReason">
                            <mat-option *ngFor="let reason of dependentEndReasonOptions" [value]="reason.value">
                              {{ reason.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.changeAfter.dependentEndReason')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>理由（その他）</mat-label>
                          <textarea matInput formControlName="dependentEndReasonOther" rows="2"></textarea>
                        </mat-form-field>

                        <!-- 変更後：死亡の場合の日付 -->
                        <div *ngIf="dependentChangeForm.get('spouseDependent.changeAfter.dependentEndReason')?.value === 'death'">
                          <div class="form-section-title">死亡した日</div>
                          <div formGroupName="deathDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era">
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" min="1" max="31">
                            </mat-form-field>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 備考 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>備考</mat-label>
                      <textarea matInput formControlName="remarks" rows="3"></textarea>
                    </mat-form-field>

                    <!-- 海外特例要件 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>海外特例要件</mat-label>
                      <mat-select formControlName="overseasException">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option value="applicable">該当</mat-option>
                        <mat-option value="not_applicable">非該当</mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 海外特例要件「該当」の場合 -->
                    <div *ngIf="isSpouseOverseasExceptionApplicable()">
                      <div class="form-section-title">海外特例要件に該当した日</div>
                      <div formGroupName="overseasExceptionStartDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="overseasExceptionStartReason" required>
                          <mat-option *ngFor="let reason of overseasExceptionReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.overseasExceptionStartReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="overseasExceptionStartReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 海外特例要件「非該当」の場合 -->
                    <div *ngIf="isSpouseOverseasExceptionNotApplicable()">
                      <div class="form-section-title">海外特例要件に非該当となった日</div>
                      <div formGroupName="overseasExceptionEndDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="overseasExceptionEndReason" required>
                          <mat-option *ngFor="let reason of overseasExceptionEndReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <!-- 国内転入の場合の日付 -->
                      <div *ngIf="isSpouseOverseasExceptionEndReasonDomesticTransfer()">
                        <div class="form-section-title">国内転入日</div>
                        <div formGroupName="domesticTransferDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era" required>
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year" required>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" required min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" required min="1" max="31">
                          </mat-form-field>
                        </div>
                      </div>

                      <mat-form-field *ngIf="dependentChangeForm.get('spouseDependent.overseasExceptionEndReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="overseasExceptionEndReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 資格確認書発行要否 -->
                    <mat-checkbox formControlName="certificateRequired">
                      資格確認書発行要否
                    </mat-checkbox>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- その他の被扶養者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>その他の被扶養者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="otherDependents" *ngIf="otherDependentsFormArray">
                    <div *ngFor="let dependentControl of (otherDependentsFormArray?.controls || []); let i = index" 
                         [formGroupName]="i" class="dependent-item">
                      <mat-card class="nested-card">
                        <mat-card-header>
                          <mat-card-title>被扶養者 {{ i + 1 }}</mat-card-title>
                          <button mat-icon-button type="button" (click)="removeOtherDependent(i)" 
                                  *ngIf="otherDependentsFormArray && otherDependentsFormArray.length > 1" class="delete-button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 氏名 -->
                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏</mat-label>
                              <input matInput formControlName="lastName" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名</mat-label>
                              <input matInput formControlName="firstName" required>
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏（カナ）</mat-label>
                              <input matInput formControlName="lastNameKana" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名（カナ）</mat-label>
                              <input matInput formControlName="firstNameKana" required>
                            </mat-form-field>
                          </div>

                          <!-- 生年月日 -->
                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <!-- 性別 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>性別</mat-label>
                            <mat-select formControlName="gender" required>
                              <mat-option value="male">男</mat-option>
                              <mat-option value="female">女</mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 続柄 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>続柄</mat-label>
                            <mat-select formControlName="relationship" required>
                              <mat-option *ngFor="let rel of otherDependentRelationshipOptions" [value]="rel.value">
                                {{ rel.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('relationship')?.value === 'other'" 
                                          appearance="outline" class="full-width">
                            <mat-label>続柄（その他）</mat-label>
                            <textarea matInput formControlName="relationshipOther" rows="2" required></textarea>
                          </mat-form-field>

                          <!-- 個人番号 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>個人番号</mat-label>
                            <input matInput formControlName="personalNumber">
                          </mat-form-field>

                          <!-- 住所 -->
                          <div class="form-section-title">住所</div>
                          <div formGroupName="address">
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>住所</mat-label>
                              <textarea matInput formControlName="address" rows="2"></textarea>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>同居・別居</mat-label>
                              <mat-select formControlName="livingTogether">
                                <mat-option value="living_together">同居</mat-option>
                                <mat-option value="separate">別居</mat-option>
                              </mat-select>
                            </mat-form-field>
                          </div>

                          <!-- 海外特例要件 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>海外特例要件</mat-label>
                            <mat-select formControlName="overseasException">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option value="applicable">該当</mat-option>
                              <mat-option value="not_applicable">非該当</mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 海外特例要件「該当」の場合 -->
                          <div *ngIf="isOtherDependentOverseasExceptionApplicable(i)">
                            <div class="form-section-title">海外特例要件に該当した日</div>
                            <div formGroupName="overseasExceptionStartDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="overseasExceptionStartReason" required>
                                <mat-option *ngFor="let reason of overseasExceptionReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('overseasExceptionStartReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="overseasExceptionStartReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 海外特例要件「非該当」の場合 -->
                          <div *ngIf="isOtherDependentOverseasExceptionNotApplicable(i)">
                            <div class="form-section-title">海外特例要件に非該当となった日</div>
                            <div formGroupName="overseasExceptionEndDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="overseasExceptionEndReason" required>
                                <mat-option *ngFor="let reason of overseasExceptionEndReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 国内転入の場合の日付 -->
                            <div *ngIf="isOtherDependentOverseasExceptionEndReasonDomesticTransfer(i)">
                              <div class="form-section-title">国内転入日</div>
                              <div formGroupName="domesticTransferDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era" required>
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year" required>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" required min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" required min="1" max="31">
                                </mat-form-field>
                              </div>
                            </div>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('overseasExceptionEndReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="overseasExceptionEndReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>異動種別</mat-label>
                            <mat-select formControlName="changeType" required>
                              <mat-option *ngFor="let type of changeTypeOptions" [value]="type.value">
                                {{ type.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 異動種別「該当」の場合 -->
                          <div *ngIf="isOtherDependentChangeTypeApplicable(i)">
                            <div class="form-section-title">被扶養者になった日</div>
                            <div formGroupName="dependentStartDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>職業</mat-label>
                              <mat-select formControlName="occupation" required>
                                <mat-option *ngFor="let occ of otherDependentOccupationOptions" [value]="occ.value">
                                  {{ occ.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 高・大学生の場合の学年 -->
                            <mat-form-field *ngIf="isOtherDependentOccupationStudent(i)" 
                                            appearance="outline" class="full-width">
                              <mat-label>学年</mat-label>
                              <input matInput formControlName="studentYear" required placeholder="例：1年生">
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('occupation')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>職業（その他）</mat-label>
                              <textarea matInput formControlName="occupationOther" rows="2" required></textarea>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>収入（年収）</mat-label>
                              <input matInput type="number" formControlName="income" required>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>被扶養者になった理由</mat-label>
                              <mat-select formControlName="dependentStartReason" required>
                                <mat-option *ngFor="let reason of otherDependentStartReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('dependentStartReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>被扶養者になった理由（その他）</mat-label>
                              <textarea matInput formControlName="dependentStartReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別「非該当」の場合 -->
                          <div *ngIf="isOtherDependentChangeTypeNotApplicable(i)">
                            <div class="form-section-title">被扶養者でなくなった日</div>
                            <div formGroupName="dependentEndDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="dependentEndReason" required>
                                <mat-option value="death">死亡</mat-option>
                                <mat-option value="employment">就職</mat-option>
                                <mat-option value="income_increase">収入増加</mat-option>
                                <mat-option value="over75">75歳到達</mat-option>
                                <mat-option value="disability">障害認定</mat-option>
                                <mat-option value="other">その他</mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 死亡の場合の日付 -->
                            <div *ngIf="isOtherDependentEndReasonDeath(i)">
                              <div class="form-section-title">死亡した日</div>
                              <div formGroupName="deathDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era" required>
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year" required>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" required min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" required min="1" max="31">
                                </mat-form-field>
                              </div>
                            </div>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('dependentEndReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="dependentEndReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別「変更」の場合 -->
                          <div *ngIf="isOtherDependentChangeTypeChange(i)">
                            <h4>変更前の情報</h4>
                            <!-- 変更前の情報は上記の該当・非該当のフィールドを使用 -->
                            <!-- 変更後の情報を下に追加 -->
                            <h4>変更後の情報</h4>
                            <div formGroupName="changeAfter">
                              <!-- 変更後：被扶養者になった日 -->
                              <div class="form-section-title">被扶養者になった日</div>
                              <div formGroupName="dependentStartDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era">
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" min="1" max="31">
                                </mat-form-field>
                              </div>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>職業</mat-label>
                                <mat-select formControlName="occupation">
                                  <mat-option *ngFor="let occ of otherDependentOccupationOptions" [value]="occ.value">
                                    {{ occ.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.occupation')?.value === 'student_high_school'" 
                                              appearance="outline" class="full-width">
                                <mat-label>学年</mat-label>
                                <input matInput formControlName="studentYear" placeholder="例：1年生">
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.occupation')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>職業（その他）</mat-label>
                                <textarea matInput formControlName="occupationOther" rows="2"></textarea>
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>収入（年収）</mat-label>
                                <input matInput type="number" formControlName="income">
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>被扶養者になった理由</mat-label>
                                <mat-select formControlName="dependentStartReason">
                                  <mat-option *ngFor="let reason of otherDependentStartReasonOptions" [value]="reason.value">
                                    {{ reason.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentStartReason')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>被扶養者になった理由（その他）</mat-label>
                                <textarea matInput formControlName="dependentStartReasonOther" rows="2"></textarea>
                              </mat-form-field>

                              <!-- 変更後：被扶養者でなくなった日 -->
                              <div class="form-section-title">被扶養者でなくなった日</div>
                              <div formGroupName="dependentEndDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era">
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" min="1" max="31">
                                </mat-form-field>
                              </div>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>理由</mat-label>
                                <mat-select formControlName="dependentEndReason">
                                  <mat-option value="death">死亡</mat-option>
                                  <mat-option value="employment">就職</mat-option>
                                  <mat-option value="income_increase">収入増加</mat-option>
                                  <mat-option value="over75">75歳到達</mat-option>
                                  <mat-option value="disability">障害認定</mat-option>
                                  <mat-option value="other">その他</mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentEndReason')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>理由（その他）</mat-label>
                                <textarea matInput formControlName="dependentEndReasonOther" rows="2"></textarea>
                              </mat-form-field>

                              <!-- 変更後：死亡の場合の日付 -->
                              <div *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentEndReason')?.value === 'death'">
                                <div class="form-section-title">死亡した日</div>
                                <div formGroupName="deathDate" class="date-input-group">
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>年号</mat-label>
                                    <mat-select formControlName="era">
                                      <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                    </mat-select>
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>年</mat-label>
                                    <input matInput type="number" formControlName="year">
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>月</mat-label>
                                    <input matInput type="number" formControlName="month" min="1" max="12">
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>日</mat-label>
                                    <input matInput type="number" formControlName="day" min="1" max="31">
                                  </mat-form-field>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- 備考 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <textarea matInput formControlName="remarks" rows="3"></textarea>
                          </mat-form-field>

                          <!-- 資格確認書発行要否 -->
                          <mat-checkbox formControlName="certificateRequired">
                            資格確認書発行要否
                          </mat-checkbox>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addOtherDependent()" class="add-button">
                    <mat-icon>add</mat-icon>
                    その他の被扶養者を追加
                  </button>
                </mat-card-content>
              </mat-card>

              <!-- 扶養に関する申立書 -->
              <mat-card class="form-section" formGroupName="declaration">
                <mat-card-header>
                  <mat-card-title>扶養に関する申立書</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>記入欄</mat-label>
                    <textarea matInput formControlName="content" rows="5"></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>署名欄</mat-label>
                    <input matInput formControlName="signature" placeholder="申し立ての事実に相違ありません。　氏名　○○○○">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="dependentChangeForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被扶養者（異動）届の詳細フォーム（内部申請用：事業所情報と届書提出日なし） -->
          <form *ngIf="isDependentChangeFormInternal && dependentChangeFormInternal" [formGroup]="dependentChangeFormInternal">
            <div class="step-content">
              <h3>被扶養者（異動）届（内部申請）</h3>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 内部申請のため、ログインユーザーの情報が自動転記されています -->
                  <p class="form-note" style="margin-bottom: 16px;">※ 内部申請のため、ログインユーザー（あなた）の情報が自動転記されています。</p>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="lastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="firstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="lastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="firstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>性別</mat-label>
                    <mat-select formControlName="gender" required>
                      <mat-option value="male">男</mat-option>
                      <mat-option value="female">女</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="dependentChangeFormInternal.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="dependentChangeFormInternal.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-section-title">取得年月日</div>
                  <div formGroupName="acquisitionDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>収入（年収）</mat-label>
                    <input matInput type="number" formControlName="income">
                  </mat-form-field>

                  <div *ngIf="dependentChangeFormInternal.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                       formGroupName="address" class="form-section-title">
                    住所（基礎年金番号記入の場合は必要）
                  </div>
                  <div *ngIf="dependentChangeFormInternal.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                       formGroupName="address">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>郵便番号</mat-label>
                      <input matInput formControlName="postalCode">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>都道府県</mat-label>
                      <input matInput formControlName="prefecture">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>市区町村</mat-label>
                      <input matInput formControlName="city">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>町名・番地</mat-label>
                      <input matInput formControlName="street">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>建物名・部屋番号</mat-label>
                      <input matInput formControlName="building">
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- 配偶者である被扶養者情報 -->
              <mat-card class="form-section" formGroupName="spouseDependent">
                <mat-card-header>
                  <mat-card-title>配偶者である被扶養者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 異動がない場合のフラグ -->
                  <mat-checkbox formControlName="noChange">
                    異動がない場合（配偶者の収入のみ記入）
                  </mat-checkbox>

                  <!-- 異動がない場合の配偶者の収入 -->
                  <div *ngIf="dependentChangeFormInternal.get('spouseDependent.noChange')?.value">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の収入（年収）</mat-label>
                      <input matInput type="number" formControlName="spouseIncome" required>
                    </mat-form-field>
                  </div>

                  <!-- 異動がある場合の入力フォーム -->
                  <div *ngIf="!dependentChangeFormInternal.get('spouseDependent.noChange')?.value">
                    <!-- 被保険者がこの届書を事業主に提出した日 -->
                    <!-- 氏名 -->
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>氏名</mat-label>
                        <input matInput formControlName="name">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>氏名（カナ）</mat-label>
                        <input matInput formControlName="nameKana">
                      </mat-form-field>
                    </div>

                    <!-- 生年月日 -->
                    <div class="form-section-title">生年月日</div>
                    <div formGroupName="birthDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>

                    <!-- 続柄（性別） -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>続柄</mat-label>
                      <mat-select formControlName="relationship" required>
                        <mat-option *ngFor="let rel of relationshipOptions" [value]="rel.value">
                          {{ rel.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 個人番号または基礎年金番号 -->
                    <div class="form-section-title">個人番号または基礎年金番号</div>
                    <mat-radio-group formControlName="identificationType">
                      <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                      <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                    </mat-radio-group>

                    <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.identificationType')?.value === 'personal_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>個人番号</mat-label>
                      <input matInput formControlName="personalNumber">
                    </mat-form-field>

                    <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.identificationType')?.value === 'basic_pension_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>基礎年金番号</mat-label>
                      <input matInput formControlName="basicPensionNumber">
                    </mat-form-field>

                    <!-- 外国籍 -->
                    <mat-checkbox formControlName="isForeigner">
                      外国籍
                    </mat-checkbox>

                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.isForeigner')?.value">
                      <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>外国人通称名</mat-label>
                          <input matInput formControlName="foreignName">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field">
                          <mat-label>外国人通称名（カナ）</mat-label>
                          <input matInput formControlName="foreignNameKana">
                        </mat-form-field>
                      </div>
                    </div>

                    <!-- 住所 -->
                    <div class="form-section-title">住所</div>
                    <div formGroupName="address">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>住所</mat-label>
                        <textarea matInput formControlName="address" rows="2"></textarea>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>同居・別居</mat-label>
                        <mat-select formControlName="livingTogether">
                          <mat-option value="living_together">同居</mat-option>
                          <mat-option value="separate">別居</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <!-- 電話番号 -->
                    <div class="form-section-title">電話番号</div>
                    <div formGroupName="phoneNumber">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>電話番号</mat-label>
                        <input matInput formControlName="phone">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>種別</mat-label>
                        <mat-select formControlName="type">
                          <mat-option *ngFor="let type of phoneTypeOptions" [value]="type.value">
                            {{ type.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>異動種別</mat-label>
                      <mat-select formControlName="changeType" required>
                        <mat-option *ngFor="let type of changeTypeOptions" [value]="type.value">
                          {{ type.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 異動種別「該当」の場合 -->
                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.changeType')?.value === 'applicable'">
                      <div class="form-section-title">被扶養者になった日</div>
                      <div formGroupName="dependentStartDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>被扶養者になった理由</mat-label>
                        <mat-select formControlName="dependentStartReason" required>
                          <mat-option *ngFor="let reason of dependentStartReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.dependentStartReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>被扶養者になった理由（その他）</mat-label>
                        <textarea matInput formControlName="dependentStartReasonOther" rows="2" required></textarea>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>職業</mat-label>
                        <mat-select formControlName="occupation" required>
                          <mat-option *ngFor="let occ of occupationOptions" [value]="occ.value">
                            {{ occ.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.occupation')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>職業（その他）</mat-label>
                        <textarea matInput formControlName="occupationOther" rows="2" required></textarea>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>収入（年収）</mat-label>
                        <input matInput type="number" formControlName="income" required>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別「非該当」の場合 -->
                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.changeType')?.value === 'not_applicable'">
                      <div class="form-section-title">被扶養者でなくなった日</div>
                      <div formGroupName="dependentEndDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="dependentEndReason" required>
                          <mat-option *ngFor="let reason of dependentEndReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <!-- 死亡の場合の日付 -->
                      <div *ngIf="dependentChangeFormInternal.get('spouseDependent.dependentEndReason')?.value === 'death'">
                        <div class="form-section-title">死亡した日</div>
                        <div formGroupName="deathDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era" required>
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year" required>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" required min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" required min="1" max="31">
                          </mat-form-field>
                        </div>
                      </div>

                      <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.dependentEndReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="dependentEndReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 異動種別「変更」の場合 -->
                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.changeType')?.value === 'change'">
                      <h4>変更前の情報</h4>
                      <!-- 変更前の情報は上記の該当・非該当のフィールドを使用 -->
                      <!-- 変更後の情報を下に追加 -->
                      <h4>変更後の情報</h4>
                      <div formGroupName="changeAfter">
                        <!-- 変更後：被扶養者になった日 -->
                        <div class="form-section-title">被扶養者になった日</div>
                        <div formGroupName="dependentStartDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era">
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" min="1" max="31">
                          </mat-form-field>
                        </div>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>被扶養者になった理由</mat-label>
                          <mat-select formControlName="dependentStartReason">
                            <mat-option *ngFor="let reason of dependentStartReasonOptions" [value]="reason.value">
                              {{ reason.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.changeAfter.dependentStartReason')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>被扶養者になった理由（その他）</mat-label>
                          <textarea matInput formControlName="dependentStartReasonOther" rows="2"></textarea>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>職業</mat-label>
                          <mat-select formControlName="occupation">
                            <mat-option *ngFor="let occ of occupationOptions" [value]="occ.value">
                              {{ occ.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.changeAfter.occupation')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>職業（その他）</mat-label>
                          <textarea matInput formControlName="occupationOther" rows="2"></textarea>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>収入（年収）</mat-label>
                          <input matInput type="number" formControlName="income">
                        </mat-form-field>

                        <!-- 変更後：被扶養者でなくなった日 -->
                        <div class="form-section-title">被扶養者でなくなった日</div>
                        <div formGroupName="dependentEndDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era">
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" min="1" max="31">
                          </mat-form-field>
                        </div>

                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>理由</mat-label>
                          <mat-select formControlName="dependentEndReason">
                            <mat-option *ngFor="let reason of dependentEndReasonOptions" [value]="reason.value">
                              {{ reason.label }}
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.changeAfter.dependentEndReason')?.value === 'other'" 
                                        appearance="outline" class="full-width">
                          <mat-label>理由（その他）</mat-label>
                          <textarea matInput formControlName="dependentEndReasonOther" rows="2"></textarea>
                        </mat-form-field>

                        <!-- 変更後：死亡の場合の日付 -->
                        <div *ngIf="dependentChangeFormInternal.get('spouseDependent.changeAfter.dependentEndReason')?.value === 'death'">
                          <div class="form-section-title">死亡した日</div>
                          <div formGroupName="deathDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era">
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" min="1" max="31">
                            </mat-form-field>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 備考 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>備考</mat-label>
                      <textarea matInput formControlName="remarks" rows="3"></textarea>
                    </mat-form-field>

                    <!-- 海外特例要件 -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>海外特例要件</mat-label>
                      <mat-select formControlName="overseasException">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option value="applicable">該当</mat-option>
                        <mat-option value="not_applicable">非該当</mat-option>
                      </mat-select>
                    </mat-form-field>

                    <!-- 海外特例要件「該当」の場合 -->
                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.overseasException')?.value === 'applicable'">
                      <div class="form-section-title">海外特例要件に該当した日</div>
                      <div formGroupName="overseasExceptionStartDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="overseasExceptionStartReason" required>
                          <mat-option *ngFor="let reason of overseasExceptionReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.overseasExceptionStartReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="overseasExceptionStartReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 海外特例要件「非該当」の場合 -->
                    <div *ngIf="dependentChangeFormInternal.get('spouseDependent.overseasException')?.value === 'not_applicable'">
                      <div class="form-section-title">海外特例要件に非該当となった日</div>
                      <div formGroupName="overseasExceptionEndDate" class="date-input-group">
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年号</mat-label>
                          <mat-select formControlName="era" required>
                            <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>年</mat-label>
                          <input matInput type="number" formControlName="year" required>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>月</mat-label>
                          <input matInput type="number" formControlName="month" required min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="form-field-small">
                          <mat-label>日</mat-label>
                          <input matInput type="number" formControlName="day" required min="1" max="31">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>理由</mat-label>
                        <mat-select formControlName="overseasExceptionEndReason" required>
                          <mat-option *ngFor="let reason of overseasExceptionEndReasonOptions" [value]="reason.value">
                            {{ reason.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <!-- 国内転入の場合の日付 -->
                      <div *ngIf="dependentChangeFormInternal.get('spouseDependent.overseasExceptionEndReason')?.value === 'domestic_transfer'">
                        <div class="form-section-title">国内転入日</div>
                        <div formGroupName="domesticTransferDate" class="date-input-group">
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年号</mat-label>
                            <mat-select formControlName="era" required>
                              <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>年</mat-label>
                            <input matInput type="number" formControlName="year" required>
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>月</mat-label>
                            <input matInput type="number" formControlName="month" required min="1" max="12">
                          </mat-form-field>
                          <mat-form-field appearance="outline" class="form-field-small">
                            <mat-label>日</mat-label>
                            <input matInput type="number" formControlName="day" required min="1" max="31">
                          </mat-form-field>
                        </div>
                      </div>

                      <mat-form-field *ngIf="dependentChangeFormInternal.get('spouseDependent.overseasExceptionEndReason')?.value === 'other'" 
                                      appearance="outline" class="full-width">
                        <mat-label>理由（その他）</mat-label>
                        <textarea matInput formControlName="overseasExceptionEndReasonOther" rows="2" required></textarea>
                      </mat-form-field>
                    </div>

                    <!-- 資格確認書発行要否 -->
                    <mat-checkbox formControlName="certificateRequired">
                      資格確認書発行要否
                    </mat-checkbox>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- その他の被扶養者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>その他の被扶養者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="otherDependents" *ngIf="otherDependentsFormArray">
                    <div *ngFor="let dependentControl of (otherDependentsFormArray?.controls || []); let i = index" 
                         [formGroupName]="i" class="dependent-item">
                      <mat-card class="nested-card">
                        <mat-card-header>
                          <mat-card-title>被扶養者 {{ i + 1 }}</mat-card-title>
                          <button mat-icon-button type="button" (click)="removeOtherDependent(i)" 
                                  *ngIf="otherDependentsFormArray && otherDependentsFormArray.length > 1" class="delete-button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 氏名 -->
                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏</mat-label>
                              <input matInput formControlName="lastName" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名</mat-label>
                              <input matInput formControlName="firstName" required>
                            </mat-form-field>
                          </div>

                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>氏（カナ）</mat-label>
                              <input matInput formControlName="lastNameKana" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>名（カナ）</mat-label>
                              <input matInput formControlName="firstNameKana" required>
                            </mat-form-field>
                          </div>

                          <!-- 生年月日 -->
                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>

                          <!-- 性別 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>性別</mat-label>
                            <mat-select formControlName="gender" required>
                              <mat-option value="male">男</mat-option>
                              <mat-option value="female">女</mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 続柄 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>続柄</mat-label>
                            <mat-select formControlName="relationship" required>
                              <mat-option *ngFor="let rel of otherDependentRelationshipOptions" [value]="rel.value">
                                {{ rel.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('relationship')?.value === 'other'" 
                                          appearance="outline" class="full-width">
                            <mat-label>続柄（その他）</mat-label>
                            <textarea matInput formControlName="relationshipOther" rows="2" required></textarea>
                          </mat-form-field>

                          <!-- 個人番号 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>個人番号</mat-label>
                            <input matInput formControlName="personalNumber">
                          </mat-form-field>

                          <!-- 住所 -->
                          <div class="form-section-title">住所</div>
                          <div formGroupName="address">
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>住所</mat-label>
                              <textarea matInput formControlName="address" rows="2"></textarea>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>同居・別居</mat-label>
                              <mat-select formControlName="livingTogether">
                                <mat-option value="living_together">同居</mat-option>
                                <mat-option value="separate">別居</mat-option>
                              </mat-select>
                            </mat-form-field>
                          </div>

                          <!-- 海外特例要件 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>海外特例要件</mat-label>
                            <mat-select formControlName="overseasException">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option value="applicable">該当</mat-option>
                              <mat-option value="not_applicable">非該当</mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 海外特例要件「該当」の場合 -->
                          <div *ngIf="getOtherDependentFormGroup(i).get('overseasException')?.value === 'applicable'">
                            <div class="form-section-title">海外特例要件に該当した日</div>
                            <div formGroupName="overseasExceptionStartDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="overseasExceptionStartReason" required>
                                <mat-option *ngFor="let reason of overseasExceptionReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('overseasExceptionStartReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="overseasExceptionStartReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 海外特例要件「非該当」の場合 -->
                          <div *ngIf="getOtherDependentFormGroup(i).get('overseasException')?.value === 'not_applicable'">
                            <div class="form-section-title">海外特例要件に非該当となった日</div>
                            <div formGroupName="overseasExceptionEndDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="overseasExceptionEndReason" required>
                                <mat-option *ngFor="let reason of overseasExceptionEndReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 国内転入の場合の日付 -->
                            <div *ngIf="getOtherDependentFormGroup(i).get('overseasExceptionEndReason')?.value === 'domestic_transfer'">
                              <div class="form-section-title">国内転入日</div>
                              <div formGroupName="domesticTransferDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era" required>
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year" required>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" required min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" required min="1" max="31">
                                </mat-form-field>
                              </div>
                            </div>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('overseasExceptionEndReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="overseasExceptionEndReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>異動種別</mat-label>
                            <mat-select formControlName="changeType" required>
                              <mat-option *ngFor="let type of changeTypeOptions" [value]="type.value">
                                {{ type.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- 異動種別「該当」の場合 -->
                          <div *ngIf="getOtherDependentFormGroup(i).get('changeType')?.value === 'applicable'">
                            <div class="form-section-title">被扶養者になった日</div>
                            <div formGroupName="dependentStartDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>職業</mat-label>
                              <mat-select formControlName="occupation" required>
                                <mat-option *ngFor="let occ of otherDependentOccupationOptions" [value]="occ.value">
                                  {{ occ.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 高・大学生の場合の学年 -->
                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('occupation')?.value === 'student_high_school' || getOtherDependentFormGroup(i).get('occupation')?.value === 'student_university'" 
                                            appearance="outline" class="full-width">
                              <mat-label>学年</mat-label>
                              <input matInput formControlName="studentYear" required placeholder="例：1年生">
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('occupation')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>職業（その他）</mat-label>
                              <textarea matInput formControlName="occupationOther" rows="2" required></textarea>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>収入（年収）</mat-label>
                              <input matInput type="number" formControlName="income" required>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>被扶養者になった理由 </mat-label>
                              <mat-select formControlName="dependentStartReason" required>
                                <mat-option *ngFor="let reason of otherDependentStartReasonOptions" [value]="reason.value">
                                  {{ reason.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('dependentStartReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>被扶養者になった理由（その他）</mat-label>
                              <textarea matInput formControlName="dependentStartReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別「非該当」の場合 -->
                          <div *ngIf="getOtherDependentFormGroup(i).get('changeType')?.value === 'not_applicable'">
                            <div class="form-section-title">被扶養者でなくなった日</div>
                            <div formGroupName="dependentEndDate" class="date-input-group">
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年号</mat-label>
                                <mat-select formControlName="era" required>
                                  <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>年</mat-label>
                                <input matInput type="number" formControlName="year" required>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>月</mat-label>
                                <input matInput type="number" formControlName="month" required min="1" max="12">
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field-small">
                                <mat-label>日</mat-label>
                                <input matInput type="number" formControlName="day" required min="1" max="31">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>理由</mat-label>
                              <mat-select formControlName="dependentEndReason" required>
                                <mat-option value="death">死亡</mat-option>
                                <mat-option value="employment">就職</mat-option>
                                <mat-option value="income_increase">収入増加</mat-option>
                                <mat-option value="over75">75歳到達</mat-option>
                                <mat-option value="disability">障害認定</mat-option>
                                <mat-option value="other">その他</mat-option>
                              </mat-select>
                            </mat-form-field>

                            <!-- 死亡の場合の日付 -->
                            <div *ngIf="getOtherDependentFormGroup(i).get('dependentEndReason')?.value === 'death'">
                              <div class="form-section-title">死亡した日</div>
                              <div formGroupName="deathDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era" required>
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year" required>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" required min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" required min="1" max="31">
                                </mat-form-field>
                              </div>
                            </div>

                            <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('dependentEndReason')?.value === 'other'" 
                                            appearance="outline" class="full-width">
                              <mat-label>理由（その他）</mat-label>
                              <textarea matInput formControlName="dependentEndReasonOther" rows="2" required></textarea>
                            </mat-form-field>
                          </div>

                          <!-- 異動種別「変更」の場合 -->
                          <div *ngIf="getOtherDependentFormGroup(i).get('changeType')?.value === 'change'">
                            <h4>変更前の情報</h4>
                            <!-- 変更前の情報は上記の該当・非該当のフィールドを使用 -->
                            <!-- 変更後の情報を下に追加 -->
                            <h4>変更後の情報</h4>
                            <div formGroupName="changeAfter">
                              <!-- 変更後：被扶養者になった日 -->
                              <div class="form-section-title">被扶養者になった日</div>
                              <div formGroupName="dependentStartDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era">
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" min="1" max="31">
                                </mat-form-field>
                              </div>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>職業</mat-label>
                                <mat-select formControlName="occupation">
                                  <mat-option *ngFor="let occ of otherDependentOccupationOptions" [value]="occ.value">
                                    {{ occ.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.occupation')?.value === 'student_high_school' || getOtherDependentFormGroup(i).get('changeAfter.occupation')?.value === 'student_university'" 
                                              appearance="outline" class="full-width">
                                <mat-label>学年</mat-label>
                                <input matInput formControlName="studentYear" placeholder="例：1年生">
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.occupation')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>職業（その他）</mat-label>
                                <textarea matInput formControlName="occupationOther" rows="2"></textarea>
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>収入（年収）</mat-label>
                                <input matInput type="number" formControlName="income">
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>被扶養者になった理由</mat-label>
                                <mat-select formControlName="dependentStartReason">
                                  <mat-option *ngFor="let reason of otherDependentStartReasonOptions" [value]="reason.value">
                                    {{ reason.label }}
                                  </mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentStartReason')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>被扶養者になった理由（その他）</mat-label>
                                <textarea matInput formControlName="dependentStartReasonOther" rows="2"></textarea>
                              </mat-form-field>

                              <!-- 変更後：被扶養者でなくなった日 -->
                              <div class="form-section-title">被扶養者でなくなった日</div>
                              <div formGroupName="dependentEndDate" class="date-input-group">
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年号</mat-label>
                                  <mat-select formControlName="era">
                                    <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                  </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>年</mat-label>
                                  <input matInput type="number" formControlName="year">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>月</mat-label>
                                  <input matInput type="number" formControlName="month" min="1" max="12">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field-small">
                                  <mat-label>日</mat-label>
                                  <input matInput type="number" formControlName="day" min="1" max="31">
                                </mat-form-field>
                              </div>

                              <mat-form-field appearance="outline" class="full-width">
                                <mat-label>理由</mat-label>
                                <mat-select formControlName="dependentEndReason">
                                  <mat-option value="death">死亡</mat-option>
                                  <mat-option value="employment">就職</mat-option>
                                  <mat-option value="income_increase">収入増加</mat-option>
                                  <mat-option value="over75">75歳到達</mat-option>
                                  <mat-option value="disability">障害認定</mat-option>
                                  <mat-option value="other">その他</mat-option>
                                </mat-select>
                              </mat-form-field>

                              <mat-form-field *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentEndReason')?.value === 'other'" 
                                              appearance="outline" class="full-width">
                                <mat-label>理由（その他）</mat-label>
                                <textarea matInput formControlName="dependentEndReasonOther" rows="2"></textarea>
                              </mat-form-field>

                              <!-- 変更後：死亡の場合の日付 -->
                              <div *ngIf="getOtherDependentFormGroup(i).get('changeAfter.dependentEndReason')?.value === 'death'">
                                <div class="form-section-title">死亡した日</div>
                                <div formGroupName="deathDate" class="date-input-group">
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>年号</mat-label>
                                    <mat-select formControlName="era">
                                      <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                                    </mat-select>
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>年</mat-label>
                                    <input matInput type="number" formControlName="year">
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>月</mat-label>
                                    <input matInput type="number" formControlName="month" min="1" max="12">
                                  </mat-form-field>
                                  <mat-form-field appearance="outline" class="form-field-small">
                                    <mat-label>日</mat-label>
                                    <input matInput type="number" formControlName="day" min="1" max="31">
                                  </mat-form-field>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- 備考 -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <textarea matInput formControlName="remarks" rows="3"></textarea>
                          </mat-form-field>

                          <!-- 資格確認書発行要否 -->
                          <mat-checkbox formControlName="certificateRequired">
                            資格確認書発行要否
                          </mat-checkbox>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addOtherDependent()" class="add-button">
                    <mat-icon>add</mat-icon>
                    その他の被扶養者を追加
                  </button>
                </mat-card-content>
              </mat-card>

              <!-- 扶養に関する申立書 -->
              <mat-card class="form-section" formGroupName="declaration">
                <mat-card-header>
                  <mat-card-title>扶養に関する申立書</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>記入欄</mat-label>
                    <textarea matInput formControlName="content" rows="5"></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>署名欄</mat-label>
                    <input matInput formControlName="signature" placeholder="申し立ての事実に相違ありません。　氏名　○○○○">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="dependentChangeFormInternal.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者報酬月額算定基礎届の詳細フォーム -->
          <form *ngIf="isRewardBaseForm && rewardBaseForm" [formGroup]="rewardBaseForm">
            <div class="step-content">
              <h3>被保険者報酬月額算定基礎届</h3>
              <p class="form-note">※ 給与支給月は4月、5月、6月です。基礎日数が17日以上の月のみ総計に含まれます。</p>

              <!-- 事業所情報 -->
              <mat-card class="form-section" formGroupName="businessInfo">
                <mat-card-header>
                  <mat-card-title>事業所情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 届け出る被保険者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>届け出る被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="insuredPersons">
                    <div *ngFor="let person of rewardBasePersonsFormArray?.controls; let i = index" 
                         [formGroupName]="i" class="insured-person-item">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>被保険者 {{ i + 1 }}</mat-card-title>
                          <button *ngIf="rewardBasePersonsFormArray && rewardBasePersonsFormArray.length > 1" 
                                  mat-icon-button (click)="removeRewardBasePerson(i)" type="button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                          <div *ngIf="getRewardBasePersonFormGroup(i).get('employeeId')?.value; else employeeSelectForRewardBaseTemplate">
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員</mat-label>
                              <input matInput [value]="getEmployeeDisplayNameById(getRewardBasePersonFormGroup(i).get('employeeId')?.value)" readonly>
                              <mat-hint>編集時は社員を変更できません。変更する場合は一度削除して新規追加してください。</mat-hint>
                            </mat-form-field>
                          </div>
                          <ng-template #employeeSelectForRewardBaseTemplate>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>社員を選択（情報を自動入力）</mat-label>
                              <mat-select (selectionChange)="onEmployeeSelectForRewardBase(i, $event.value)" [value]="null">
                                <mat-option value="">選択してください</mat-option>
                                <mat-option *ngFor="let employee of employees" [value]="employee.id">
                                  {{ getEmployeeDisplayName(employee) }}
                                </mat-option>
                              </mat-select>
                              <mat-hint>社員を選択すると、被保険者整理番号・氏名・生年月日・従前の標準報酬月額・従前改定月・適用年月・算定計算データが自動入力されます</mat-hint>
                            </mat-form-field>
                          </ng-template>

                          <mat-divider style="margin: 16px 0;"></mat-divider>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被保険者整理番号</mat-label>
                            <input matInput formControlName="insuranceNumber">
                          </mat-form-field>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被保険者氏名</mat-label>
                            <input matInput formControlName="name" required>
                          </mat-form-field>

                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>
                          <p class="form-hint">表示形式: {{ formatBirthDateForReward(getRewardBasePersonFormGroup(i).get('birthDate')) }}</p>

                          <div class="form-section-title">適用年月</div>
                          <div formGroupName="applicableDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">従前の標準報酬月額</div>
                          <div formGroupName="previousStandardReward" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>健康保険</mat-label>
                              <input matInput type="number" formControlName="healthInsurance">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>厚生年金</mat-label>
                              <input matInput type="number" formControlName="pensionInsurance">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">従前改定月</div>
                          <div formGroupName="previousChangeDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era">
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" min="1" max="12">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">昇(降)給</div>
                          <div formGroupName="salaryChange" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>月</mat-label>
                              <mat-select formControlName="month">
                                <mat-option value="april">4月</mat-option>
                                <mat-option value="may">5月</mat-option>
                                <mat-option value="june">6月</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>種類</mat-label>
                              <mat-select formControlName="type">
                                <mat-option *ngFor="let type of salaryChangeTypeOptions" [value]="type.value">
                                  {{ type.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">遡及支払額</div>
                          <div formArrayName="retroactivePayment">
                            <div *ngFor="let retroControl of getRewardBaseRetroactivePaymentArray(i).controls; let j = index" 
                                 [formGroupName]="j" class="form-row">
                              <mat-form-field appearance="outline" class="form-field">
                                <mat-label>月</mat-label>
                                <mat-select formControlName="month">
                                  <mat-option value="april">4月</mat-option>
                                  <mat-option value="may">5月</mat-option>
                                  <mat-option value="june">6月</mat-option>
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field">
                                <mat-label>金額</mat-label>
                                <input matInput type="number" formControlName="amount">
                              </mat-form-field>
                            </div>
                          </div>

                          <div class="form-section-title">給与支給月（4月、5月、6月）</div>
                          <div formArrayName="salaryMonths">
                            <div *ngFor="let monthControl of getRewardBaseSalaryMonthsArray(i).controls; let j = index" 
                                 [formGroupName]="j" class="salary-month-section">
                              <h4>{{ getSalaryMonthLabel(monthControl.get('month')?.value) }}</h4>
                              <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>基礎日数</mat-label>
                                  <input matInput type="number" formControlName="baseDays">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>通貨</mat-label>
                                  <input matInput type="number" formControlName="currency">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>現物</mat-label>
                                  <input matInput type="number" formControlName="inKind">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>合計</mat-label>
                                  <input matInput type="number" formControlName="total" readonly>
                                  <mat-hint>自動計算</mat-hint>
                                </mat-form-field>
                              </div>
                            </div>
                          </div>

                          <div class="form-section-title">計算結果</div>
                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>総計</mat-label>
                              <input matInput type="number" formControlName="total" readonly>
                              <mat-hint>基礎日数17日以上の月のみ</mat-hint>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>平均額</mat-label>
                              <input matInput type="number" formControlName="average" readonly>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>修正平均額</mat-label>
                              <input matInput type="number" formControlName="adjustedAverage" readonly>
                              <mat-hint>遡及支払額を考慮</mat-hint>
                            </mat-form-field>
                          </div>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <mat-select formControlName="remarks">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let remark of rewardBaseRemarksOptions" [value]="remark.value">
                                {{ remark.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <div *ngIf="isOver70RemarkSelected(i, 'base')" class="form-section">
                            <div class="form-section-title">個人番号または基礎年金番号</div>
                            <mat-radio-group formControlName="identificationType">
                              <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                              <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                            </mat-radio-group>

                            <mat-form-field *ngIf="getRewardBasePersonFormGroup(i).get('identificationType')?.value === 'personal_number'" 
                                            appearance="outline" class="full-width">
                              <mat-label>個人番号</mat-label>
                              <input matInput formControlName="personalNumber">
                            </mat-form-field>

                            <mat-form-field *ngIf="getRewardBasePersonFormGroup(i).get('identificationType')?.value === 'basic_pension_number'" 
                                            appearance="outline" class="full-width">
                              <mat-label>基礎年金番号</mat-label>
                              <input matInput formControlName="basicPensionNumber">
                            </mat-form-field>
                          </div>

                          <mat-form-field *ngIf="getRewardBasePersonFormGroup(i).get('remarks')?.value === 'other'" 
                                          appearance="outline" class="full-width">
                            <mat-label>備考（その他）</mat-label>
                            <textarea matInput formControlName="remarksOther" rows="2"></textarea>
                          </mat-form-field>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addRewardBasePerson()" class="add-button">
                    <mat-icon>add</mat-icon>
                    被保険者を追加
                  </button>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="rewardBaseForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者報酬月額変更届の詳細フォーム -->
          <form *ngIf="isRewardChangeForm && rewardChangeForm" [formGroup]="rewardChangeForm">
            <div class="step-content">
              <h3>被保険者報酬月額変更届</h3>
              <p class="form-note">※ 給与支給月は3か月分です。基礎日数が17日以上の月のみ総計に含まれます。</p>

              <!-- 事業所情報 -->
              <mat-card class="form-section" formGroupName="businessInfo">
                <mat-card-header>
                  <mat-card-title>事業所情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 届け出る被保険者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>届け出る被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="insuredPersons">
                    <div *ngFor="let person of rewardChangePersonsFormArray?.controls; let i = index" 
                         [formGroupName]="i" class="insured-person-item">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>被保険者 {{ i + 1 }}</mat-card-title>
                          <button *ngIf="rewardChangePersonsFormArray && rewardChangePersonsFormArray.length > 1" 
                                  mat-icon-button (click)="removeRewardChangePerson(i)" type="button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被保険者整理番号</mat-label>
                            <input matInput formControlName="insuranceNumber">
                          </mat-form-field>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被保険者氏名</mat-label>
                            <input matInput formControlName="name" required>
                          </mat-form-field>

                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>
                          <p class="form-hint">表示形式: {{ formatBirthDateForReward(getRewardChangePersonFormGroup(i).get('birthDate')) }}</p>

                          <div class="form-section-title">改定年月</div>
                          <div formGroupName="changeDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">従前の標準報酬月額</div>
                          <div formGroupName="previousStandardReward" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>健康保険</mat-label>
                              <input matInput type="number" formControlName="healthInsurance">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>厚生年金</mat-label>
                              <input matInput type="number" formControlName="pensionInsurance">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">従前改定月</div>
                          <div formGroupName="previousChangeDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era">
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" min="1" max="12">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">昇(降)給</div>
                          <div formGroupName="salaryChange" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>月</mat-label>
                              <mat-select formControlName="month">
                                <mat-option value="month1">1か月目</mat-option>
                                <mat-option value="month2">2か月目</mat-option>
                                <mat-option value="month3">3か月目</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>種類</mat-label>
                              <mat-select formControlName="type">
                                <mat-option *ngFor="let type of salaryChangeTypeOptions" [value]="type.value">
                                  {{ type.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">遡及支払額</div>
                          <div formArrayName="retroactivePayment">
                            <div *ngFor="let retroControl of getRewardChangeRetroactivePaymentArray(i).controls; let j = index" 
                                 [formGroupName]="j" class="form-row">
                              <mat-form-field appearance="outline" class="form-field">
                                <mat-label>月</mat-label>
                                <input matInput type="text" [value]="getSalaryMonthLabel(retroControl.get('month')?.value)" readonly>
                                <mat-hint>初月選択により自動設定されます</mat-hint>
                              </mat-form-field>
                              <mat-form-field appearance="outline" class="form-field">
                                <mat-label>金額</mat-label>
                                <input matInput type="number" formControlName="amount">
                              </mat-form-field>
                            </div>
                          </div>

                          <div class="form-section-title">給与支給月（3か月分）</div>
                          <div [formGroup]="getRewardChangePersonFormGroup(i)" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>初月</mat-label>
                              <mat-select formControlName="firstMonth">
                                <mat-option value="">選択してください</mat-option>
                                <mat-option *ngFor="let month of monthOptions" [value]="month.value">
                                  {{ month.label }}
                                </mat-option>
                              </mat-select>
                              <mat-hint>初月を選択すると、自動的に次の2か月が設定されます</mat-hint>
                            </mat-form-field>
                          </div>
                          <div formArrayName="salaryMonths">
                            <div *ngFor="let monthControl of getRewardChangeSalaryMonthsArray(i).controls; let j = index" 
                                 [formGroupName]="j" class="salary-month-section">
                              <h4>{{ getSalaryMonthLabel(monthControl.get('month')?.value) }}</h4>
                              <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>基礎日数</mat-label>
                                  <input matInput type="number" formControlName="baseDays">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>通貨</mat-label>
                                  <input matInput type="number" formControlName="currency">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>現物</mat-label>
                                  <input matInput type="number" formControlName="inKind">
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="form-field">
                                  <mat-label>合計</mat-label>
                                  <input matInput type="number" formControlName="total" readonly>
                                  <mat-hint>自動計算</mat-hint>
                                </mat-form-field>
                              </div>
                            </div>
                          </div>

                          <div class="form-section-title">計算結果</div>
                          <div class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>総計</mat-label>
                              <input matInput type="number" formControlName="total" readonly>
                              <mat-hint>基礎日数17日以上の月のみ</mat-hint>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>平均額</mat-label>
                              <input matInput type="number" formControlName="average" readonly>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>修正平均額</mat-label>
                              <input matInput type="number" formControlName="adjustedAverage" readonly>
                              <mat-hint>遡及支払額を考慮</mat-hint>
                            </mat-form-field>
                          </div>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <mat-select formControlName="remarks">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let remark of rewardChangeRemarksOptions" [value]="remark.value">
                                {{ remark.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field *ngIf="isOver70RemarkSelected(i, 'change')" 
                                          appearance="outline" class="full-width">
                            <mat-label>個人番号</mat-label>
                            <input matInput formControlName="personalNumber">
                          </mat-form-field>

                          <mat-form-field *ngIf="getRewardChangePersonFormGroup(i).get('remarks')?.value === 'other' || getRewardChangePersonFormGroup(i).get('remarks')?.value === 'salary_reason'" 
                                          appearance="outline" class="full-width">
                            <mat-label>備考（その他・理由）</mat-label>
                            <textarea matInput formControlName="remarksOther" rows="2"></textarea>
                          </mat-form-field>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addRewardChangePerson()" class="add-button">
                    <mat-icon>add</mat-icon>
                    被保険者を追加
                  </button>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="rewardChangeForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者賞与支払届の詳細フォーム -->
          <form *ngIf="isBonusPaymentForm && bonusPaymentForm" [formGroup]="bonusPaymentForm">
            <div class="step-content">
              <h3>被保険者賞与支払届</h3>

              <!-- 事業所情報 -->
              <mat-card class="form-section" formGroupName="businessInfo">
                <mat-card-header>
                  <mat-card-title>事業所情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所整理番号</mat-label>
                    <input matInput formControlName="officeSymbol">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所所在地</mat-label>
                    <textarea matInput formControlName="officeAddress" rows="2" required></textarea>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業所名称</mat-label>
                    <input matInput formControlName="officeName" required>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>事業主氏名</mat-label>
                    <input matInput formControlName="ownerName">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>電話番号</mat-label>
                    <input matInput formControlName="phoneNumber">
                  </mat-form-field>
                </mat-card-content>
              </mat-card>

              <!-- 賞与支払年月日（共通） -->
              <mat-card class="form-section" formGroupName="commonBonusPaymentDate">
                <mat-card-header>
                  <mat-card-title>賞与支払年月日（共通）</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- 被保険者情報 -->
              <mat-card class="form-section">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div formArrayName="insuredPersons">
                    <div *ngFor="let person of bonusPaymentPersonsFormArray?.controls; let i = index" 
                         [formGroupName]="i" class="insured-person-item">
                      <mat-card>
                        <mat-card-header>
                          <mat-card-title>被保険者 {{ i + 1 }}</mat-card-title>
                          <button *ngIf="bonusPaymentPersonsFormArray && bonusPaymentPersonsFormArray.length > 1" 
                                  mat-icon-button (click)="removeBonusPaymentPerson(i)" type="button">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </mat-card-header>
                        <mat-card-content>
                          <!-- 社員選択（既存の場合は固定表示、新規追加時のみ選択可能） -->
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>社員を選択（情報を自動入力）</mat-label>
                            <mat-select (selectionChange)="onEmployeeSelectForBonusPayment(i, $event.value)" [value]="null">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let employee of employees" [value]="employee.id">
                                {{ getEmployeeDisplayName(employee) }}
                              </mat-option>
                            </mat-select>
                            <mat-hint>社員を選択すると、被保険者整理番号・氏名・生年月日が自動入力されます</mat-hint>
                          </mat-form-field>

                          <mat-divider style="margin: 16px 0;"></mat-divider>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>被保険者整理番号</mat-label>
                            <input matInput formControlName="insuranceNumber">
                          </mat-form-field>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>氏名</mat-label>
                            <input matInput formControlName="name" required>
                          </mat-form-field>

                          <div class="form-section-title">生年月日</div>
                          <div formGroupName="birthDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era" required>
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year" required>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" required min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" required min="1" max="31">
                            </mat-form-field>
                          </div>
                          <p class="form-hint">表示形式: {{ formatBirthDateForReward(getBonusPaymentPersonFormGroup(i).get('birthDate')) }}</p>

                          <div class="form-section-title">賞与支払年月日</div>
                          <div formGroupName="bonusPaymentDate" class="date-input-group">
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年号</mat-label>
                              <mat-select formControlName="era">
                                <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                              </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>年</mat-label>
                              <input matInput type="number" formControlName="year">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>月</mat-label>
                              <input matInput type="number" formControlName="month" min="1" max="12">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field-small">
                              <mat-label>日</mat-label>
                              <input matInput type="number" formControlName="day" min="1" max="31">
                            </mat-form-field>
                          </div>

                          <div class="form-section-title">賞与支払額</div>
                          <div formGroupName="paymentAmount" class="form-row">
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>通貨</mat-label>
                              <input matInput type="number" formControlName="currency">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="form-field">
                              <mat-label>現物</mat-label>
                              <input matInput type="number" formControlName="inKind">
                            </mat-form-field>
                          </div>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>賞与額（千円未満切り捨て）</mat-label>
                            <input matInput type="number" formControlName="bonusAmount" readonly>
                            <mat-hint>自動計算</mat-hint>
                          </mat-form-field>

                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>備考</mat-label>
                            <mat-select formControlName="remarks">
                              <mat-option value="">選択してください</mat-option>
                              <mat-option *ngFor="let remark of bonusPaymentRemarksOptions" [value]="remark.value">
                                {{ remark.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <button mat-raised-button type="button" (click)="addBonusPaymentPerson()" class="add-button">
                    <mat-icon>add</mat-icon>
                    被保険者を追加
                  </button>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="bonusPaymentForm.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者住所変更届の詳細フォーム（内部申請用：事業所情報と届書提出日なし） -->
          <form *ngIf="isAddressChangeFormInternal && addressChangeFormInternal" [formGroup]="addressChangeFormInternal">
            <div class="step-content">
              <h3>被保険者住所変更届（内部申請）</h3>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 内部申請のため、ログインユーザーの情報が変更前部分に自動転記されています -->
                  <p class="form-note" style="margin-bottom: 16px;">※ 内部申請のため、ログインユーザー（あなた）の情報が変更前部分に自動転記されています。変更後部分は手入力してください。</p>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="addressChangeFormInternal.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="addressChangeFormInternal.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="lastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="firstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="lastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="firstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                    <mat-label>変更後郵便番号</mat-label>
                      <input matInput formControlName="newPostalCode" placeholder="例: 123-4567">
                  </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>都道府県</mat-label>
                      <input matInput formControlName="newPrefecture">
                  </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>市区町村</mat-label>
                      <input matInput formControlName="newCity">
                  </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>町名・番地</mat-label>
                      <input matInput formControlName="newStreet">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>建物名・部屋番号</mat-label>
                      <input matInput formControlName="newBuilding">
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>住所（カナ）</mat-label>
                      <input matInput formControlName="newAddressKana" placeholder="例: トウキョウトシブヤク">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>変更前住所</mat-label>
                    <textarea matInput formControlName="oldAddress" rows="2"></textarea>
                  </mat-form-field>

                  <div class="form-section-title">変更年月日</div>
                  <div formGroupName="changeDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>備考</mat-label>
                    <mat-select formControlName="remarks">
                      <mat-option value="">選択してください</mat-option>
                      <mat-option *ngFor="let remark of addressChangeRemarksOptions" [value]="remark.value">
                        {{ remark.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-checkbox formControlName="livingWithSpouse">
                    被保険者と配偶者は同居している
                  </mat-checkbox>

                  <!-- 配偶者情報（同居チェック時） -->
                  <div *ngIf="addressChangeFormInternal.get('insuredPerson.livingWithSpouse')?.value" class="spouse-section">
                    <div class="form-section-title">配偶者情報</div>
                    <div class="form-section-title">個人番号または基礎年金番号</div>
                    <mat-radio-group formControlName="spouseIdentificationType">
                      <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                      <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                    </mat-radio-group>

                    <mat-form-field *ngIf="addressChangeFormInternal.get('insuredPerson.spouseIdentificationType')?.value === 'personal_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>配偶者の個人番号</mat-label>
                      <input matInput formControlName="spousePersonalNumber">
                    </mat-form-field>

                    <mat-form-field *ngIf="addressChangeFormInternal.get('insuredPerson.spouseIdentificationType')?.value === 'basic_pension_number'" 
                                    appearance="outline" class="full-width">
                      <mat-label>配偶者の基礎年金番号</mat-label>
                      <input matInput formControlName="spouseBasicPensionNumber">
                    </mat-form-field>

                    <div class="form-section-title">配偶者の生年月日</div>
                    <div formGroupName="spouseBirthDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の氏</mat-label>
                        <input matInput formControlName="spouseLastName">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の名</mat-label>
                        <input matInput formControlName="spouseFirstName">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の氏（カナ）</mat-label>
                        <input matInput formControlName="spouseLastNameKana">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>配偶者の名（カナ）</mat-label>
                        <input matInput formControlName="spouseFirstNameKana">
                      </mat-form-field>
                    </div>
                  </div>

                  <!-- 配偶者情報（別居時） -->
                  <div *ngIf="!addressChangeFormInternal.get('insuredPerson.livingWithSpouse')?.value" class="spouse-section">
                    <div class="form-section-title">配偶者情報</div>
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                      <mat-label>配偶者の変更後郵便番号</mat-label>
                        <input matInput formControlName="spouseNewPostalCode" placeholder="例: 123-4567">
                    </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>都道府県</mat-label>
                        <input matInput formControlName="spouseNewPrefecture">
                    </mat-form-field>

                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>市区町村</mat-label>
                        <input matInput formControlName="spouseNewCity">
                    </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>町名・番地</mat-label>
                        <input matInput formControlName="spouseNewStreet">
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>建物名・部屋番号</mat-label>
                        <input matInput formControlName="spouseNewBuilding">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="form-field">
                        <mat-label>住所（カナ）</mat-label>
                        <input matInput formControlName="spouseNewAddressKana" placeholder="例: トウキョウトシブヤク">
                      </mat-form-field>
                    </div>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の変更前住所</mat-label>
                      <textarea matInput formControlName="spouseOldAddress" rows="2"></textarea>
                    </mat-form-field>
                    <div class="form-section-title">配偶者の変更年月日</div>
                    <div formGroupName="spouseChangeDate" class="date-input-group">
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年号</mat-label>
                        <mat-select formControlName="era">
                          <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>年</mat-label>
                        <input matInput type="number" formControlName="year">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>月</mat-label>
                        <input matInput type="number" formControlName="month" min="1" max="12">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="form-field-small">
                        <mat-label>日</mat-label>
                        <input matInput type="number" formControlName="day" min="1" max="31">
                      </mat-form-field>
                    </div>
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>配偶者の備考</mat-label>
                      <mat-select formControlName="spouseRemarks">
                        <mat-option value="">選択してください</mat-option>
                        <mat-option *ngFor="let remark of addressChangeRemarksOptions" [value]="remark.value">
                          {{ remark.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="addressChangeFormInternal.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 被保険者氏名変更（訂正）届の詳細フォーム（内部申請用：事業所情報と届書提出日なし） -->
          <form *ngIf="isNameChangeFormInternal && nameChangeFormInternal" [formGroup]="nameChangeFormInternal">
            <div class="step-content">
              <h3>被保険者氏名変更（訂正）届（内部申請）</h3>

              <!-- 被保険者情報 -->
              <mat-card class="form-section" formGroupName="insuredPerson">
                <mat-card-header>
                  <mat-card-title>被保険者情報</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 内部申請のため、ログインユーザーの情報が変更前部分に自動転記されています -->
                  <p class="form-note" style="margin-bottom: 16px;">※ 内部申請のため、ログインユーザー（あなた）の情報が変更前部分に自動転記されています。変更後部分は手入力してください。</p>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>被保険者整理番号</mat-label>
                    <input matInput formControlName="insuranceNumber">
                  </mat-form-field>

                  <div class="form-section-title">個人番号または基礎年金番号</div>
                  <mat-radio-group formControlName="identificationType" required>
                    <mat-radio-button value="personal_number">個人番号</mat-radio-button>
                    <mat-radio-button value="basic_pension_number">基礎年金番号</mat-radio-button>
                  </mat-radio-group>

                  <mat-form-field *ngIf="nameChangeFormInternal.get('insuredPerson.identificationType')?.value === 'personal_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>個人番号</mat-label>
                    <input matInput formControlName="personalNumber">
                  </mat-form-field>

                  <mat-form-field *ngIf="nameChangeFormInternal.get('insuredPerson.identificationType')?.value === 'basic_pension_number'" 
                                  appearance="outline" class="full-width">
                    <mat-label>基礎年金番号</mat-label>
                    <input matInput formControlName="basicPensionNumber">
                  </mat-form-field>

                  <div class="form-section-title">生年月日</div>
                  <div formGroupName="birthDate" class="date-input-group">
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年号</mat-label>
                      <mat-select formControlName="era" required>
                        <mat-option *ngFor="let era of eraOptions" [value]="era.value">{{ era.label }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>年</mat-label>
                      <input matInput type="number" formControlName="year" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>月</mat-label>
                      <input matInput type="number" formControlName="month" required min="1" max="12">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field-small">
                      <mat-label>日</mat-label>
                      <input matInput type="number" formControlName="day" required min="1" max="31">
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">被保険者の氏名（変更後）</div>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="newLastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="newFirstName" required>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏（カナ）</mat-label>
                      <input matInput formControlName="newLastNameKana" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名（カナ）</mat-label>
                      <input matInput formControlName="newFirstNameKana" required>
                    </mat-form-field>
                  </div>

                  <div class="form-section-title">変更前の氏名</div>
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>氏</mat-label>
                      <input matInput formControlName="oldLastName" required>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>名</mat-label>
                      <input matInput formControlName="oldFirstName" required>
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>備考</mat-label>
                    <textarea matInput formControlName="remarks" rows="3"></textarea>
                  </mat-form-field>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="step-actions">
              <button mat-button (click)="cancelEdit()">キャンセル</button>
              <button mat-raised-button color="primary" (click)="stepper.next()" 
                      [disabled]="nameChangeFormInternal.invalid">
                次へ
              </button>
            </div>
          </form>

          <!-- 通常の申請フォーム -->
          <form *ngIf="!isInsuranceAcquisitionForm && !isInsuranceLossForm && !isDependentChangeForm && !isAddressChangeForm && !isNameChangeForm && !isRewardBaseForm && !isRewardChangeForm && !isBonusPaymentForm && !isDependentChangeFormInternal && !isAddressChangeFormInternal && !isNameChangeFormInternal" [formGroup]="applicationDataForm">
            <div class="step-content">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>申請内容・備考</mat-label>
                <textarea matInput formControlName="description" rows="5"></textarea>
              </mat-form-field>
            </div>

            <div class="step-actions">
              <button mat-button (click)="stepper.previous()">戻る</button>
              <button mat-raised-button color="primary" (click)="stepper.next()">
                次へ
              </button>
            </div>
          </form>
        </mat-step>

        <!-- ステップ3: 添付ファイル -->
        <mat-step>
          <ng-template matStepLabel>添付ファイル</ng-template>
          <div class="step-content">
            <!-- 既存の添付ファイル -->
            <div class="existing-files-section" *ngIf="existingAttachments.length > 0">
              <h3>既存の添付ファイル</h3>
              <mat-list>
                <mat-list-item *ngFor="let attachment of existingAttachments; let i = index">
                  <mat-icon matListItemIcon>attach_file</mat-icon>
                  <span matListItemTitle [class.deleted-file]="isExistingFileDeleted(i)">
                    {{ attachment.fileName }}
                  </span>
                  <span matListItemLine>アップロード日: {{ formatDate(attachment.uploadedAt) }}</span>
                  <a mat-button [href]="attachment.fileUrl" target="_blank" matListItemMeta *ngIf="!isExistingFileDeleted(i)">
                    <mat-icon>open_in_new</mat-icon>
                    開く
                  </a>
                  <button mat-icon-button (click)="removeExistingFile(i)" matListItemMeta *ngIf="!isExistingFileDeleted(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                  <button mat-icon-button (click)="cancelDeleteExistingFile(i)" matListItemMeta *ngIf="isExistingFileDeleted(i)">
                    <mat-icon>undo</mat-icon>
                  </button>
                </mat-list-item>
              </mat-list>
            </div>

            <!-- 新規ファイルの追加 -->
            <div class="file-upload-section">
              <h3>新規ファイルを追加</h3>
              <input type="file" #fileInput multiple (change)="onFileSelected($event)" style="display: none;">
              <button mat-raised-button (click)="fileInput.click()">
                <mat-icon>attach_file</mat-icon>
                ファイルを選択
              </button>
            </div>

            <div class="file-list" *ngIf="attachments.length > 0">
              <mat-list>
                <mat-list-item *ngFor="let file of attachments; let i = index">
                  <mat-icon matListItemIcon>description</mat-icon>
                  <span matListItemTitle>{{ file.name }}</span>
                  <span matListItemLine>{{ (file.size / 1024).toFixed(2) }} KB</span>
                  <button mat-icon-button (click)="removeFile(i)" matListItemMeta>
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-list-item>
              </mat-list>
            </div>

            <p *ngIf="existingAttachments.length === 0 && attachments.length === 0" class="no-files">添付ファイルはありません</p>
          </div>

          <div class="step-actions">
            <button mat-button (click)="stepper.previous()">戻る</button>
            <button mat-raised-button color="primary" (click)="stepper.next()">
              次へ
            </button>
          </div>
        </mat-step>

        <!-- ステップ4: 内容確認 -->
        <mat-step>
          <ng-template matStepLabel>内容確認</ng-template>
          <div class="step-content">
            <h3>申請内容の確認</h3>
            <p class="confirmation-note">以下の内容を確認してください。問題がなければ「申請を更新」ボタンをクリックしてください。</p>

            <div class="application-data-section" *ngIf="getFormattedApplicationData().length > 0">
              <div *ngFor="let section of getFormattedApplicationData()" class="data-section">
                <mat-card class="section-card">
                  <mat-card-header>
                    <mat-card-title>{{ section.title }}</mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <mat-list>
                      <mat-list-item *ngFor="let item of section.items">
                        <span matListItemTitle>{{ item.label }}</span>
                        <span matListItemLine [class.empty-value]="item.isEmpty">
                          {{ item.isEmpty ? '(未入力)' : item.value }}
                        </span>
                      </mat-list-item>
                    </mat-list>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>

            <!-- 添付ファイルの確認 -->
            <div class="attachments-section" *ngIf="(existingAttachments.length > 0 && deletedAttachmentIndices.length < existingAttachments.length) || attachments.length > 0">
              <mat-card>
                <mat-card-header>
                  <mat-card-title>添付ファイル</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <!-- 既存ファイル（削除されていないもの） -->
                  <mat-list *ngIf="existingAttachments.length > 0 && deletedAttachmentIndices.length < existingAttachments.length">
                    <mat-list-item *ngFor="let attachment of existingAttachments; let i = index">
                      <mat-icon matListItemIcon *ngIf="!isExistingFileDeleted(i)">attach_file</mat-icon>
                      <span matListItemTitle *ngIf="!isExistingFileDeleted(i)">{{ attachment.fileName }}</span>
                      <span matListItemLine *ngIf="!isExistingFileDeleted(i)">アップロード日: {{ formatDate(attachment.uploadedAt) }}</span>
                      <a mat-button *ngIf="!isExistingFileDeleted(i)" [href]="attachment.fileUrl" target="_blank" rel="noopener noreferrer" matListItemMeta>
                        <mat-icon>open_in_new</mat-icon>
                        開く
                      </a>
                    </mat-list-item>
                  </mat-list>
                  <!-- 新規ファイル -->
                  <mat-list *ngIf="attachments.length > 0">
                    <mat-list-item *ngFor="let file of attachments">
                      <mat-icon matListItemIcon>description</mat-icon>
                      <span matListItemTitle>{{ file.name }}</span>
                      <span matListItemLine>{{ (file.size / 1024).toFixed(2) }} KB</span>
                      <a mat-button [href]="getFilePreviewUrl(file)" target="_blank" rel="noopener noreferrer" matListItemMeta>
                        <mat-icon>open_in_new</mat-icon>
                        開く
                      </a>
                    </mat-list-item>
                  </mat-list>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button (click)="stepper.previous()">戻る</button>
            <button mat-button (click)="stepper.selectedIndex = 0">編集</button>
            <button mat-button (click)="updateApplication('draft')" [disabled]="isLoading">
              <mat-icon *ngIf="!isLoading">drafts</mat-icon>
              <span *ngIf="isLoading">更新中...</span>
              <span *ngIf="!isLoading">下書きを更新</span>
            </button>
            <button mat-raised-button color="primary" (click)="updateApplication('created')" [disabled]="isLoading">
              <mat-icon *ngIf="!isLoading">save</mat-icon>
              <span *ngIf="isLoading">更新中...</span>
              <span *ngIf="!isLoading">申請を更新</span>
            </button>
          </div>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
  </mat-card>
</div>


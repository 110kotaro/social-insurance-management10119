<div class="notification-list-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>notifications</mat-icon>
        通知一覧
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- 検索・フィルタ -->
      <form [formGroup]="searchForm" class="search-form">
        <div class="search-row">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>既読状態</mat-label>
            <mat-select formControlName="readStatus">
              <mat-option value="all">すべて</mat-option>
              <mat-option value="unread">未読のみ</mat-option>
              <mat-option value="read">既読のみ</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>通知タイプ</mat-label>
            <mat-select formControlName="type">
              <mat-option value="">すべて</mat-option>
              <mat-option value="application">申請</mat-option>
              <mat-option value="approval">承認</mat-option>
              <mat-option value="rejection">却下</mat-option>
              <mat-option value="return">差戻し</mat-option>
              <mat-option value="reminder">リマインダー</mat-option>
              <mat-option value="system">システム</mat-option>
              <mat-option value="external_received">外部受理</mat-option>
              <mat-option value="external_error">外部エラー</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>キーワード検索</mat-label>
            <input matInput formControlName="keyword" placeholder="タイトル、メッセージ、申請種別で検索">
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <button mat-button type="button" (click)="resetFilters()" class="reset-button">
            <mat-icon>refresh</mat-icon>
            リセット
          </button>
        </div>
      </form>

      <!-- アクションボタン -->
      <div class="action-buttons">
        <button mat-raised-button color="primary" (click)="markAllAsRead()" [disabled]="unreadGroupCount === 0">
          <mat-icon>done_all</mat-icon>
          すべて既読にする
        </button>
      </div>

      <!-- 件数表示 -->
      <div class="count-info">
        表示: {{ dataSource.data.length }}件 / 全{{ filteredGroups.length }}件
        <span *ngIf="unreadGroupCount > 0" class="unread-count">
          （未読: {{ unreadGroupCount }}件）
        </span>
      </div>

      <!-- 通知グループテーブル -->
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="notification-table">
          <!-- 既読状態列 -->
          <ng-container matColumnDef="read">
            <th mat-header-cell *matHeaderCellDef>状態</th>
            <td mat-cell *matCellDef="let group">
              <mat-icon [class.unread-icon]="group.unreadCount > 0" [class.read-icon]="group.unreadCount === 0">
                {{ group.unreadCount > 0 ? 'mail' : 'drafts' }}
              </mat-icon>
            </td>
          </ng-container>

          <!-- 申請名列 -->
          <ng-container matColumnDef="application">
            <th mat-header-cell *matHeaderCellDef>申請名</th>
            <td mat-cell *matCellDef="let group">
              <span *ngIf="group.applicationId" 
                    class="application-link" 
                    (click)="navigateToApplication(group.applicationId)"
                    matTooltip="申請詳細を表示">
                {{ getApplicationTypeName(group.applicationId, group) }}
              </span>
              <span *ngIf="!group.applicationId" class="no-application">
                {{ getApplicationTypeName(null, group) }}
              </span>
            </td>
          </ng-container>

          <!-- 社員名列 -->
          <ng-container matColumnDef="employee">
            <th mat-header-cell *matHeaderCellDef>社員名</th>
            <td mat-cell *matCellDef="let group">
              {{ group.employeeName || '不明' }}
            </td>
          </ng-container>

          <!-- 通知件数列 -->
          <ng-container matColumnDef="notificationCount">
            <th mat-header-cell *matHeaderCellDef>通知件数</th>
            <td mat-cell *matCellDef="let group">
              <span class="notification-count-link" 
                    (click)="navigateToNotificationDetail(group)"
                    [class.unread]="group.unreadCount > 0"
                    matTooltip="通知詳細を表示">
                {{ group.notifications.length }}件
                <span *ngIf="group.unreadCount > 0" class="unread-badge">
                  （未読: {{ group.unreadCount }}件）
                </span>
              </span>
            </td>
          </ng-container>

          <!-- 優先度列 -->
          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>優先度</th>
            <td mat-cell *matCellDef="let group">
              <div *ngIf="group.highestPriorityNotification" class="priority-display">
                <mat-icon [color]="getPriorityColor(group.highestPriorityNotification.priority)">
                  {{ getTypeIcon(group.highestPriorityNotification.type) }}
                </mat-icon>
                <mat-chip [color]="getPriorityColor(group.highestPriorityNotification.priority)" 
                          *ngIf="group.highestPriorityNotification.priority === 'high'">
                  高
                </mat-chip>
                <span class="priority-label">
                  {{ getTypeLabel(group.highestPriorityNotification.type) }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- 最新日時列 -->
          <ng-container matColumnDef="latestDate">
            <th mat-header-cell *matHeaderCellDef>最新通知日時</th>
            <td mat-cell *matCellDef="let group">
              {{ formatDate(group.latestNotification.createdAt) }}
            </td>
          </ng-container>

          <!-- アクション列 -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>操作</th>
            <td mat-cell *matCellDef="let group">
              <button mat-icon-button 
                      *ngIf="group.unreadCount > 0" 
                      (click)="markGroupAsRead(group)"
                      matTooltip="この通知グループの通知をすべて既読にする">
                <mat-icon>done_all</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" 
              [class.unread-row]="row.unreadCount > 0"
              [class.read-row]="row.unreadCount === 0"></tr>
        </table>

        <!-- 通知がない場合 -->
        <div *ngIf="dataSource.data.length === 0" class="no-notifications">
          <mat-icon>notifications_none</mat-icon>
          <p>通知がありません</p>
        </div>
      </div>

      <!-- ページネーション -->
      <mat-paginator
        [length]="filteredGroups.length"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)">
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>

<div class="employee-export-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>download</mat-icon>
        データエクスポート
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- フィルタセクション -->
      <div class="filter-section">
        <h3>フィルタ条件</h3>
        <form [formGroup]="filterForm" class="filter-form">
          <mat-form-field>
            <mat-label>キーワード検索</mat-label>
            <input matInput formControlName="keyword" placeholder="社員番号、氏名、メールアドレス">
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <mat-form-field>
            <mat-label>部署</mat-label>
            <mat-select formControlName="departmentId">
              <mat-option value="">すべて</mat-option>
              <mat-option *ngFor="let dept of departments" [value]="dept.id">
                {{ dept.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field>
            <mat-label>ステータス</mat-label>
            <mat-select formControlName="status">
              <mat-option value="">すべて</mat-option>
              <mat-option value="active">在籍</mat-option>
              <mat-option value="leave">休職</mat-option>
              <mat-option value="retired">退職</mat-option>
              <mat-option value="pre_join">未入社</mat-option>
            </mat-select>
          </mat-form-field>
        </form>
      </div>

      <!-- データ種別選択 -->
      <div class="data-type-section">
        <h3>エクスポートするデータ種別</h3>
        <div class="data-type-options">
          <mat-checkbox 
            *ngFor="let option of dataTypeOptions"
            [(ngModel)]="option.selected"
            [ngModelOptions]="{standalone: true}">
            {{ option.label }}
          </mat-checkbox>
        </div>
        
        <!-- 保険料・給与情報用の年月選択 -->
        <div *ngIf="hasPremiumOrSalarySelected()" class="year-month-selection">
          <h4>保険料・給与情報の対象年月</h4>
          <div class="year-month-fields">
            <mat-form-field>
              <mat-label>年</mat-label>
              <mat-select [(ngModel)]="selectedYear" [ngModelOptions]="{standalone: true}">
                <mat-option *ngFor="let year of years" [value]="year">{{ year }}年</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field>
              <mat-label>月</mat-label>
              <mat-select [(ngModel)]="selectedMonth" [ngModelOptions]="{standalone: true}">
                <mat-option *ngFor="let month of months" [value]="month">{{ month }}月</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- 社員選択セクション -->
      <div class="selection-section">
        <div class="selection-header">
          <h3>社員選択 ({{ filteredEmployees.length }}件中 {{ selectedEmployeeIds.size }}件選択)</h3>
          <div class="selection-actions">
            <button mat-button (click)="toggleAllSelection()">
              {{ allSelected ? 'すべて解除' : 'すべて選択' }}
            </button>
          </div>
        </div>

        <div class="table-container" *ngIf="!isLoading">
          <table mat-table [dataSource]="dataSource" class="export-table">
            <!-- 選択チェックボックス -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                  [checked]="allSelected"
                  [indeterminate]="someSelected"
                  (change)="toggleAllSelection()">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let emp">
                <mat-checkbox
                  [checked]="isSelected(emp)"
                  (change)="toggleSelection(emp)">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- 社員番号 -->
            <ng-container matColumnDef="employeeNumber">
              <th mat-header-cell *matHeaderCellDef>社員番号</th>
              <td mat-cell *matCellDef="let emp">{{ emp.employeeNumber }}</td>
            </ng-container>

            <!-- 氏名 -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>氏名</th>
              <td mat-cell *matCellDef="let emp">{{ getName(emp) }}</td>
            </ng-container>

            <!-- 部署 -->
            <ng-container matColumnDef="department">
              <th mat-header-cell *matHeaderCellDef>部署</th>
              <td mat-cell *matCellDef="let emp">{{ getDepartmentName(emp.departmentId) }}</td>
            </ng-container>

            <!-- ステータス -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>ステータス</th>
              <td mat-cell *matCellDef="let emp">
                <mat-chip>{{ getStatusLabel(emp.status) }}</mat-chip>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <div *ngIf="isLoading" class="loading-container">
          <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          <p>読み込み中...</p>
        </div>
      </div>

      <!-- 出力形式選択 -->
      <div class="export-format-section">
        <h3>出力形式</h3>
        <mat-form-field>
          <mat-label>出力形式</mat-label>
          <mat-select [(ngModel)]="exportFormat" [ngModelOptions]="{standalone: true}">
            <mat-option value="excel">Excel形式（.xlsx）</mat-option>
            <mat-option value="csv">CSV形式（.csv）</mat-option>
          </mat-select>
        </mat-form-field>
        <p class="format-note" *ngIf="exportFormat === 'csv'">
          CSV形式の場合、データ種別ごとに個別のファイルが出力されます。
        </p>
      </div>

      <!-- アクションボタン -->
      <div class="action-buttons">
        <button 
          mat-raised-button 
          color="primary" 
          (click)="exportData()"
          [disabled]="isLoading || selectedEmployeeIds.size === 0">
          <mat-icon>download</mat-icon>
          {{ exportFormat === 'excel' ? 'Excel形式でエクスポート' : 'CSV形式でエクスポート' }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>
